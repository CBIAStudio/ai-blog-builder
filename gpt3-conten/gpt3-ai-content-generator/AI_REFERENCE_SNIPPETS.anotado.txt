================================================================================
FUNCION: get_strategy
Resumen: Función que maneja $human.
CODIGO:
function get_strategy(string $provider): ProviderStrategyInterface|WP_Error {
        if (isset(self::$instances[$provider])) {
            return self::$instances[$provider];
        }

        $strategy_path_base = __DIR__ . '/'; // This will be classes/core/providers/
        $strategies_to_load = [
            'OpenAI'     => 'openai/bootstrap-provider-strategy.php',
            'OpenRouter' => 'openrouter/bootstrap-provider-strategy.php',
            'Google'     => 'google/bootstrap-provider-strategy.php', // MODIFIED PATH
            'Azure'      => 'azure/bootstrap-provider-strategy.php',
            'DeepSeek'   => 'deepseek-provider-strategy.php',
            'Ollama'     => 'ollama/bootstrap-provider-strategy.php',
        ];

        // Ensure the Interface and Base Class are loaded before any specific strategy.
        // This is also handled by ProviderDependenciesLoader, but as a safeguard:
        if (!interface_exists(ProviderStrategyInterface::class)) {
            $interface_path = $strategy_path_base . 'interface-provider-strategy.php';
            if (file_exists($interface_path)) require_once $interface_path;
            else return new WP_Error('strategy_interface_missing', 'ProviderStrategyInterface is missing.');
        }
        if (!class_exists(BaseProviderStrategy::class)) {
            $base_class_path = $strategy_path_base . 'base-provider-strategy.php';
            if (file_exists($base_class_path)) require_once $base_class_path;
            else return new WP_Error('base_strategy_class_missing', 'BaseProviderStrategy class is missing.');
        }


        if (isset($strategies_to_load[$provider])) {
             $strategy_file = $strategy_path_base . $strategies_to_load[$provider];
             if (file_exists($strategy_file)) {
                 require_once $strategy_file;
             } else {
                 /* translators: %s: The name of the AI provider (e.g., 'OpenAI'). */
                 return new WP_Error('strategy_file_not_found', sprintf(__('Strategy file not found for provider: %s', 'gpt3-ai-content-generator'), esc_html($provider)));
             }
        } else {
             /* translators: %s: The name of the AI provider. */
             return new WP_Error('unsupported_provider_strategy', sprintf(__('Provider strategy for "%s" is not defined in loader map.', 'gpt3-ai-content-generator'), esc_html($provider)));
        }

        switch ($provider) {
            case 'OpenAI':
                if (class_exists(OpenAIProviderStrategy::class)) {
                    self::$instances[$provider] = new OpenAIProviderStrategy();
                }
                break;
            case 'OpenRouter':
                 if (class_exists(OpenRouterProviderStrategy::class)) {
                    self::$instances[$provider] = new OpenRouterProviderStrategy();
                 }
                break;
            case 'Google':
                 if (class_exists(GoogleProviderStrategy::class)) {
                    self::$instances[$provider] = new GoogleProviderStrategy();
                 }
                break;
            case 'Azure':
                 if (class_exists(AzureProviderStrategy::class)) { 
                    self::$instances[$provider] = new AzureProviderStrategy();
                 }
                 break;
             case 'DeepSeek':
                 if (class_exists(DeepSeekProviderStrategy::class)) {
                     self::$instances[$provider] = new DeepSeekProviderStrategy();
                 }
                 break;
            case 'Ollama':
                if (class_exists(AIPKit_Ollama_Strategy::class)) {
                    self::$instances[$provider] = new AIPKit_Ollama_Strategy();
                }
                break;
            default:
                /* translators: %s: The name of the AI provider. */
                return new WP_Error('unsupported_provider_strategy', sprintf(__('Provider strategy "%s" is not supported.', 'gpt3-ai-content-generator'), esc_html($provider)));
        }

        if (!isset(self::$instances[$provider])) {
            /* translators: %s: The name of the AI provider. */
            return new WP_Error('strategy_instantiation_failed', sprintf(__('Failed to load strategy for provider: %s', 'gpt3-ai-content-generator'), esc_html($provider)));
        }

        return self::$instances[$provider];
    }

================================================================================
FUNCION: build_api_url
Resumen: Función que maneja $human.
CODIGO:
function build_api_url(string $operation, array $params): string|WP_Error;

    /**
     * Get necessary HTTP headers for API requests.
     *
     * @param string $api_key The API key for the provider.
     * @param string $operation The specific operation being performed.
     * @return array Key-value array of headers.
     */
    public function get_api_headers(string $api_key, string $operation): array;

    /**
     * Format the payload (messages, instructions) for a standard chat request.
     *
     * @param string $user_message The user's message.
     * @param string $instructions System instructions.
     * @param array  $history Conversation history.
     * @param array  $ai_params AI parameters (temperature, max_tokens, etc.).
     * @param string $model The target model/deployment ID.
     * @return array The formatted request body data.
     */
    public function format_chat_payload(string $user_message, string $instructions, array $history, array $ai_params, string $model): array;

    /**
     * Parse the response from a standard chat request.
     *
     * @param array $decoded_response The decoded JSON response body.
     * @param array $request_data The original request data sent.
     * @return array|WP_Error ['content' => string, 'usage' => array|null] or WP_Error.
     */
    public function parse_chat_response(array $decoded_response, array $request_data): array|WP_Error;

    /**
     * Parse an error response from the provider.
     *
     * @param mixed $response_body The raw or decoded error response body.
     * @param int $status_code The HTTP status code.
     * @return string A user-friendly error message.
     */
    public function parse_error_response($response_body, int $status_code): string;

    /**
     * Fetch the list of available models/deployments.
     *
     * @param array $api_params Connection parameters (api_key, base_url, etc.).
     * @return array|WP_Error Formatted list [['id' => ..., 'name' => ...]] or WP_Error.
     */
    public function get_models(array $api_params): array|WP_Error;

    /**
     * Build the payload for an SSE (streaming) chat request.
     *
     * @param array $messages Formatted messages/input/contents array.
     * @param string|array|null $system_instruction Formatted system instruction.
     * @param array $ai_params AI parameters.
     * @param string $model Target model/deployment.
     * @return array The formatted request body data for SSE.
     */
    public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;

    /**
     * Parse a chunk of data received from an SSE stream.
     *
     * @param string $sse_chunk The raw chunk received from the stream.
     * @param string &$current_buffer The reference to the incomplete buffer for this provider.
     * @return array {
     *     'delta'      => string|null, // Text delta
     *     'usage'      => array|null,  // Token usage data
     *     'is_error'   => bool,        // Fatal error flag
     *     'is_warning' => bool,        // Non-fatal warning/block flag
     *     'is_done'    => bool         // End signal flag
     * }

================================================================================
FUNCION: get_api_headers
Resumen: Función que maneja $human.
CODIGO:
function get_api_headers(string $api_key, string $operation): array;

    /**
     * Format the payload (messages, instructions) for a standard chat request.
     *
     * @param string $user_message The user's message.
     * @param string $instructions System instructions.
     * @param array  $history Conversation history.
     * @param array  $ai_params AI parameters (temperature, max_tokens, etc.).
     * @param string $model The target model/deployment ID.
     * @return array The formatted request body data.
     */
    public function format_chat_payload(string $user_message, string $instructions, array $history, array $ai_params, string $model): array;

    /**
     * Parse the response from a standard chat request.
     *
     * @param array $decoded_response The decoded JSON response body.
     * @param array $request_data The original request data sent.
     * @return array|WP_Error ['content' => string, 'usage' => array|null] or WP_Error.
     */
    public function parse_chat_response(array $decoded_response, array $request_data): array|WP_Error;

    /**
     * Parse an error response from the provider.
     *
     * @param mixed $response_body The raw or decoded error response body.
     * @param int $status_code The HTTP status code.
     * @return string A user-friendly error message.
     */
    public function parse_error_response($response_body, int $status_code): string;

    /**
     * Fetch the list of available models/deployments.
     *
     * @param array $api_params Connection parameters (api_key, base_url, etc.).
     * @return array|WP_Error Formatted list [['id' => ..., 'name' => ...]] or WP_Error.
     */
    public function get_models(array $api_params): array|WP_Error;

    /**
     * Build the payload for an SSE (streaming) chat request.
     *
     * @param array $messages Formatted messages/input/contents array.
     * @param string|array|null $system_instruction Formatted system instruction.
     * @param array $ai_params AI parameters.
     * @param string $model Target model/deployment.
     * @return array The formatted request body data for SSE.
     */
    public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;

    /**
     * Parse a chunk of data received from an SSE stream.
     *
     * @param string $sse_chunk The raw chunk received from the stream.
     * @param string &$current_buffer The reference to the incomplete buffer for this provider.
     * @return array {
     *     'delta'      => string|null, // Text delta
     *     'usage'      => array|null,  // Token usage data
     *     'is_error'   => bool,        // Fatal error flag
     *     'is_warning' => bool,        // Non-fatal warning/block flag
     *     'is_done'    => bool         // End signal flag
     * }

================================================================================
FUNCION: format_chat_payload
Resumen: Función que maneja $human.
CODIGO:
function format_chat_payload(string $user_message, string $instructions, array $history, array $ai_params, string $model): array;

    /**
     * Parse the response from a standard chat request.
     *
     * @param array $decoded_response The decoded JSON response body.
     * @param array $request_data The original request data sent.
     * @return array|WP_Error ['content' => string, 'usage' => array|null] or WP_Error.
     */
    public function parse_chat_response(array $decoded_response, array $request_data): array|WP_Error;

    /**
     * Parse an error response from the provider.
     *
     * @param mixed $response_body The raw or decoded error response body.
     * @param int $status_code The HTTP status code.
     * @return string A user-friendly error message.
     */
    public function parse_error_response($response_body, int $status_code): string;

    /**
     * Fetch the list of available models/deployments.
     *
     * @param array $api_params Connection parameters (api_key, base_url, etc.).
     * @return array|WP_Error Formatted list [['id' => ..., 'name' => ...]] or WP_Error.
     */
    public function get_models(array $api_params): array|WP_Error;

    /**
     * Build the payload for an SSE (streaming) chat request.
     *
     * @param array $messages Formatted messages/input/contents array.
     * @param string|array|null $system_instruction Formatted system instruction.
     * @param array $ai_params AI parameters.
     * @param string $model Target model/deployment.
     * @return array The formatted request body data for SSE.
     */
    public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;

    /**
     * Parse a chunk of data received from an SSE stream.
     *
     * @param string $sse_chunk The raw chunk received from the stream.
     * @param string &$current_buffer The reference to the incomplete buffer for this provider.
     * @return array {
     *     'delta'      => string|null, // Text delta
     *     'usage'      => array|null,  // Token usage data
     *     'is_error'   => bool,        // Fatal error flag
     *     'is_warning' => bool,        // Non-fatal warning/block flag
     *     'is_done'    => bool         // End signal flag
     * }

================================================================================
FUNCION: parse_chat_response
Resumen: Función que maneja $human.
CODIGO:
function parse_chat_response(array $decoded_response, array $request_data): array|WP_Error;

    /**
     * Parse an error response from the provider.
     *
     * @param mixed $response_body The raw or decoded error response body.
     * @param int $status_code The HTTP status code.
     * @return string A user-friendly error message.
     */
    public function parse_error_response($response_body, int $status_code): string;

    /**
     * Fetch the list of available models/deployments.
     *
     * @param array $api_params Connection parameters (api_key, base_url, etc.).
     * @return array|WP_Error Formatted list [['id' => ..., 'name' => ...]] or WP_Error.
     */
    public function get_models(array $api_params): array|WP_Error;

    /**
     * Build the payload for an SSE (streaming) chat request.
     *
     * @param array $messages Formatted messages/input/contents array.
     * @param string|array|null $system_instruction Formatted system instruction.
     * @param array $ai_params AI parameters.
     * @param string $model Target model/deployment.
     * @return array The formatted request body data for SSE.
     */
    public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;

    /**
     * Parse a chunk of data received from an SSE stream.
     *
     * @param string $sse_chunk The raw chunk received from the stream.
     * @param string &$current_buffer The reference to the incomplete buffer for this provider.
     * @return array {
     *     'delta'      => string|null, // Text delta
     *     'usage'      => array|null,  // Token usage data
     *     'is_error'   => bool,        // Fatal error flag
     *     'is_warning' => bool,        // Non-fatal warning/block flag
     *     'is_done'    => bool         // End signal flag
     * }

================================================================================
FUNCION: parse_error_response
Resumen: Función que maneja $human.
CODIGO:
function parse_error_response($response_body, int $status_code): string;

    /**
     * Fetch the list of available models/deployments.
     *
     * @param array $api_params Connection parameters (api_key, base_url, etc.).
     * @return array|WP_Error Formatted list [['id' => ..., 'name' => ...]] or WP_Error.
     */
    public function get_models(array $api_params): array|WP_Error;

    /**
     * Build the payload for an SSE (streaming) chat request.
     *
     * @param array $messages Formatted messages/input/contents array.
     * @param string|array|null $system_instruction Formatted system instruction.
     * @param array $ai_params AI parameters.
     * @param string $model Target model/deployment.
     * @return array The formatted request body data for SSE.
     */
    public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;

    /**
     * Parse a chunk of data received from an SSE stream.
     *
     * @param string $sse_chunk The raw chunk received from the stream.
     * @param string &$current_buffer The reference to the incomplete buffer for this provider.
     * @return array {
     *     'delta'      => string|null, // Text delta
     *     'usage'      => array|null,  // Token usage data
     *     'is_error'   => bool,        // Fatal error flag
     *     'is_warning' => bool,        // Non-fatal warning/block flag
     *     'is_done'    => bool         // End signal flag
     * }

================================================================================
FUNCION: get_models
Resumen: Función que maneja $human.
CODIGO:
function get_models(array $api_params): array|WP_Error;

    /**
     * Build the payload for an SSE (streaming) chat request.
     *
     * @param array $messages Formatted messages/input/contents array.
     * @param string|array|null $system_instruction Formatted system instruction.
     * @param array $ai_params AI parameters.
     * @param string $model Target model/deployment.
     * @return array The formatted request body data for SSE.
     */
    public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;

    /**
     * Parse a chunk of data received from an SSE stream.
     *
     * @param string $sse_chunk The raw chunk received from the stream.
     * @param string &$current_buffer The reference to the incomplete buffer for this provider.
     * @return array {
     *     'delta'      => string|null, // Text delta
     *     'usage'      => array|null,  // Token usage data
     *     'is_error'   => bool,        // Fatal error flag
     *     'is_warning' => bool,        // Non-fatal warning/block flag
     *     'is_done'    => bool         // End signal flag
     * }

================================================================================
FUNCION: build_sse_payload
Resumen: Función que maneja $human.
CODIGO:
function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;

    /**
     * Parse a chunk of data received from an SSE stream.
     *
     * @param string $sse_chunk The raw chunk received from the stream.
     * @param string &$current_buffer The reference to the incomplete buffer for this provider.
     * @return array {
     *     'delta'      => string|null, // Text delta
     *     'usage'      => array|null,  // Token usage data
     *     'is_error'   => bool,        // Fatal error flag
     *     'is_warning' => bool,        // Non-fatal warning/block flag
     *     'is_done'    => bool         // End signal flag
     * }

================================================================================
FUNCION: parse_sse_chunk
Resumen: Función que maneja $human.
CODIGO:
function parse_sse_chunk(string $sse_chunk, string &$current_buffer): array;

     /**
     * Get provider-specific request options for wp_remote_request or cURL.
     *
     * @param string $operation The operation ('chat', 'stream', 'models').
     * @return array Additional options (e.g., method, user-agent, timeout).
     */
    public function get_request_options(string $operation): array;

    /**
     * Format headers array into the ['Header: Value', ...] format needed by cURL.
     *
     * @param array $headers Key-value array of headers.
     * @return array Indexed array of header strings.
     */
    public function format_headers_for_curl(array $headers): array;

    /**
     * Generate embeddings for the given input text(s).
     *
     * @param string|array $input The input text or array of texts.
     * @param array $api_params Provider-specific API connection parameters.
     * @param array $options Embedding options (model, dimensions, encoding_format, etc.).
---
A3) Base Provider Strategy (shared helpers)
File: classes/core/providers/base-provider-strategy.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/providers/base-provider-strategy.php
// Status: MODIFIED

namespace WPAICG\Core\Providers; // *** Correct namespace ***

use WP_Error;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: get_request_options
Resumen: Función que maneja $human.
CODIGO:
function get_request_options(string $operation): array;

    /**
     * Format headers array into the ['Header: Value', ...] format needed by cURL.
     *
     * @param array $headers Key-value array of headers.
     * @return array Indexed array of header strings.
     */
    public function format_headers_for_curl(array $headers): array;

    /**
     * Generate embeddings for the given input text(s).
     *
     * @param string|array $input The input text or array of texts.
     * @param array $api_params Provider-specific API connection parameters.
     * @param array $options Embedding options (model, dimensions, encoding_format, etc.).
---
A3) Base Provider Strategy (shared helpers)
File: classes/core/providers/base-provider-strategy.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/providers/base-provider-strategy.php
// Status: MODIFIED

namespace WPAICG\Core\Providers; // *** Correct namespace ***

use WP_Error;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: format_headers_for_curl
Resumen: Función que maneja $human.
CODIGO:
function format_headers_for_curl(array $headers): array;

    /**
     * Generate embeddings for the given input text(s).
     *
     * @param string|array $input The input text or array of texts.
     * @param array $api_params Provider-specific API connection parameters.
     * @param array $options Embedding options (model, dimensions, encoding_format, etc.).
---
A3) Base Provider Strategy (shared helpers)
File: classes/core/providers/base-provider-strategy.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/providers/base-provider-strategy.php
// Status: MODIFIED

namespace WPAICG\Core\Providers; // *** Correct namespace ***

use WP_Error;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: decode_json
Resumen: Función que maneja $human.
CODIGO:
function decode_json(string $json_string, string $context): array|WP_Error // MODIFIED to public
    {if (trim($json_string) === '') {
        return [];
    }
        $decoded = json_decode($json_string, true);
        if (json_last_error() !== JSON_ERROR_NONE) {
            /* translators: %1$s: The context of the API call (e.g., "OpenAI Models"), %2$s: The specific JSON error message from PHP. */
            $error_message = sprintf(__('Failed to parse JSON response from %1$s. Error: %2$s', 'gpt3-ai-content-generator'), $context, json_last_error_msg());
            return new WP_Error('json_decode_error', $error_message);
        }
        return is_array($decoded) ? $decoded : [];
    }

================================================================================
FUNCION: format_model_list
Resumen: Función que maneja $human.
CODIGO:
function format_model_list(array $raw_models, string $id_key = 'id', string $name_key = 'id'): array // MODIFIED to public (was protected)
    {$formatted = [];
        if (!is_array($raw_models)) {
            return [];
        }
        foreach ($raw_models as $model) {
            if (!is_array($model)) {
                continue;
            }
            $id = $model[$id_key] ?? null;
            if (!empty($id)) {
                $name = $model[$name_key] ?? $id;
                $formatted[] = [
                    'id'   => $id,
                    'name' => $name,
                    'status' => $model['status'] ?? null,
                    'version' => $model['version'] ?? null,
                ];
            }
        }
        usort($formatted, fn ($a, $b) => strcasecmp($a['name'] ?? '', $b['name'] ?? ''));
        return $formatted;
    }

================================================================================
FUNCION: format_headers_for_curl
Resumen: Función que maneja $human.
CODIGO:
function format_headers_for_curl(array $headers): array
    {
        $result = [];
        foreach ($headers as $k => $v) {
            $result[] = $k . ': ' . $v;
        }
        return $result;
    }

================================================================================
FUNCION: get_request_options
Resumen: Función que maneja $human.
CODIGO:
function get_request_options(string $operation): array
    {
        return [
           'method'     => 'POST',
           'timeout'    => ($operation === 'stream') ? 120 : 60,
           'user-agent' => 'AIPKit/' . (defined('WPAICG_VERSION') ? WPAICG_VERSION : '1.0') . '; ' . get_bloginfo('url'),
           'sslverify'  => apply_filters('https_local_ssl_verify', true),
        ];
    }

================================================================================
FUNCION: build_api_url
Resumen: Función que maneja $human.
CODIGO:
function build_api_url(string $operation, array $params): string|WP_Error;
    abstract public function get_api_headers(string $api_key, string $operation): array;
    abstract public function format_chat_payload(string $user_message, string $instructions, array $history, array $ai_params, string $model): array;
    abstract public function parse_chat_response(array $decoded_response, array $request_data): array|WP_Error;
    abstract public function parse_error_response($response_body, int $status_code): string; // Kept abstract, to be implemented by each strategy
    abstract public function get_models(array $api_params): array|WP_Error;
    abstract public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;
    abstract public function parse_sse_chunk(string $sse_chunk, string &$current_buffer): array;
    abstract public function generate_embeddings($input, array $api_params, array $options = []): array|WP_Error;
}
---
A4) AI Caller (core API request flow)
File: classes/core/class-aipkit_ai_caller.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/class-aipkit_ai_caller.php
// Status: MODIFIED

namespace WPAICG\Core;

use WPAICG\AIPKit_Providers;
use WPAICG\AIPKIT_AI_Settings;
use WPAICG\Core\Providers\ProviderStrategyFactory;
use WPAICG\Core\Providers\ProviderStrategyInterface;
use WPAICG\Core\Providers\Google\GoogleSettingsHandler;
use WPAICG\Core\AIPKit_Payload_Sanitizer;
use WP_Error;
use WPAICG\Core\AIPKit_Instruction_Manager;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: get_api_headers
Resumen: Función que maneja $human.
CODIGO:
function get_api_headers(string $api_key, string $operation): array;
    abstract public function format_chat_payload(string $user_message, string $instructions, array $history, array $ai_params, string $model): array;
    abstract public function parse_chat_response(array $decoded_response, array $request_data): array|WP_Error;
    abstract public function parse_error_response($response_body, int $status_code): string; // Kept abstract, to be implemented by each strategy
    abstract public function get_models(array $api_params): array|WP_Error;
    abstract public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;
    abstract public function parse_sse_chunk(string $sse_chunk, string &$current_buffer): array;
    abstract public function generate_embeddings($input, array $api_params, array $options = []): array|WP_Error;
}
---
A4) AI Caller (core API request flow)
File: classes/core/class-aipkit_ai_caller.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/class-aipkit_ai_caller.php
// Status: MODIFIED

namespace WPAICG\Core;

use WPAICG\AIPKit_Providers;
use WPAICG\AIPKIT_AI_Settings;
use WPAICG\Core\Providers\ProviderStrategyFactory;
use WPAICG\Core\Providers\ProviderStrategyInterface;
use WPAICG\Core\Providers\Google\GoogleSettingsHandler;
use WPAICG\Core\AIPKit_Payload_Sanitizer;
use WP_Error;
use WPAICG\Core\AIPKit_Instruction_Manager;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: format_chat_payload
Resumen: Función que maneja $human.
CODIGO:
function format_chat_payload(string $user_message, string $instructions, array $history, array $ai_params, string $model): array;
    abstract public function parse_chat_response(array $decoded_response, array $request_data): array|WP_Error;
    abstract public function parse_error_response($response_body, int $status_code): string; // Kept abstract, to be implemented by each strategy
    abstract public function get_models(array $api_params): array|WP_Error;
    abstract public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;
    abstract public function parse_sse_chunk(string $sse_chunk, string &$current_buffer): array;
    abstract public function generate_embeddings($input, array $api_params, array $options = []): array|WP_Error;
}
---
A4) AI Caller (core API request flow)
File: classes/core/class-aipkit_ai_caller.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/class-aipkit_ai_caller.php
// Status: MODIFIED

namespace WPAICG\Core;

use WPAICG\AIPKit_Providers;
use WPAICG\AIPKIT_AI_Settings;
use WPAICG\Core\Providers\ProviderStrategyFactory;
use WPAICG\Core\Providers\ProviderStrategyInterface;
use WPAICG\Core\Providers\Google\GoogleSettingsHandler;
use WPAICG\Core\AIPKit_Payload_Sanitizer;
use WP_Error;
use WPAICG\Core\AIPKit_Instruction_Manager;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: parse_chat_response
Resumen: Función que maneja $human.
CODIGO:
function parse_chat_response(array $decoded_response, array $request_data): array|WP_Error;
    abstract public function parse_error_response($response_body, int $status_code): string; // Kept abstract, to be implemented by each strategy
    abstract public function get_models(array $api_params): array|WP_Error;
    abstract public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;
    abstract public function parse_sse_chunk(string $sse_chunk, string &$current_buffer): array;
    abstract public function generate_embeddings($input, array $api_params, array $options = []): array|WP_Error;
}
---
A4) AI Caller (core API request flow)
File: classes/core/class-aipkit_ai_caller.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/class-aipkit_ai_caller.php
// Status: MODIFIED

namespace WPAICG\Core;

use WPAICG\AIPKit_Providers;
use WPAICG\AIPKIT_AI_Settings;
use WPAICG\Core\Providers\ProviderStrategyFactory;
use WPAICG\Core\Providers\ProviderStrategyInterface;
use WPAICG\Core\Providers\Google\GoogleSettingsHandler;
use WPAICG\Core\AIPKit_Payload_Sanitizer;
use WP_Error;
use WPAICG\Core\AIPKit_Instruction_Manager;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: parse_error_response
Resumen: Función que maneja $human.
CODIGO:
function parse_error_response($response_body, int $status_code): string; // Kept abstract, to be implemented by each strategy
    abstract public function get_models(array $api_params): array|WP_Error;
    abstract public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;
    abstract public function parse_sse_chunk(string $sse_chunk, string &$current_buffer): array;
    abstract public function generate_embeddings($input, array $api_params, array $options = []): array|WP_Error;
}
---
A4) AI Caller (core API request flow)
File: classes/core/class-aipkit_ai_caller.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/class-aipkit_ai_caller.php
// Status: MODIFIED

namespace WPAICG\Core;

use WPAICG\AIPKit_Providers;
use WPAICG\AIPKIT_AI_Settings;
use WPAICG\Core\Providers\ProviderStrategyFactory;
use WPAICG\Core\Providers\ProviderStrategyInterface;
use WPAICG\Core\Providers\Google\GoogleSettingsHandler;
use WPAICG\Core\AIPKit_Payload_Sanitizer;
use WP_Error;
use WPAICG\Core\AIPKit_Instruction_Manager;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: get_models
Resumen: Función que maneja $human.
CODIGO:
function get_models(array $api_params): array|WP_Error;
    abstract public function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;
    abstract public function parse_sse_chunk(string $sse_chunk, string &$current_buffer): array;
    abstract public function generate_embeddings($input, array $api_params, array $options = []): array|WP_Error;
}
---
A4) AI Caller (core API request flow)
File: classes/core/class-aipkit_ai_caller.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/class-aipkit_ai_caller.php
// Status: MODIFIED

namespace WPAICG\Core;

use WPAICG\AIPKit_Providers;
use WPAICG\AIPKIT_AI_Settings;
use WPAICG\Core\Providers\ProviderStrategyFactory;
use WPAICG\Core\Providers\ProviderStrategyInterface;
use WPAICG\Core\Providers\Google\GoogleSettingsHandler;
use WPAICG\Core\AIPKit_Payload_Sanitizer;
use WP_Error;
use WPAICG\Core\AIPKit_Instruction_Manager;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: build_sse_payload
Resumen: Función que maneja $human.
CODIGO:
function build_sse_payload(array $messages, $system_instruction, array $ai_params, string $model): array;
    abstract public function parse_sse_chunk(string $sse_chunk, string &$current_buffer): array;
    abstract public function generate_embeddings($input, array $api_params, array $options = []): array|WP_Error;
}
---
A4) AI Caller (core API request flow)
File: classes/core/class-aipkit_ai_caller.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/class-aipkit_ai_caller.php
// Status: MODIFIED

namespace WPAICG\Core;

use WPAICG\AIPKit_Providers;
use WPAICG\AIPKIT_AI_Settings;
use WPAICG\Core\Providers\ProviderStrategyFactory;
use WPAICG\Core\Providers\ProviderStrategyInterface;
use WPAICG\Core\Providers\Google\GoogleSettingsHandler;
use WPAICG\Core\AIPKit_Payload_Sanitizer;
use WP_Error;
use WPAICG\Core\AIPKit_Instruction_Manager;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: parse_sse_chunk
Resumen: Función que maneja $human.
CODIGO:
function parse_sse_chunk(string $sse_chunk, string &$current_buffer): array;
    abstract public function generate_embeddings($input, array $api_params, array $options = []): array|WP_Error;
}
---
A4) AI Caller (core API request flow)
File: classes/core/class-aipkit_ai_caller.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/class-aipkit_ai_caller.php
// Status: MODIFIED

namespace WPAICG\Core;

use WPAICG\AIPKit_Providers;
use WPAICG\AIPKIT_AI_Settings;
use WPAICG\Core\Providers\ProviderStrategyFactory;
use WPAICG\Core\Providers\ProviderStrategyInterface;
use WPAICG\Core\Providers\Google\GoogleSettingsHandler;
use WPAICG\Core\AIPKit_Payload_Sanitizer;
use WP_Error;
use WPAICG\Core\AIPKit_Instruction_Manager;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: generate_embeddings
Resumen: Función que maneja $human.
CODIGO:
function generate_embeddings($input, array $api_params, array $options = []): array|WP_Error;
}
---
A4) AI Caller (core API request flow)
File: classes/core/class-aipkit_ai_caller.php
---
<?php

// File: /Applications/MAMP/htdocs/wordpress/wp-content/plugins/gpt3-ai-content-generator/classes/core/class-aipkit_ai_caller.php
// Status: MODIFIED

namespace WPAICG\Core;

use WPAICG\AIPKit_Providers;
use WPAICG\AIPKIT_AI_Settings;
use WPAICG\Core\Providers\ProviderStrategyFactory;
use WPAICG\Core\Providers\ProviderStrategyInterface;
use WPAICG\Core\Providers\Google\GoogleSettingsHandler;
use WPAICG\Core\AIPKit_Payload_Sanitizer;
use WP_Error;
use WPAICG\Core\AIPKit_Instruction_Manager;

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

================================================================================
FUNCION: make_standard_call
Resumen: Función que maneja $human.
CODIGO:
    public function make_standard_call(

================================================================================
FUNCION: get_current_provider
Resumen: Función que maneja $human.
CODIGO:
function get_current_provider()
    {
        // --- FIX: Safely retrieve options ---
        $opts = get_option('aipkit_options');
        if (!is_array($opts)) {
            $opts = [];
        }
        // --- END FIX ---
        return isset($opts['provider']) ? $opts['provider'] : 'OpenAI';
    }

================================================================================
FUNCION: get_all_providers
Resumen: Función que maneja $human.
CODIGO:
    public static function get_all_providers()

================================================================================
FUNCION: init
Resumen: Función que maneja $human.
CODIGO:
function init() {
            // Ensure Google Settings Handler is loaded
            $google_settings_handler_path = WPAICG_PLUGIN_DIR . 'classes/core/providers/google/GoogleSettingsHandler.php';
            if (!class_exists(GoogleSettingsHandler::class) && file_exists($google_settings_handler_path)) {
                 require_once $google_settings_handler_path;
            }

            // Initialize Google safety settings via the handler if available
            if (class_exists(GoogleSettingsHandler::class) && method_exists(GoogleSettingsHandler::class, 'check_and_init_safety_settings')) {
                GoogleSettingsHandler::check_and_init_safety_settings();
            }
            // Initialize core settings
            self::check_and_init_ai_parameters();
            self::check_and_init_api_keys();
        }

================================================================================
FUNCION: check_and_init_ai_parameters
Resumen: Función que maneja $human.
CODIGO:
function check_and_init_ai_parameters() {
            $opts = get_option('aipkit_options', array());
            if (!isset($opts['ai_parameters']) || !is_array($opts['ai_parameters'])) {
                $opts['ai_parameters'] = self::$default_ai_params;
                update_option('aipkit_options', $opts, 'no');
            } else {
                // Ensure all default keys exist and remove obsolete ones
                $final_params = [];
                foreach (self::$default_ai_params as $key => $default_value) {
                    $final_params[$key] = $opts['ai_parameters'][$key] ?? $default_value;
                }
                if ($final_params !== $opts['ai_parameters']) {
                    $opts['ai_parameters'] = $final_params;
                    update_option('aipkit_options', $opts, 'no');
                }
            }
        }

================================================================================
FUNCION: check_and_init_api_keys
Resumen: Función que maneja $human.
CODIGO:
function check_and_init_api_keys() {
             $opts = get_option('aipkit_options', array());
             if (!isset($opts['api_keys']) || !is_array($opts['api_keys'])) {
                 $opts['api_keys'] = self::$default_api_keys;
                 update_option('aipkit_options', $opts, 'no');
             } else {
                 $merged = array_merge(self::$default_api_keys, $opts['api_keys']);
                 if ($merged !== $opts['api_keys']) {
                     $opts['api_keys'] = $merged;
                     update_option('aipkit_options', $opts, 'no');
                 }
             }
        }

================================================================================
FUNCION: get_ai_parameters
Resumen: Función que maneja $human.
CODIGO:
function get_ai_parameters(): array {
            $opts = get_option('aipkit_options', array());
            self::check_and_init_ai_parameters(); // Ensure initialized
            $opts = get_option('aipkit_options', array()); // Re-fetch
            return $opts['ai_parameters'] ?? self::$default_ai_params;
        }

================================================================================
FUNCION: get_api_keys
Resumen: Función que maneja $human.
CODIGO:
function get_api_keys(): array {
             $opts = get_option('aipkit_options', array());
             self::check_and_init_api_keys(); // Ensure initialized
             $opts = get_option('aipkit_options', array()); // Re-fetch
             return $opts['api_keys'] ?? self::$default_api_keys;
        }

================================================================================
FUNCION: generate_response
Resumen: Función que maneja $human.
CODIGO:
function generate_response(
    \WPAICG\Chat\Core\AIService $serviceInstance,
    string $user_message,
    array $bot_settings,
    array $history,
    int $post_id = 0,
    ?string $frontend_previous_openai_response_id = null,
    bool $frontend_openai_web_search_active = false,
    bool $frontend_google_search_grounding_active = false,
    ?array $image_inputs_for_service = null,
    ?string $frontend_active_openai_vs_id = null,
    ?string $frontend_active_pinecone_index_name = null,
    ?string $frontend_active_pinecone_namespace = null,
    ?string $frontend_active_qdrant_collection_name = null,
    ?string $frontend_active_qdrant_file_upload_context_id = null
): array|WP_Error {
    $ai_caller = $serviceInstance->get_ai_caller();
    $vector_store_manager = $serviceInstance->get_vector_store_manager(); // Get Vector Store Manager

    $validation_result = GenerateResponse\validate_request_logic($ai_caller, $user_message, $image_inputs_for_service, $bot_settings);
    if (is_wp_error($validation_result)) {
        return $validation_result;
    }

    $provider_info = determine_provider_model($serviceInstance, $bot_settings);
    $main_provider = $provider_info['provider'];
    $model = $provider_info['model'];
    if (empty($model)) {
        return new WP_Error('missing_model_orchestrator', __('Chatbot AI Model or Deployment Name is missing in settings.', 'gpt3-ai-content-generator'));
    }

    $im_load_result = GenerateResponse\load_instruction_manager_logic();
    if (is_wp_error($im_load_result)) {
        return $im_load_result;
    }

    $vector_search_scores = []; // Initialize array to capture vector search scores
    $all_formatted_results_for_instruction = GenerateResponse\prepare_vector_search_context_logic(
        $ai_caller, // Pass AI Caller
        $vector_store_manager, // Pass Vector Store Manager
        $user_message,
        $bot_settings,
        $main_provider,
        $frontend_active_openai_vs_id,
        $frontend_active_pinecone_index_name,
        $frontend_active_pinecone_namespace,
        $frontend_active_qdrant_collection_name,
        $frontend_active_qdrant_file_upload_context_id,
        $vector_search_scores // Pass reference to capture scores
    );

    $base_instructions = $bot_settings['instructions'] ?? '';
    $instruction_context_for_logging = [
        'bot_settings' => $bot_settings, 
        'post_id' => $post_id, 
        'vector_search_results' => $all_formatted_results_for_instruction,
        'vector_search_scores' => $vector_search_scores // Add vector search scores for logging
    ];
    $instructions_processed = GenerateResponse\build_final_system_instruction_logic($bot_settings, $post_id, $base_instructions, $all_formatted_results_for_instruction);

    $messages_prep_result = GenerateResponse\prepare_messages_for_api_logic($history, $user_message);
    $messages_payload = $messages_prep_result['messages_payload'];
    $latest_user_message_obj_for_stateful = $messages_prep_result['latest_user_message_obj_for_stateful'];
    $last_openai_response_id_from_history = $messages_prep_result['last_openai_response_id_from_history'];

    $ai_params_override_from_config = [];
    if (isset($bot_settings['temperature'])) {
        $ai_params_override_from_config['temperature'] = floatval($bot_settings['temperature']);
    }
    if (isset($bot_settings['max_completion_tokens'])) {
        $ai_params_override_from_config['max_completion_tokens'] = absint($bot_settings['max_completion_tokens']);
    }
    if (!empty($image_inputs_for_service)) {
        $ai_params_override_from_config['image_inputs'] = $image_inputs_for_service;
    }

    $final_ai_params_result = GenerateResponse\prepare_final_ai_params_logic(
        $ai_params_override_from_config,
        $bot_settings,
        $main_provider,
        $model,
        $frontend_previous_openai_response_id,
        $last_openai_response_id_from_history,
        $messages_payload,
        $frontend_openai_web_search_active,
        $frontend_google_search_grounding_active,
        $frontend_active_openai_vs_id
    );
    $final_ai_params = $final_ai_params_result['final_ai_params'];
    $actual_previous_response_id_to_use = $final_ai_params_result['actual_previous_response_id_to_use'];

    $ai_call_result = GenerateResponse\execute_ai_call_logic(
        $ai_caller,
        $main_provider,
        $model,
        $messages_payload,
        $final_ai_params,
        $instructions_processed,
        $instruction_context_for_logging
    );

    if (is_wp_error($ai_call_result)) {
        $triggers_enabled = false;
        if (class_exists('\WPAICG\aipkit_dashboard')) {
            $triggers_enabled = \WPAICG\aipkit_dashboard::is_pro_plan();
        }
        GenerateResponse\handle_ai_call_error_logic(
            $ai_call_result,
            $triggers_enabled,
            $serviceInstance->get_log_storage(),
            [],
            $main_provider,
            $model,
            $bot_settings['bot_id'] ?? 0
        );
        return $ai_call_result;
    }

    return GenerateResponse\finalize_ai_response_logic(
        $ai_call_result,
        $main_provider,
        $model,
        $history,
        $base_instructions,
        $final_ai_params,
        $actual_previous_response_id_to_use
    );
}

================================================================================
FUNCION: execute_ai_call_logic
Resumen (del comentario): Executes the AI call using AIPKit_AI_Caller. @param \WPAICG\Core\AIPKit_AI_Caller $ai_caller Instance of AI Caller. @param string $main_provider The main AI provider. @param string $model The selected AI model. @param array $messages_payload The prepared messages payload for the API. @param array $final_ai_params The final AI parameters. @param string $instructions_processed The processed system instruction. @param array $instruction_context_for_logging Context used for instruction building (for logging). @return array|WP_Error The result from AI Caller.
CODIGO:
function execute_ai_call_logic(
    \WPAICG\Core\AIPKit_AI_Caller $ai_caller,
    string $main_provider,
    string $model,
    array $messages_payload,
    array $final_ai_params,
    string $instructions_processed,
    array $instruction_context_for_logging
): array|WP_Error {
    return $ai_caller->make_standard_call(
        $main_provider,
        $model,
        $messages_payload,
        $final_ai_params,
        $instructions_processed,
        $instruction_context_for_logging // Pass context for logging
    );
}

================================================================================
FUNCION: prepare_messages_for_api_logic
Resumen (del comentario): Prepares the messages array for the API call and extracts relevant info for stateful OpenAI. @param array $history Conversation history. @param string $user_message_text The latest user message. @return array Contains 'messages_payload', 'latest_user_message_obj_for_stateful', 'last_openai_response_id_from_history'.
CODIGO:
function prepare_messages_for_api_logic(array $history, string $user_message_text): array
{
    $messages_payload = [];
    $latest_user_message_obj_for_stateful = null;
    $last_openai_response_id_from_history = null;

    foreach ($history as $msg) {
        $role = ($msg['role'] === 'bot') ? 'assistant' : $msg['role'];
        $content = isset($msg['content']) ? trim($msg['content']) : '';
        if ($content !== '' && in_array($role, ['system', 'user', 'assistant'])) {
            $messages_payload[] = ['role' => $role, 'content' => $content];
            if ($role === 'user' && $msg['content'] === $user_message_text) { // Assuming history includes the current user message for this logic
                $latest_user_message_obj_for_stateful = ['role' => 'user', 'content' => $content];
            }
        }
        if (($role === 'assistant' || $role === 'bot') && isset($msg['openai_response_id']) && !empty($msg['openai_response_id'])) {
            $last_openai_response_id_from_history = $msg['openai_response_id'];
        }
    }
    // Note: The original AIService::generate_response adds the current user message to history
    // *after* limiting it, then loops through this potentially modified history.
    // For this refactor, this function receives the already limited $history.
    // The current $user_message_text is the latest message from the user.
    // The AI_Caller will typically add the latest user message to the final payload.
    // This function here primarily formats the existing $history for the API.
    // Let's adjust to assume $history is the *previous* history, and add $user_message_text here.
    // No, the original AIService directly adds $user_message as the last item to the history array for some providers,
    // and for OpenAI stateful, it uses only the latest user message.
    // The AIPKit_AI_Caller's format_chat_completions_payload actually expects the latest user message separately.
    // Let's stick to what AIPKit_AI_Caller expects for $messages_payload (which is history + latest user message).
    // This means this function should append the current user message to the $messages_payload.
    if (!empty($user_message_text)) {
        $messages_payload[] = ['role' => 'user', 'content' => $user_message_text];
        $latest_user_message_obj_for_stateful = ['role' => 'user', 'content' => $user_message_text];
    }


    return [
        'messages_payload' => $messages_payload,
        'latest_user_message_obj_for_stateful' => $latest_user_message_obj_for_stateful,
        'last_openai_response_id_from_history' => $last_openai_response_id_from_history
    ];
}

================================================================================
FUNCION: get_default_title_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_title_prompt(): string
    {
        return __('You are an expert SEO copywriter. Write a powerful and engaging SEO title that:
- Starts with the main focus keyword
- Stays concise and fits typical search-result length (about 8-12 words)
- Includes at least one power word (e.g., Stunning, Must-Have, Exclusive)
- Includes a positive or negative sentiment word (e.g., Best, Effortless, Affordable)

Return ONLY the title text on a single line with no extra text or annotations.

Topic: "{topic}"
Keywords: "{keywords}"', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_content_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_content_prompt(): string
    {
        return __('Write a full article based on the topic and keywords below. The article must:
- Be at least 600 words long
- Include the focus keyword in one or more subheadings (H2, H3, etc.)
- Start the first paragraph with the focus keyword
- Be informative, structured, and engaging
- Use natural tone and clear formatting
- Avoid repeating the title in the content

Topic: "{topic}"
Keywords: "{keywords}"', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_meta_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_meta_prompt(): string
    {
        return __('Write a meta description (under 155 characters) for a page about the following topic. The description must:
- Begin with or include the focus keyword early
- Use active voice and a clear call-to-action
- Be concise and engaging

Return ONLY the plain meta description without any quotation marks, labels, or formatting.

Topic: "{topic}"
Keywords: "{keywords}"
Summary: "{content_summary}"', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_keyword_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_keyword_prompt(): string
    {
        return __('Identify the single most important and relevant SEO focus keyphrase for the article based on the title and summary. The keyphrase must:
- Be 2â€“4 words
- Be naturally found in the content
- Be suitable for SEO targeting

Return ONLY the keyphrase, with no labels, formatting, or quotation marks.

Title: "{topic}"
Summary:
{content_summary}', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_excerpt_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_excerpt_prompt(): string
    {
        return __('Write a short excerpt (1â€“2 engaging sentences) for the following article. Use a friendly, clear tone. Include the focus keyword naturally.

Return ONLY the excerpt, without any formatting or explanation.

Title: "{topic}"
Keywords: "{keywords}"
Summary: "{content_summary}"', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_tags_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_tags_prompt(): string
    {
        return __('Generate 5â€“10 relevant SEO tags for a blog post about the following topic. Tags must reflect key themes and keywords.

Return ONLY a comma-separated list of tags. Do not include any explanation, numbering, or formatting.

Title: "{topic}"
Keywords: "{keywords}"
Summary:
{content_summary}', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_image_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_image_prompt(): string
    {
        return __('Generate a high-quality, relevant image prompt for an article about: {topic}', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_featured_image_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_featured_image_prompt(): string
    {
        return __('Generate an eye-catching, high-quality featured image prompt for a blog post about: {topic}. Keywords: {keywords}.', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_image_title_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_image_title_prompt(): string
    {
        return __('Write a concise image title (under 8 words) based on the information below. Keep it clear and descriptive.

Return ONLY the title text without quotation marks or extra text.

Topic: "{topic}"
Keywords: "{keywords}"
Post title: "{post_title}"
Excerpt: "{excerpt}"
File name: "{file_name}"', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_image_alt_text_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_image_alt_text_prompt(): string
    {
        return __('Write clear alt text (under 125 characters) that describes the image for accessibility.

Return ONLY the alt text with no extra text.

Topic: "{topic}"
Keywords: "{keywords}"
Post title: "{post_title}"
Excerpt: "{excerpt}"
File name: "{file_name}"', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_image_caption_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_image_caption_prompt(): string
    {
        return __('Write a short, friendly caption (1 sentence) for the image.

Return ONLY the caption text with no extra text.

Topic: "{topic}"
Keywords: "{keywords}"
Post title: "{post_title}"
Excerpt: "{excerpt}"
File name: "{file_name}"', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_image_description_prompt
Resumen: Función que maneja $human.
CODIGO:
function get_default_image_description_prompt(): string
    {
        return __('Write a brief image description (1â€“2 sentences) suitable for the media library.

Return ONLY the description with no extra text.

Topic: "{topic}"
Keywords: "{keywords}"
Post title: "{post_title}"
Excerpt: "{excerpt}"
File name: "{file_name}"', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_image_title_prompt_update
Resumen: Función que maneja $human.
CODIGO:
function get_default_image_title_prompt_update(): string
    {
        return __('Write a concise image title (under 8 words) based on the attachment details below. Keep it literal and clear.

Return ONLY the title text without quotation marks or extra text.

Attachment title: "{original_title}"
Caption: "{original_caption}"
Description: "{original_description}"
Alt text: "{original_alt}"
File name: "{file_name}"', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_image_alt_text_prompt_update
Resumen: Función que maneja $human.
CODIGO:
function get_default_image_alt_text_prompt_update(): string
    {
        return __('Write clear alt text (under 125 characters) that describes the image for accessibility. Include a keyword only if it fits naturally.

Return ONLY the alt text.

Attachment title: "{original_title}"
Caption: "{original_caption}"
Description: "{original_description}"
Alt text: "{original_alt}"
File name: "{file_name}"', 'gpt3-ai-content-generator');
    }

================================================================================
FUNCION: get_default_image_caption_prompt_update
Resumen: Función que maneja $human.
CODIGO:
    public static function get_default_image_caption_prompt_update(): string

================================================================================
FUNCION: build
Resumen: Función que maneja $human.
CODIGO:
function build(array $settings): string
    {
        // Always use the custom content prompt. The caller will handle replacing placeholders.
        return trim($settings['custom_content_prompt'] ?? '');
    }

================================================================================
FUNCION: ensure_default_forms_exist
Resumen: Función que maneja $human.
CODIGO:
function ensure_default_forms_exist()
    {
        if (!class_exists(AIPKit_AI_Form_Storage::class) || !class_exists(AIPKit_AI_Form_Admin_Setup::class)) {
            return;
        }

        $default_forms = self::get_default_forms_data();
        $form_storage = new AIPKit_AI_Form_Storage();

        foreach ($default_forms as $form_key => $form_data) {
            $option_name = 'aipkit_default_form_created_' . $form_key;
            if (get_option($option_name)) {
                continue; // Already created.
            }

            // To avoid duplicates, also check by title.
            // FIX: Replaced deprecated get_page_by_title with WP_Query.
            $query = new \WP_Query([
                'post_type'      => AIPKit_AI_Form_Admin_Setup::POST_TYPE,
                'title'          => $form_data['title'],
                'post_status'    => 'publish',
                'posts_per_page' => 1,
                'no_found_rows'  => true,
            ]);

            if ($query->have_posts()) {
                $existing_post = $query->posts[0];
                update_option($option_name, $existing_post->ID, 'no');
                continue;
            }
            // --- END FIX ---

            $new_form_id_or_error = $form_storage->create_form($form_data['title'], $form_data['settings']);

            if (!is_wp_error($new_form_id_or_error)) {
                update_option($option_name, $new_form_id_or_error, 'no');
                // Also add meta to the post itself for easier identification if needed later
                update_post_meta($new_form_id_or_error, '_aipkit_is_default_form', '1');
            }
        }
    }

================================================================================
FUNCION: get_default_forms_data
Resumen: Función que maneja $human.
CODIGO:
function get_default_forms_data(): array
    {
        return [
            'blog_post_generator' => [
                'title' => 'Blog Post Generator',
                'settings' => [
                    'ai_provider' => 'OpenAI',
                    'ai_model' => 'gpt-4o-mini',
                    'prompt_template' => "You are an expert SEO content writer and professional blogger. Your task is to write a high-quality, engaging, and SEO-friendly blog post.\n\n**Instructions:**\n1.  **Analyze the Input:** Carefully consider the provided topic, target audience, desired length, and tone.\n2.  **Structure the Article:** The article must have a clear structure:\n    - An engaging introduction that hooks the reader.\n    - A well-organized body with multiple sections, using H2 and H3 headings.\n    - A concise and impactful conclusion that summarizes the key points.\n3.  **Incorporate Keywords:** Naturally weave the provided keywords throughout the article, especially in headings and the introduction.\n4.  **Tone:** Strictly adhere to the specified tone of voice.\n5.  **Length:** Adjust the depth and detail of the content to match the desired length.\n6.  **Output:** Return only the full article content in Markdown format. Do not include any pre-amble, notes, or post-article commentary.\n\n---\n**Blog Post Details:**\n*   **Topic/Title:** {topic}\n*   **Target Audience:** {audience}\n*   **Desired Length:** {length}\n*   **Tone of Voice:** {tone}\n*   **Keywords:** {keywords}\n---\n\nBegin the blog post now:",
                    'form_structure' => wp_json_encode([
                        ['internalId' => 'row-1', 'type' => 'layout-row', 'columns' => [
                            ['internalId' => 'col-1-1', 'width' => '100%', 'elements' => [
                                ['internalId' => 'el-1', 'type' => 'text-input', 'label' => 'Blog Post Topic / Title', 'placeholder' => 'e.g., The Future of Artificial Intelligence', 'fieldId' => 'topic', 'required' => true, 'helpText' => 'What is the main subject of your article?']
                            ]]
                        ]],
                        ['internalId' => 'row-2', 'type' => 'layout-row', 'columns' => [
                            ['internalId' => 'col-2-1', 'width' => '100%', 'elements' => [
                                ['internalId' => 'el-2', 'type' => 'text-input', 'label' => 'Target Audience', 'placeholder' => 'e.g., Tech enthusiasts, beginners, marketing professionals', 'fieldId' => 'audience', 'required' => true, 'helpText' => 'Who are you writing for?']
                            ]]
                        ]],
                        ['internalId' => 'row-3', 'type' => 'layout-row', 'columns' => [
                            ['internalId' => 'col-3-1', 'width' => '50%', 'elements' => [
                                ['internalId' => 'el-3', 'type' => 'select', 'label' => 'Desired Length', 'fieldId' => 'length', 'required' => true, 'options' => [
                                    ['value' => 'short (approx. 500 words)', 'text' => 'Short (~500 words)'],
                                    ['value' => 'medium (approx. 1000 words)', 'text' => 'Medium (~1000 words)'],
                                    ['value' => 'long (approx. 1500+ words)', 'text' => 'Long (1500+ words)']
                                ], 'helpText' => '']
                            ]],
                            ['internalId' => 'col-3-2', 'width' => '50%', 'elements' => [
                                ['internalId' => 'el-4', 'type' => 'select', 'label' => 'Tone of Voice', 'fieldId' => 'tone', 'required' => true, 'options' => [
                                    ['value' => 'Professional', 'text' => 'Professional'],
                                    ['value' => 'Casual', 'text' => 'Casual'],
                                    ['value' => 'Witty', 'text' => 'Witty'],
                                    ['value' => 'Persuasive', 'text' => 'Persuasive']
                                ], 'helpText' => '']
                            ]]
                        ]],
                        ['internalId' => 'row-4', 'type' => 'layout-row', 'columns' => [
                            ['internalId' => 'col-4-1', 'width' => '100%', 'elements' => [
                                ['internalId' => 'el-5', 'type' => 'text-input', 'label' => 'Keywords (comma-separated)', 'placeholder' => 'e.g., AI, machine learning, neural networks', 'fieldId' => 'keywords', 'required' => false, 'helpText' => '(Optional) Helps with SEO focus.']
                            ]]
                        ]],
                    ])
                ]
            ],
            'youtube_script_writer' => [
                'title' => 'YouTube Script Writer',
                'settings' => [
                    'ai_provider' => 'OpenAI',
                    'ai_model' => 'gpt-4o-mini',
                    'prompt_template' => "You are an expert YouTube scriptwriter with a knack for creating highly engaging and shareable video content. Your goal is to write a complete video script based on the details provided.\n\n**Instructions:**\n1.  **Script Structure:** The script should be structured logically with clear sections:\n    - **Hook (0-15 seconds):** A captivating opening to grab the viewer's attention immediately.\n    - **Intro:** Briefly introduce the video's topic and what the viewer will learn or experience.\n    - **Main Content:** Break down the core content into logical segments or talking points. Use bullet points for clarity.\n    - **Call to Action (CTA):** Integrate the provided Call to Action seamlessly. If none is provided, suggest a relevant one (e.g., \"like, comment, and subscribe\").\n    - **Outro:** A concluding segment that wraps up the video and gives a final thought.\n2.  **Timestamps:** Provide approximate timestamps (e.g., [00:30]) for each major section to guide the creator, based on the target duration.\n3.  **Visual Cues:** Include suggestions for on-screen text, B-roll, or graphics in brackets, like [Show on-screen: Key takeaway point].\n4.  **Tone & Style:** The script must match the specified video style.\n\n---\n**Video Details:**\n*   **Title/Topic:** {video_topic}\n*   **Target Duration:** {duration} minutes\n*   **Style:** {style}\n*   **Call to Action:** {cta}\n---\n\nWrite the complete YouTube script now:",
                    'form_structure' => wp_json_encode([
                        ['internalId' => 'row-5', 'type' => 'layout-row', 'columns' => [
                            ['internalId' => 'col-5-1', 'width' => '100%', 'elements' => [
                                ['internalId' => 'el-6', 'type' => 'text-input', 'label' => 'Video Title or Topic', 'placeholder' => 'e.g., How to Make the Perfect Sourdough Bread', 'fieldId' => 'video_topic', 'required' => true, 'helpText' => '']
                            ]]
                        ]],
                        ['internalId' => 'row-6', 'type' => 'layout-row', 'columns' => [
                            ['internalId' => 'col-6-1', 'width' => '50%', 'elements' => [
                                ['internalId' => 'el-7', 'type' => 'text-input', 'label' => 'Target Duration (in minutes)', 'placeholder' => 'e.g., 10', 'fieldId' => 'duration', 'required' => true, 'helpText' => 'Enter a number.']
                            ]],
                             ['internalId' => 'col-6-2', 'width' => '50%', 'elements' => [
                                ['internalId' => 'el-8', 'type' => 'select', 'label' => 'Video Style', 'fieldId' => 'style', 'required' => true, 'options' => [
                                    ['value' => 'Tutorial / How-to', 'text' => 'Tutorial / How-to'],
                                    ['value' => 'Vlog', 'text' => 'Vlog'],
                                    ['value' => 'Product Review', 'text' => 'Product Review'],
                                    ['value' => 'Storytelling / Narrative', 'text' => 'Storytelling / Narrative']
                                ], 'helpText' => '']
                            ]]
                        ]],
                         ['internalId' => 'row-7', 'type' => 'layout-row', 'columns' => [
                            ['internalId' => 'col-7-1', 'width' => '100%', 'elements' => [
                                ['internalId' => 'el-9', 'type' => 'textarea', 'label' => "Call to Action (Optional)", 'placeholder' => "e.g., Subscribe for more tips!", 'fieldId' => 'cta', 'required' => false, 'helpText' => 'What should viewers do at the end?']
                            ]]
                        ]],
                    ])
                ]
            ],
            'customer_support_reply_builder' => [
                'title' => 'Customer Support Reply Builder',
                'settings' => [
                    'ai_provider' => 'OpenAI',
                    'ai_model' => 'gpt-4o-mini',
                    'prompt_template' => "You are a highly skilled and empathetic customer support professional. Your task is to draft a helpful and well-written reply to the customer's message below.\n\n**Instructions:**\n1.  **Acknowledge:** Start by acknowledging the customer's issue or question.\n2.  **Address the Core Problem:** Directly address the main points from the customer's message.\n3.  **Maintain Tone:** Adhere strictly to the specified response tone.\n4.  **Incorporate Details:** Use the provided Product/Service Name and any additional notes to make the reply specific and helpful.\n5.  **Clarity and Conciseness:** Write a clear, concise, and easy-to-understand response.\n6.  **Format:** Output the reply only. Do not include any surrounding text, greetings to me, or explanations of what you did.\n\n---\n**Support Ticket Details:**\n*   **Customer's Message:**\n{customer_message}\n\n*   **Product/Service Mentioned:** {product_name}\n*   **Desired Response Tone:** {tone}\n*   **Internal Notes for your reply:** {notes}\n---\n\nDraft the customer support reply now:",
                    'form_structure' => wp_json_encode([
                        ['internalId' => 'row-8', 'type' => 'layout-row', 'columns' => [
                            ['internalId' => 'col-8-1', 'width' => '100%', 'elements' => [
                                ['internalId' => 'el-10', 'type' => 'textarea', 'label' => "Customer's Message", 'placeholder' => "Paste the customer's full email or message here.", 'fieldId' => 'customer_message', 'required' => true, 'helpText' => '']
                            ]]
                        ]],
                        ['internalId' => 'row-9', 'type' => 'layout-row', 'columns' => [
                            ['internalId' => 'col-9-1', 'width' => '50%', 'elements' => [
                                ['internalId' => 'el-11', 'type' => 'text-input', 'label' => 'Product/Service Name (Optional)', 'placeholder' => 'e.g., Pro Plan, Widget X', 'fieldId' => 'product_name', 'required' => false, 'helpText' => '']
                            ]],
                             ['internalId' => 'col-9-2', 'width' => '50%', 'elements' => [
                                ['internalId' => 'el-12', 'type' => 'select', 'label' => 'Response Tone', 'fieldId' => 'tone', 'required' => true, 'options' => [
                                    ['value' => 'Polite & Empathetic', 'text' => 'Polite & Empathetic'],
                                    ['value' => 'Friendly & Casual', 'text' => 'Friendly & Casual'],
                                    ['value' => 'Formal & Direct', 'text' => 'Formal & Direct'],
                                    ['value' => 'Neutral', 'text' => 'Neutral']
                                ], 'helpText' => '']
                            ]]
                        ]],
                         ['internalId' => 'row-10', 'type' => 'layout-row', 'columns' => [
                            ['internalId' => 'col-10-1', 'width' => '100%', 'elements' => [
                                ['internalId' => 'el-13', 'type' => 'textarea', 'label' => 'Additional Notes for AI (Optional)', 'placeholder' => 'e.g., Offer a 10% discount, Escalate to tier 2 support if not resolved.', 'fieldId' => 'notes', 'required' => false, 'helpText' => 'Internal context for the AI to use in the reply.']
                            ]]
                        ]],
                    ])
                ]
            ],
        ];
    }

================================================================================
FUNCION: build_prompt_logic
Resumen (del comentario): Builds the final prompt string from the template and submitted data. @param array $form_config The configuration of the form. @param array $submitted_fields The sanitized submitted data. @return string|WP_Error The final prompt string or WP_Error if template is missing.
CODIGO:
function build_prompt_logic(array $form_config, array $submitted_fields): string|WP_Error
{
    $prompt_template = $form_config['prompt_template'] ?? '';
    $form_structure = $form_config['structure'] ?? [];

    if (empty($prompt_template)) {
        return new WP_Error('missing_template', __('Form prompt template is not configured.', 'gpt3-ai-content-generator'), ['status' => 500]);
    }

    $final_prompt = $prompt_template;

    if (!empty($form_structure) && is_array($form_structure)) {
        foreach ($form_structure as $row) {
            if (empty($row['columns']) || !is_array($row['columns'])) {
                continue;
            }
            foreach ($row['columns'] as $column) {
                if (empty($column['elements']) || !is_array($column['elements'])) {
                    continue;
                }
                foreach ($column['elements'] as $element) {
                    $field_id = $element['fieldId'] ?? null;
                    if (!$field_id) { // Skip if element has no fieldId
                        continue;
                    }

                    $placeholder = '{' . $field_id . '}';
                    $value_to_substitute = ''; // Default to empty string if field not submitted

                    if (isset($submitted_fields[$field_id])) {
                        $submitted_value = $submitted_fields[$field_id];
                        $element_type = $element['type'] ?? 'text-input';

                        switch ($element_type) {
                            case 'select':
                            case 'radio-button':
                                $options = $element['options'] ?? [];
                                $found_option_text = false;
                                foreach ($options as $option) {
                                    if (isset($option['value']) && $option['value'] == $submitted_value) { // Use == for loose comparison
                                        $value_to_substitute = $option['text'] ?? $submitted_value;
                                        $found_option_text = true;
                                        break;
                                    }
                                }
                                if (!$found_option_text) {
                                    $value_to_substitute = $submitted_value; // Fallback to raw value if no matching option text found
                                }
                                break;

                            case 'checkbox':
                                // Handle both array and single/comma-separated string value for robustness.
                                $submitted_values_array = [];
                                if (is_array($submitted_value)) {
                                    $submitted_values_array = $submitted_value;
                                } elseif (is_string($submitted_value) && !empty($submitted_value)) {
                                    // This handles both a single value string and a comma-separated string
                                    $submitted_values_array = array_map('trim', explode(',', $submitted_value));
                                }

                                if (!empty($submitted_values_array)) {
                                    $labels_to_substitute = [];
                                    $options = $element['options'] ?? [];
                                    // Loop through submitted values and find their corresponding display text.
                                    foreach ($submitted_values_array as $val) {
                                        $found_text = false;
                                        foreach ($options as $option) {
                                            if (isset($option['value']) && $option['value'] == $val) { // Use == for loose comparison
                                                $labels_to_substitute[] = $option['text'] ?? $val;
                                                $found_text = true;
                                                break;
                                            }
                                        }
                                        if (!$found_text) {
                                            $labels_to_substitute[] = $val; // Fallback to the raw value
                                        }
                                    }
                                    $value_to_substitute = implode(', ', $labels_to_substitute);
                                } else {
                                    // If nothing is selected, substitute with an empty string.
                                    $value_to_substitute = '';
                                }
                                break;

                            default: // 'text-input', 'textarea', 'file-upload' etc.
                                $value_to_substitute = $submitted_value;
                                break;
                        }
                    }

                    // Replace placeholder in the prompt with the determined value.
                    // This will also replace with '' if the field wasn't submitted, effectively removing the placeholder.
                    $final_prompt = str_replace($placeholder, $value_to_substitute, $final_prompt);
                }
            }
        }
    }

    // Handle the legacy/simple case where a single 'user_input' is expected
    // This is less likely with the new structure but good for backward compatibility
    if (empty($form_structure) && isset($submitted_fields['user_input'])) {
        $final_prompt = str_replace('{user_input}', $submitted_fields['user_input'], $final_prompt);
    }

    return $final_prompt;
}

