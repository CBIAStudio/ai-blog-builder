================================================================================
FUNCION: __construct
Resumen: Función que maneja $human.
CODIGO:
function __construct()
    {
        global $wpdb;
        $this->wpdb = $wpdb;
        $this->log_table_name = $wpdb->prefix . 'aipkit_chat_logs'; // Table name remains the same
    }

================================================================================
FUNCION: estimate_volume
Resumen: Función que maneja $human.
CODIGO:
function estimate_volume(int $start_ts, int $end_ts): array|WP_Error
    {
        // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- Using prepare with timestamps
        $sql = $this->wpdb->prepare(
            "SELECT COUNT(*) AS cnt, COALESCE(SUM(CHAR_LENGTH(messages)), 0) AS total_bytes FROM {$this->log_table_name} WHERE last_message_ts >= %d AND last_message_ts <= %d",
            $start_ts,
            $end_ts
        );
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.PreparedSQL.NotPrepared, PluginCheck.Security.DirectDB.UnescapedDBParameter
        $row = $this->wpdb->get_row($sql, ARRAY_A);
        if ($this->wpdb->last_error) {
            return new WP_Error('db_query_error', __('Database error estimating log volume for stats.', 'gpt3-ai-content-generator'));
        }
        $rows  = isset($row['cnt']) ? (int) $row['cnt'] : 0;
        $bytes = isset($row['total_bytes']) ? (int) $row['total_bytes'] : 0;
        return ['rows' => $rows, 'bytes' => $bytes];
    }

================================================================================
FUNCION: get_token_stats_last_days
Resumen: Función que maneja $human.
CODIGO:
function get_token_stats_last_days(int $days = 30): array|WP_Error
    {
        if ($days <= 0) {
            return new WP_Error('invalid_days', __('Number of days must be positive.', 'gpt3-ai-content-generator'));
        }

        $wp_timezone = wp_timezone();
        $end_datetime = new DateTime('now', $wp_timezone);
        $start_datetime = new DateTime("-$days days", $wp_timezone);
        $start_datetime->setTime(0, 0, 0);

        $timestamp_threshold_start = $start_datetime->getTimestamp();
        $timestamp_threshold_end = $end_datetime->getTimestamp();

        // Guardrail: estimate volume and bail out if too heavy
        $vol = $this->estimate_volume($timestamp_threshold_start, $timestamp_threshold_end);
        if (is_wp_error($vol)) {
            return $vol;
        }
        $max_bytes = (int) apply_filters('aipkit_stats_max_bytes', self::DEFAULT_MAX_BYTES_FOR_STATS);
        $max_rows  = (int) apply_filters('aipkit_stats_max_rows', self::DEFAULT_MAX_ROWS_FOR_STATS);
        
        if ($vol['rows'] > $max_rows || $vol['bytes'] > $max_bytes) {
            return new WP_Error(
                'stats_volume_too_large',
                sprintf(
                    /* translators: 1: number of rows, 2: number of bytes */
                    __('Usage data volume is too large to compute statistics right now (rows: %1$s, bytes: %2$s). Try reducing retention or disabling conversation storage.', 'gpt3-ai-content-generator'),
                    number_format_i18n($vol['rows']),
                    size_format($vol['bytes'])
                ),
                [ 'rows' => (int) $vol['rows'], 'bytes' => (int) $vol['bytes'] ]
            );
        }

        // Query to fetch conversation logs within the date range based on last_message_ts
        // Select 'messages' and 'module' columns
        // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- Reason: Using prepare to safely insert timestamps
        $query = $this->wpdb->prepare("SELECT messages, module FROM {$this->log_table_name} WHERE last_message_ts >= %d AND last_message_ts <= %d", $timestamp_threshold_start, $timestamp_threshold_end);

        // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared, PluginCheck.Security.DirectDB.UnescapedDBParameter -- Reason: Using prepare to safely insert timestamps
        $results = $this->wpdb->get_results($query, ARRAY_A);

        if ($this->wpdb->last_error) {
            return new WP_Error('db_query_error', __('Database error fetching logs for stats.', 'gpt3-ai-content-generator'));
        }

        $total_tokens = 0;
        $total_interactions = count($results); // Count each log row as an interaction/conversation
        $module_counts = []; // Count how many interactions per module

        if ($total_interactions > 0) {
            foreach ($results as $row) {
                $module_name = !empty($row['module']) ? $row['module'] : 'unknown';
                $messages_json = $row['messages'] ?? '[]';
                $conversation_data = json_decode($messages_json, true);
                $messages_array = null;

                // Handle new/old structure
                if (is_array($conversation_data) && isset($conversation_data['messages']) && is_array($conversation_data['messages'])) {
                    $messages_array = $conversation_data['messages'];
                } elseif (is_array($conversation_data)) {
                    $messages_array = $conversation_data; // Backward compat
                }

                if (is_array($messages_array)) {
                    foreach ($messages_array as $msg) {
                        // Sum tokens from bot messages or wherever usage is logged
                        $tokens_in_message = 0;
                        if (isset($msg['usage']['total_tokens']) && is_numeric($msg['usage']['total_tokens'])) {
                            $tokens_in_message = (int) $msg['usage']['total_tokens'];
                        } elseif (isset($msg['usage']['totalTokenCount']) && is_numeric($msg['usage']['totalTokenCount'])) { // Google compatibility
                            $tokens_in_message = (int) $msg['usage']['totalTokenCount'];
                        }
                        $total_tokens += $tokens_in_message;
                    }
                }
                // Count the interaction for this module
                $module_counts[$module_name] = ($module_counts[$module_name] ?? 0) + 1;

            } // End foreach $results
        } // End if $total_interactions

        $avg_tokens_per_interaction = ($total_interactions > 0) ? round($total_tokens / $total_interactions) : 0;
        arsort($module_counts); // Sort modules by interaction count descending

        return [
            'total_tokens' => $total_tokens,
            'total_interactions' => $total_interactions, // Renamed from total_conversations
            'avg_tokens_per_interaction' => $avg_tokens_per_interaction, // Renamed
            'module_counts' => $module_counts, // Interaction counts per module
            'days_period' => $days,
        ];
    }

================================================================================
FUNCION: get_daily_token_stats
Resumen: Función que maneja $human.
CODIGO:
function get_daily_token_stats(int $days = 30): array|WP_Error
    {
        if ($days <= 0) {
            return new WP_Error('invalid_days', __('Number of days must be positive.', 'gpt3-ai-content-generator'));
        }

        $wp_timezone = wp_timezone();
        $end_datetime = new DateTime('now', $wp_timezone);
        $start_datetime = new DateTime("-$days days", $wp_timezone);
        $start_datetime->setTime(0, 0, 0);

        $timestamp_threshold_start = $start_datetime->getTimestamp();
        $timestamp_threshold_end = $end_datetime->getTimestamp();

        // Guardrail: estimate volume and bail out if too heavy
        $vol = $this->estimate_volume($timestamp_threshold_start, $timestamp_threshold_end);
        if (is_wp_error($vol)) {
            return $vol;
        }
        $max_bytes = (int) apply_filters('aipkit_stats_max_bytes', self::DEFAULT_MAX_BYTES_FOR_STATS);
        $max_rows  = (int) apply_filters('aipkit_stats_max_rows', self::DEFAULT_MAX_ROWS_FOR_STATS);
        
        if ($vol['rows'] > $max_rows || $vol['bytes'] > $max_bytes) {
            return new WP_Error(
                'stats_volume_too_large',
                sprintf(
                    /* translators: 1: number of rows, 2: number of bytes */
                    __('Usage data volume is too large to compute daily chart (rows: %1$s, bytes: %2$s). Try reducing retention or disabling conversation storage.', 'gpt3-ai-content-generator'),
                    number_format_i18n($vol['rows']),
                    size_format($vol['bytes'])
                ),
                [ 'rows' => (int) $vol['rows'], 'bytes' => (int) $vol['bytes'] ]
            );
        }

        // Fetch logs within the range, including 'module' and 'messages'

        // Fetch logs within the range, including 'module' and 'messages'
        // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- Reason: Using prepare to safely insert timestamps
        $query = $this->wpdb->prepare("SELECT messages, module FROM {$this->log_table_name} WHERE last_message_ts >= %d AND last_message_ts <= %d", $timestamp_threshold_start, $timestamp_threshold_end);
        // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared, PluginCheck.Security.DirectDB.UnescapedDBParameter -- Reason: Using prepare to safely insert timestamps
        $results = $this->wpdb->get_results($query, ARRAY_A);

        if ($this->wpdb->last_error) {
            return new WP_Error('db_query_error', __('Database error fetching logs for daily stats.', 'gpt3-ai-content-generator'));
        }

        // --- Phase 1: Aggregate ALL daily tokens per module and total tokens per module ---
        $daily_tokens_all = [];
        $total_module_tokens = []; // Stores total tokens for each module across the period

        // Initialize all days in the period
        $current_date = clone $start_datetime;
        while ($current_date <= $end_datetime) {
            $daily_tokens_all[$current_date->format('Y-m-d')] = [];
            $current_date->modify('+1 day');
        }

        if (!empty($results)) {
            foreach ($results as $row) {
                $module_name = !empty($row['module']) ? $row['module'] : 'unknown';
                $messages_json = $row['messages'] ?? '[]';
                $conversation_data = json_decode($messages_json, true);
                $messages_array = null;
                if (is_array($conversation_data) && isset($conversation_data['messages']) && is_array($conversation_data['messages'])) {
                    $messages_array = $conversation_data['messages'];
                } elseif (is_array($conversation_data)) {
                    $messages_array = $conversation_data;
                }

                if (is_array($messages_array)) {
                    foreach ($messages_array as $msg) {
                        // Use timestamp of the individual message for daily grouping
                        if (isset($msg['timestamp']) && is_numeric($msg['timestamp'])) {
                            $message_timestamp = (int)$msg['timestamp'];
                            // Ensure message is within the overall date range (redundant check, but safe)
                            if ($message_timestamp < $timestamp_threshold_start || $message_timestamp > $timestamp_threshold_end) {
                                continue;
                            }

                            $message_date = new DateTime('@' . $message_timestamp);
                            $message_date->setTimezone($wp_timezone);
                            $date_key = $message_date->format('Y-m-d');

                            // Sum tokens for this message
                            $tokens_in_message = 0;
                            if (isset($msg['usage']['total_tokens']) && is_numeric($msg['usage']['total_tokens'])) {
                                $tokens_in_message = (int) $msg['usage']['total_tokens'];
                            } elseif (isset($msg['usage']['totalTokenCount']) && is_numeric($msg['usage']['totalTokenCount'])) {
                                $tokens_in_message = (int) $msg['usage']['totalTokenCount'];
                            }

                            if ($tokens_in_message > 0) {
                                // Add to daily count FOR THE MODULE
                                if (isset($daily_tokens_all[$date_key])) {
                                    $daily_tokens_all[$date_key][$module_name] = ($daily_tokens_all[$date_key][$module_name] ?? 0) + $tokens_in_message;
                                }
                                // Add to overall module total
                                $total_module_tokens[$module_name] = ($total_module_tokens[$module_name] ?? 0) + $tokens_in_message;
                            }
                        } // End timestamp check
                    } // End foreach message
                }
            } // End foreach result row
        } // End if results

        // --- Phase 2: Identify Top N modules ---
        arsort($total_module_tokens); // Sort modules by total usage descending
        $top_n_modules = array_slice(array_keys($total_module_tokens), 0, self::TOP_N_MODULES_FOR_CHART);
        $top_n_modules_set = array_flip($top_n_modules); // Use as a set for quick lookups

        // --- Phase 3: Create Filtered Daily Data with 'Other' category ---
        $filtered_daily_tokens = [];
        // Re-initialize all days
        $current_date = clone $start_datetime;
        while ($current_date <= $end_datetime) {
            $filtered_daily_tokens[$current_date->format('Y-m-d')] = [];
            $current_date->modify('+1 day');
        }

        foreach ($daily_tokens_all as $date => $modules_on_day) {
            $other_tokens_for_day = 0;
            foreach ($modules_on_day as $module => $tokens) {
                if (isset($top_n_modules_set[$module])) {
                    $filtered_daily_tokens[$date][$module] = $tokens;
                } else {
                    $other_tokens_for_day += $tokens;
                }
            }
            if ($other_tokens_for_day > 0) {
                $filtered_daily_tokens[$date]['Other'] = $other_tokens_for_day;
            }
        }

        ksort($filtered_daily_tokens); // Ensure outer array is sorted by date key

        return $filtered_daily_tokens;
    }

================================================================================
FUNCION: get_quick_interaction_stats
Resumen: Función que maneja $human.
CODIGO:
function get_quick_interaction_stats(int $days = 3): array|WP_Error
    {
        if ($days <= 0) {
            return new WP_Error('invalid_days', __('Number of days must be positive.', 'gpt3-ai-content-generator'));
        }

        $wp_timezone = wp_timezone();
        $end_datetime = new DateTime('now', $wp_timezone);
        $start_datetime = new DateTime("-$days days", $wp_timezone);
        $start_datetime->setTime(0, 0, 0);

        $timestamp_threshold_start = $start_datetime->getTimestamp();
        $timestamp_threshold_end = $end_datetime->getTimestamp();

        // Count total interactions
        // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- Using prepare with timestamps
        $count_sql = $this->wpdb->prepare(
            "SELECT COUNT(*) FROM {$this->log_table_name} WHERE last_message_ts >= %d AND last_message_ts <= %d",
            $timestamp_threshold_start,
            $timestamp_threshold_end
        );
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.PreparedSQL.NotPrepared, PluginCheck.Security.DirectDB.UnescapedDBParameter
        $total_interactions = (int) $this->wpdb->get_var($count_sql);
        if ($this->wpdb->last_error) {
            return new WP_Error('db_query_error', __('Database error fetching counts for quick stats.', 'gpt3-ai-content-generator'));
        }

        // Per-module counts
        // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- Using prepare with timestamps
        $group_sql = $this->wpdb->prepare(
            "SELECT COALESCE(module,'unknown') as module, COUNT(*) as cnt FROM {$this->log_table_name} WHERE last_message_ts >= %d AND last_message_ts <= %d GROUP BY module",
            $timestamp_threshold_start,
            $timestamp_threshold_end
        );
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.PreparedSQL.NotPrepared, PluginCheck.Security.DirectDB.UnescapedDBParameter
        $rows = $this->wpdb->get_results($group_sql, ARRAY_A) ?: [];
        if ($this->wpdb->last_error) {
            return new WP_Error('db_query_error', __('Database error fetching module counts for quick stats.', 'gpt3-ai-content-generator'));
        }
        $module_counts = [];
        foreach ($rows as $r) {
            $module = $r['module'] !== null && $r['module'] !== '' ? $r['module'] : 'unknown';
            $module_counts[$module] = (int) $r['cnt'];
        }
        arsort($module_counts);

        return [
            'total_interactions' => $total_interactions,
            'module_counts' => $module_counts,
            'days_period' => $days,
        ];
    }

================================================================================
FUNCION: get_most_used_module
Resumen: Función que maneja $human.
CODIGO:
function get_most_used_module(array $module_counts): ?string
    {
        if (empty($module_counts)) {
            return null;
        }
        // arsort($module_counts); // Ensure sorted (should be done in get_token_stats_last_days)
        $first_key = array_key_first($module_counts);
        if (!$first_key) {
            return null;
        }

        // Map known module slugs to user-facing names
        switch ($first_key) {
            case 'ai_post_enhancer':
                return __('Content Assistant', 'gpt3-ai-content-generator');
            default:
                // Format the module name nicely for display
                return ucfirst(str_replace(['-', '_'], ' ', $first_key));
        }
    }

================================================================================
FUNCION: is_pro_plan
Resumen: Función que maneja $human.
CODIGO:
function is_pro_plan()
        {
            if (function_exists('wpaicg_gacg_fs') && wpaicg_gacg_fs()->is_plan('pro', true)) {
                return true;
            }
            return false;
        }

================================================================================
FUNCION: init
Resumen: Función que maneja $human.
CODIGO:
function init()
        {
            // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Nonce is not applicable for page routing checks on this hook.
            $current_page = isset($_GET['page']) ? sanitize_key(wp_unslash($_GET['page'])) : '';

            if (
                (is_admin() && !empty($current_page) && (strpos($current_page, 'wpaicg') !== false || $current_page === 'aipkit-role-manager')) ||
                wp_doing_ajax()
            ) {
                self::check_and_init_module_settings();
                self::register_ajax_handlers();
            }
        }

================================================================================
FUNCION: register_ajax_handlers
Resumen: Función que maneja $human.
CODIGO:
function register_ajax_handlers()
        {
            add_action('wp_ajax_aipkit_dashboard_load_module', [__CLASS__, 'ajax_load_module']);
            add_action('wp_ajax_aipkit_update_module_setting', [__CLASS__, 'ajax_update_module_setting']);
            add_action('wp_ajax_aipkit_get_token_usage_chart_data', [__CLASS__, 'ajax_get_token_usage_chart_data']);
        }

================================================================================
FUNCION: check_and_init_module_settings
Resumen: Función que maneja $human.
CODIGO:
function check_and_init_module_settings()
        {
            // --- FIX: Safely retrieve options ---
            $opts = get_option('aipkit_options');
            if (!is_array($opts)) {
                $opts = [];
            }
            // --- END FIX ---

            if (!isset($opts['module_settings']) || !is_array($opts['module_settings'])) {
                $opts['module_settings'] = self::$default_module_settings;
                self::$module_settings = self::$default_module_settings;
                update_option('aipkit_options', $opts, 'no');
            } else {
                $merged = array_merge(self::$default_module_settings, $opts['module_settings']);
                $final_settings = array_intersect_key($merged, self::$default_module_settings);
                self::$module_settings = $final_settings;
                if ($final_settings !== $opts['module_settings']) {
                    $opts['module_settings'] = $final_settings;
                    update_option('aipkit_options', $opts, 'no');
                }
            }
        }

================================================================================
FUNCION: get_module_settings
Resumen: Función que maneja $human.
CODIGO:
function get_module_settings()
        {
            if (empty(self::$module_settings)) {
                self::check_and_init_module_settings();
            }
            return self::$module_settings;
        }

================================================================================
FUNCION: ajax_load_module
Resumen: Función que maneja $human.
CODIGO:
function ajax_load_module()
        {
            if (!isset($_REQUEST['_ajax_nonce']) || !wp_verify_nonce(sanitize_key($_REQUEST['_ajax_nonce']), 'aipkit_nonce')) {
                wp_send_json_error(['message' => __('Security check failed.', 'gpt3-ai-content-generator')], 403);
                return;
            }

            $module = isset($_REQUEST['module']) ? sanitize_key($_REQUEST['module']) : '';
            if (empty($module)) {
                wp_send_json_error(['message' => 'No module specified.'], 400);
                return;
            }
            if (!preg_match('/^[a-z0-9-]+$/', $module)) {
                wp_send_json_error(['message' => 'Invalid module name.'], 400);
                return;
            }

            if (!AIPKit_Role_Manager::user_can_access_module($module)) {
                wp_send_json_error(['message' => __('You do not have permission to access this module.', 'gpt3-ai-content-generator')], 403);
                return;
            }

            if ($module === 'chatbot') {
                if (!class_exists('\\WPAICG\\Chat\\Storage\\BotStorage') ||
                    !class_exists('\\WPAICG\\Chat\\Admin\\AdminSetup') ||
                    !class_exists('\\WPAICG\\Chat\\Storage\\DefaultBotSetup') ||
                    !class_exists('\\WPAICG\\Chat\\Storage\\SiteWideBotManager') ||
                    !class_exists('\\WPAICG\\Vector\\AIPKit_Vector_Store_Registry')) {
                }
            }

            $module_dir = WPAICG_PLUGIN_DIR . 'admin/views/modules/' . $module . '/';
            $module_file = $module_dir . 'index.php';

            $modules_base_path = realpath(untrailingslashit(WPAICG_PLUGIN_DIR . 'admin/views/modules'));
            $real_module_file_path = realpath($module_file);

            if ($modules_base_path === false || $real_module_file_path === false || strpos($real_module_file_path, $modules_base_path) !== 0) {
                wp_send_json_error(['message' => 'Invalid module path. Attempted path: ' . esc_html($module_file)], 400);
                return;
            }

            if (!file_exists($module_file)) {
                wp_send_json_error(['message' => "Module file not found: {$module} at " . esc_html($module_file)], 404);
                return;
            }

            $content = '';
            $php_error = null;
            // phpcs:ignore WordPress.PHP.DevelopmentFunctions.error_log_set_error_handler -- Used to gracefully catch fatal errors in included module view files.
            set_error_handler(function ($errno, $errstr, $errfile, $errline) use (&$php_error) {
                $php_error = new WP_Error('php_error_in_module_view', $errstr, [
                    'file' => basename($errfile),
                    'line' => $errline
                ]);
                return true;
            });

            ob_start();
            try {
                // Sanitize and define variables needed by specific modules here,
                // making them available to the included $module_file.
                // This avoids using $_REQUEST directly in view files and satisfies security scans.
                $force_active_bot_id = isset($_REQUEST['force_active_bot_id']) ? intval($_REQUEST['force_active_bot_id']) : 0;
                $force_active_tab = isset($_REQUEST['force_active_tab']) ? sanitize_key($_REQUEST['force_active_tab']) : '';

                include $module_file;
                $content = ob_get_clean();
            } catch (\Throwable $e) {
                if (ob_get_level() > 0) {
                    ob_end_clean();
                }
                $php_error = new WP_Error('fatal_error_in_module_view', $e->getMessage(), [
                     'file' => basename($e->getFile()), 'line' => $e->getLine()
                ]);
            }
            restore_error_handler();

            if ($php_error !== null) {
                $error_details = $php_error->get_error_message();
                if (is_array($php_error->get_error_data())) {
                    $error_details .= " (File: " . ($php_error->get_error_data()['file'] ?? 'unknown') . ", Line: " . ($php_error->get_error_data()['line'] ?? 'unknown') . ")";
                }
                wp_send_json_error([
                    'message' => 'A server error occurred while loading the module content. Please check the PHP error log for details.',
                    'debug_error' => $php_error->get_error_code() . ': ' . $php_error->get_error_message()
                ], 500);
                return;
            }
            if (headers_sent($file, $line)) {
                die();
            }


            $response_data = ['html' => $content];
            if ($module === 'chatbot' && class_exists(AIPKit_Vector_Store_Registry::class)) {
                $openai_vector_stores = AIPKit_Vector_Store_Registry::get_registered_stores_by_provider('OpenAI');
                $response_data['openaiVectorStores'] = $openai_vector_stores;
            }

            wp_send_json_success($response_data);
        }

================================================================================
FUNCION: ajax_update_module_setting
Resumen: Función que maneja $human.
CODIGO:
function ajax_update_module_setting()
        {
            if (!current_user_can('manage_options')) {
                wp_send_json_error(['message' => 'Unauthorized access.'], 403);
                return;
            }
            if (!isset($_POST['_ajax_nonce']) || !wp_verify_nonce(sanitize_key($_POST['_ajax_nonce']), 'aipkit_nonce')) {
                wp_send_json_error(['message' => 'Security check failed.'], 403);
                return;
            }

            $moduleKey = isset($_POST['moduleKey']) ? sanitize_key($_POST['moduleKey']) : '';
            $enabled   = isset($_POST['enabled']) ? sanitize_text_field(wp_unslash($_POST['enabled'])) : '';

            self::check_and_init_module_settings();

            if (empty($moduleKey) || !array_key_exists($moduleKey, self::$default_module_settings)) {
                wp_send_json_error(['message' => 'Invalid module key.'], 400);
                return;
            }

            $isEnabled = ($enabled === '1');
            self::$module_settings[$moduleKey] = $isEnabled;

            // --- FIX: Safely retrieve options before updating ---
            $opts = get_option('aipkit_options');
            if (!is_array($opts)) {
                $opts = [];
            }
            // --- END FIX ---

            $opts['module_settings'] = self::$module_settings;
            update_option('aipkit_options', $opts, 'no');

            wp_send_json_success(['message' => 'Module setting updated.']);
        }

================================================================================
FUNCION: ajax_get_token_usage_chart_data
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_token_usage_chart_data()
        {
            if (!AIPKit_Role_Manager::user_can_access_module('settings')) {
                wp_send_json_error(['message' => __('Unauthorized access.', 'gpt3-ai-content-generator')], 403);
                return;
            }
            if (!isset($_POST['_ajax_nonce']) || !wp_verify_nonce(sanitize_key($_POST['_ajax_nonce']), 'aipkit_nonce')) {
                wp_send_json_error(['message' => __('Security check failed.', 'gpt3-ai-content-generator')], 403);
                return;
            }

            // Optional period parameter (allowed: 3, 7, 14, 30, 90); default 3 to keep memory low
            $allowed_days = [3, 7, 14, 30, 90];
            $days = isset($_POST['days']) ? absint($_POST['days']) : 3;
            if (!in_array($days, $allowed_days, true)) {
                $days = 3;
            }
            $stats_class_name = '\\WPAICG\\Stats\\AIPKit_Stats';
            if (!class_exists($stats_class_name)) {
                wp_send_json_error(['message' => 'Statistics component unavailable.'], 500);
                return;
            }

            $stats_calculator = new $stats_class_name();
            $daily_data = $stats_calculator->get_daily_token_stats($days);

            if (is_wp_error($daily_data)) {
                if ($daily_data->get_error_code() === 'stats_volume_too_large') {
                    $data = $daily_data->get_error_data();
                    $rows = isset($data['rows']) ? (int) $data['rows'] : 0;
                    $bytes = isset($data['bytes']) ? (int) $data['bytes'] : 0;
                    $notice = sprintf(
                        /* translators: 1: rows, 2: size */
                        __('Usage data for the selected period is very large (rows: %1$s, size: %2$s). Showing no chart data. Consider reducing the period, pruning logs, or disabling conversation storage.', 'gpt3-ai-content-generator'),
                        number_format_i18n($rows),
                        size_format($bytes)
                    );
                    wp_send_json_success([
                        'daily_token_data' => new \stdClass(),
                        'notice' => $notice,
                        'volume' => ['rows' => $rows, 'bytes' => $bytes],
                        'days' => $days,
                        'manage_logs_url' => admin_url('admin.php?page=wpaicg#stats')
                    ]);
                } else {
                    wp_send_json_error(['message' => $daily_data->get_error_message()], 500);
                }
            } else {
                wp_send_json_success(['daily_token_data' => $daily_data]);
            }
        }

================================================================================
FUNCION: __construct
Resumen: Función que maneja $human.
CODIGO:
function __construct()
    {
        if (class_exists(\WPAICG\Core\AIPKit_AI_Caller::class)) {
            $this->ai_caller = new AIPKit_AI_Caller();
        }
        if (class_exists(\WPAICG\Vector\AIPKit_Vector_Store_Manager::class)) {
            $this->vector_store_manager = new AIPKit_Vector_Store_Manager();
        }
        if (class_exists(OpenAIPostProcessor::class)) {
            $this->openai_post_processor = new OpenAIPostProcessor();
        }
        if (class_exists(PineconePostProcessor::class)) {
            $this->pinecone_post_processor = new PineconePostProcessor();
        }
        if (class_exists(QdrantPostProcessor::class)) {
            $this->qdrant_post_processor = new QdrantPostProcessor();
        }
    }

================================================================================
FUNCION: ajax_get_upload_limits
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_upload_limits()
    {
        // Permission check: accept any valid nonce from AI Training UIs (global or provider-specific)
        $nonce_candidates = [
            'aipkit_nonce',
            'aipkit_vector_store_nonce_openai',
            'aipkit_vector_store_pinecone_nonce',
            'aipkit_vector_store_qdrant_nonce',
        ];
        $has_permission = false;
        $last_error = null;
        foreach ($nonce_candidates as $nonce_field) {
            $check = $this->check_any_module_access_permissions(['sources', 'chatbot'], $nonce_field);
            if (!is_wp_error($check)) { $has_permission = true; break; }
            $last_error = $check;
        }
        if (!$has_permission) {
            $this->send_wp_error($last_error ?: new WP_Error('forbidden', __('Permission denied.', 'gpt3-ai-content-generator')));
            return;
        }

        if (class_exists(\WPAICG\Includes\AIPKit_Upload_Utils::class)) {
            $limits = AIPKit_Upload_Utils::get_upload_limits();
            wp_send_json_success($limits);
        } else {
            wp_send_json_error(['message' => __('Upload utility not available.', 'gpt3-ai-content-generator')], 500);
        }
    }

================================================================================
FUNCION: ajax_generate_embedding
Resumen: Función que maneja $human.
CODIGO:
function ajax_generate_embedding()
    {
        // Permission Check: Users who can access Sources or AI Training can generate embeddings.
        // Use the main dashboard nonce 'aipkit_nonce' for this core utility.
        $permission_check = $this->check_any_module_access_permissions(
            ['sources', 'chatbot'],
            'aipkit_nonce'
        );
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }
        
        // Unslash the POST array at once.
        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce is checked by check_module_access_permissions().
        $post_data = wp_unslash($_POST);
        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce is checked by check_module_access_permissions().
        $content_to_embed = isset($post_data['content_to_embed']) ? wp_kses_post($post_data['content_to_embed']) : '';
        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce is checked by check_module_access_permissions().
        $embedding_provider_key = isset($post_data['embedding_provider']) ? sanitize_key($post_data['embedding_provider']) : '';
        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce is checked by check_module_access_permissions().
        $embedding_model = isset($post_data['embedding_model']) ? sanitize_text_field($post_data['embedding_model']) : '';

        if (empty($content_to_embed)) {
            $this->send_wp_error(new WP_Error('missing_content', __('Content to embed cannot be empty.', 'gpt3-ai-content-generator')));
            return;
        }
        if (empty($embedding_provider_key)) {
            $this->send_wp_error(new WP_Error('missing_embedding_provider', __('Embedding provider is required.', 'gpt3-ai-content-generator')));
            return;
        }
        if (empty($embedding_model)) {
            $this->send_wp_error(new WP_Error('missing_embedding_model', __('Embedding model is required.', 'gpt3-ai-content-generator')));
            return;
        }

        // Normalize provider name
        $provider_map = ['openai' => 'OpenAI', 'google' => 'Google', 'azure' => 'Azure'];
        $embedding_provider = $provider_map[$embedding_provider_key] ?? '';

        if (empty($embedding_provider)) {
             $this->send_wp_error(new WP_Error('invalid_embedding_provider', __('Invalid embedding provider specified.', 'gpt3-ai-content-generator')));
             return;
        }

        if (!class_exists(\WPAICG\Core\AIPKit_AI_Caller::class)) {
            $this->send_wp_error(new WP_Error('internal_error_embedding', __('Embedding service component not available.', 'gpt3-ai-content-generator')));
            return;
        }

        $ai_caller = new AIPKit_AI_Caller();
        $embedding_options = ['model' => $embedding_model];

        $result = $ai_caller->generate_embeddings($embedding_provider, $content_to_embed, $embedding_options);

        if (is_wp_error($result)) {
            $this->send_wp_error($result);
        } else {
            wp_send_json_success($result);
        }
    }

================================================================================
FUNCION: ajax_delete_vector_data_source_entry
Resumen: Función que maneja $human.
CODIGO:
function ajax_delete_vector_data_source_entry()
    {
        $permission_check = $this->check_any_module_access_permissions(
            ['sources', 'chatbot'],
            'aipkit_nonce'
        );
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce is checked above.
        $post_data = wp_unslash($_POST);

        // --- START FIX: Use sanitize_text_field to preserve case and add validation ---
        $provider_raw = isset($post_data['provider']) ? sanitize_text_field($post_data['provider']) : '';
        $allowed_providers = ['OpenAI', 'Pinecone', 'Qdrant']; // <-- FIX: Added 'OpenAI'
        if (!in_array($provider_raw, $allowed_providers, true)) {
            $this->send_wp_error(new WP_Error('invalid_provider_delete_vector', __('Invalid or unsupported provider for this action.', 'gpt3-ai-content-generator')));
            return;
        }
        $provider = $provider_raw;
        // --- END FIX ---
        
        $store_id   = isset($post_data['store_id']) ? sanitize_text_field($post_data['store_id']) : '';
        $vector_id  = isset($post_data['vector_id']) ? sanitize_text_field($post_data['vector_id']) : '';
        $log_entry_id = isset($post_data['log_id']) ? absint($post_data['log_id']) : 0;

        if (empty($provider) || empty($store_id) || empty($vector_id) || empty($log_entry_id)) {
            $this->send_wp_error(new WP_Error('missing_params_delete_vector', __('Missing required parameters for vector deletion.', 'gpt3-ai-content-generator')));
            return;
        }

        // Ensure Vector Store Manager is loaded
        if (!class_exists('\\WPAICG\\Vector\\AIPKit_Vector_Store_Manager')) {
             $this->send_wp_error(new WP_Error('vsm_missing_delete_vector', __('Vector management component is not available.', 'gpt3-ai-content-generator')));
             return;
        }
        $vector_store_manager = new \WPAICG\Vector\AIPKit_Vector_Store_Manager();

        // Get provider config
        $provider_config = \WPAICG\AIPKit_Providers::get_provider_data($provider);
        if (empty($provider_config['api_key'])) {
            /* translators: %s: Provider name. */
             $this->send_wp_error(new WP_Error('missing_api_key_delete_vector', sprintf(__('API key for %s is missing.', 'gpt3-ai-content-generator'), $provider)));
             return;
        }

        // 1. Delete from external vector store
        $delete_result = $vector_store_manager->delete_vectors($provider, $store_id, [$vector_id], $provider_config);
        
        // We proceed even if the external deletion fails, as the vector might not exist there anymore but the log does.
        // We will log the error if one occurs.
        if (is_wp_error($delete_result)) {
            // This is not a fatal error for the process, so we just log it and continue to delete from local DB.
        }

        // 2. Delete from local database log
        global $wpdb;
        $data_source_table_name = $wpdb->prefix . 'aipkit_vector_data_source';
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching -- Custom table delete for admin action.
        $deleted_rows = $wpdb->delete(
            $data_source_table_name,
            ['id' => $log_entry_id],
            ['%d']
        );

        if ($deleted_rows === false) {
             $this->send_wp_error(new WP_Error('db_delete_failed_vector_log', __('Failed to delete the log entry from the local database.', 'gpt3-ai-content-generator')));
             return;
        }
        if ($deleted_rows === 0) {
            // This could mean it was already deleted, which is a success state for the user.
            wp_send_json_success(['message' => __('Log entry was not found, it might have been already deleted.', 'gpt3-ai-content-generator')]);
            return;
        }

        wp_send_json_success(['message' => __('Vector record and log entry deleted successfully.', 'gpt3-ai-content-generator')]);
    }

================================================================================
FUNCION: ajax_reindex_vector_data_source_entry
Resumen: Función que maneja $human.
CODIGO:
function ajax_reindex_vector_data_source_entry() {
        $permission_check = $this->check_any_module_access_permissions(
            ['sources', 'chatbot'],
            'aipkit_nonce'
        );
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // Sanitize all inputs
        $post_data = wp_unslash($_POST);
        $provider = isset($post_data['provider']) ? sanitize_text_field($post_data['provider']) : '';
        $store_id = isset($post_data['store_id']) ? sanitize_text_field($post_data['store_id']) : '';
        $vector_id = isset($post_data['vector_id']) ? sanitize_text_field($post_data['vector_id']) : '';
        $log_id = isset($post_data['log_id']) ? absint($post_data['log_id']) : 0;
        $post_id = isset($post_data['post_id']) ? absint($post_data['post_id']) : 0;
        $embedding_provider = isset($post_data['embedding_provider']) ? sanitize_key($post_data['embedding_provider']) : '';
        $embedding_model = isset($post_data['embedding_model']) ? sanitize_text_field($post_data['embedding_model']) : '';

        // Validate required parameters
        if (empty($provider) || empty($store_id) || empty($vector_id) || empty($log_id) || empty($post_id)) {
            $this->send_wp_error(new WP_Error('missing_params_reindex', __('Missing required parameters for re-indexing.', 'gpt3-ai-content-generator')));
            return;
        }

        // Validate dependencies
        if (!$this->vector_store_manager || !$this->openai_post_processor || !$this->pinecone_post_processor || !$this->qdrant_post_processor) {
            $this->send_wp_error(new WP_Error('vsm_missing_reindex', __('Vector processing components are not available.', 'gpt3-ai-content-generator')));
            return;
        }

        // Step 1: Delete the existing vector and log entry
        $provider_config = AIPKit_Providers::get_provider_data($provider);
        if (empty($provider_config['api_key'])) {
            /* translators: %s: Provider name. */
             $this->send_wp_error(new WP_Error('missing_api_key_reindex', sprintf(__('API key for %s is missing.', 'gpt3-ai-content-generator'), $provider)));
             return;
        }
        $delete_result = $this->vector_store_manager->delete_vectors($provider, $store_id, [$vector_id], $provider_config);
        if (is_wp_error($delete_result)) {
            // Log this but don't fail, as the vector might already be gone from the remote.
        }

        global $wpdb;
        $data_source_table_name = $wpdb->prefix . 'aipkit_vector_data_source';
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching -- Custom table delete for admin action.
        $wpdb->delete($data_source_table_name, ['id' => $log_id], ['%d']);

        // Step 2: Re-index the post
        $reindex_result = null;
        switch ($provider) {
            case 'OpenAI':
                $reindex_result = $this->openai_post_processor->index_single_post_to_store($post_id, $store_id);
                break;
            case 'Pinecone':
                if (empty($embedding_provider) || empty($embedding_model)) {
                    $this->send_wp_error(new WP_Error('missing_embedding_config_reindex', __('Embedding provider and model are required for Pinecone re-indexing.', 'gpt3-ai-content-generator')));
                    return;
                }
                $reindex_result = $this->pinecone_post_processor->index_single_post_to_index($post_id, $store_id, $embedding_provider, $embedding_model);
                break;
            case 'Qdrant':
                if (empty($embedding_provider) || empty($embedding_model)) {
                    $this->send_wp_error(new WP_Error('missing_embedding_config_reindex', __('Embedding provider and model are required for Qdrant re-indexing.', 'gpt3-ai-content-generator')));
                    return;
                }
                $reindex_result = $this->qdrant_post_processor->index_single_post_to_collection($post_id, $store_id, $embedding_provider, $embedding_model);
                break;
            default:
                $this->send_wp_error(new WP_Error('invalid_provider_reindex', __('Invalid provider for re-indexing.', 'gpt3-ai-content-generator')));
                return;
        }

        if (isset($reindex_result['status']) && $reindex_result['status'] === 'success') {
            wp_send_json_success(['message' => __('Content successfully re-indexed.', 'gpt3-ai-content-generator')]);
        } else {
            $error_message = $reindex_result['message'] ?? __('An unknown error occurred during re-indexing.', 'gpt3-ai-content-generator');
            $this->send_wp_error(new WP_Error('reindex_failed', 'Re-indexing failed: ' . $error_message));
        }
    }

================================================================================
FUNCION: ajax_get_global_vector_sources
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_global_vector_sources()
    {
        $permission_check = $this->check_module_access_permissions('sources', 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce is checked above.
        $post_data = wp_unslash($_POST);

        $provider_map = $this->get_vector_source_provider_map();
        $filters = $this->get_vector_sources_filters($post_data, $provider_map);
        [$where_sql, $params] = $this->build_vector_sources_where($filters);

        global $wpdb;
        $table_name = $wpdb->prefix . 'aipkit_vector_data_source';
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching, WordPress.DB.PreparedSQL.InterpolatedNotPrepared, PluginCheck.Security.DirectDB.UnescapedDBParameter -- $table_name is safe.
        $total_logs = (int) $wpdb->get_var($wpdb->prepare("SELECT COUNT(*) FROM {$table_name} WHERE {$where_sql}", $params));

        $logs_params = array_merge($params, [$filters['per_page'], $filters['offset']]);
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching, WordPress.DB.PreparedSQL.InterpolatedNotPrepared, PluginCheck.Security.DirectDB.UnescapedDBParameter -- $table_name is safe.
        $logs = $wpdb->get_results(
            $wpdb->prepare(
                "SELECT id, timestamp, provider, status, message, indexed_content, post_id, post_title, file_id, batch_id, embedding_provider, embedding_model, vector_store_id, vector_store_name FROM {$table_name} WHERE {$where_sql} ORDER BY timestamp DESC LIMIT %d OFFSET %d",
                $logs_params
            ),
            ARRAY_A
        );

        $total_pages = $filters['per_page'] > 0 ? (int) ceil($total_logs / $filters['per_page']) : 0;

        wp_send_json_success([
            'logs' => $logs ?: [],
            'pagination' => [
                'total_logs' => $total_logs,
                'total_pages' => $total_pages,
                'current_page' => $filters['page'],
            ],
            'providers' => $this->get_available_vector_source_providers($provider_map),
        ]);
    }

================================================================================
FUNCION: get_vector_source_provider_map
Resumen: Función que maneja $human.
CODIGO:
function get_vector_source_provider_map(): array
    {
        return [
            'openai' => 'OpenAI',
            'pinecone' => 'Pinecone',
            'qdrant' => 'Qdrant',
        ];
    }

================================================================================
FUNCION: get_vector_sources_filters
Resumen: Función que maneja $human.
CODIGO:
function get_vector_sources_filters(array $post_data, array $provider_map): array
    {
        $page = isset($post_data['page']) ? max(1, absint($post_data['page'])) : 1;
        $per_page = isset($post_data['per_page']) ? absint($post_data['per_page']) : 10;
        $per_page = min(50, max(1, $per_page));

        $provider_key = isset($post_data['provider']) ? sanitize_key($post_data['provider']) : '';
        $provider_label = $provider_key && isset($provider_map[$provider_key]) ? $provider_map[$provider_key] : '';

        $status_filter = isset($post_data['status']) ? sanitize_key($post_data['status']) : '';
        $allowed_statuses = ['indexed', 'failed', 'processing', 'queued', 'skipped_already_indexed', 'success'];
        if ($status_filter && !in_array($status_filter, $allowed_statuses, true)) {
            $status_filter = '';
        }

        $type_filter = isset($post_data['type']) ? sanitize_key($post_data['type']) : '';
        $allowed_types = ['site', 'text', 'file'];
        if ($type_filter && !in_array($type_filter, $allowed_types, true)) {
            $type_filter = '';
        }

        $general_settings = get_option('aipkit_training_general_settings', []);
        $hide_user_uploads = isset($general_settings['hide_user_uploads'])
            ? (bool) $general_settings['hide_user_uploads']
            : true;

        return [
            'page' => $page,
            'per_page' => $per_page,
            'offset' => ($page - 1) * $per_page,
            'provider_label' => $provider_label,
            'status' => $status_filter,
            'type' => $type_filter,
            'search' => isset($post_data['search']) ? sanitize_text_field($post_data['search']) : '',
            'store_id' => isset($post_data['store_id']) ? sanitize_text_field($post_data['store_id']) : '',
            'hide_user_uploads' => $hide_user_uploads,
        ];
    }

================================================================================
FUNCION: build_vector_sources_where
Resumen: Función que maneja $human.
CODIGO:
function build_vector_sources_where(array $filters): array
    {
        global $wpdb;

        $where_clauses = ['(post_id IS NOT NULL OR file_id IS NOT NULL OR indexed_content IS NOT NULL)'];
        $params = [];

        if (!empty($filters['provider_label'])) {
            $where_clauses[] = 'provider = %s';
            $params[] = $filters['provider_label'];
        }

        if (!empty($filters['status'])) {
            if ($filters['status'] === 'processing') {
                $where_clauses[] = '(status = %s OR status = %s)';
                $params[] = 'processing';
                $params[] = 'queued';
            } elseif ($filters['status'] === 'indexed') {
                $where_clauses[] = '(status = %s OR status = %s OR status = %s)';
                $params[] = 'indexed';
                $params[] = 'skipped_already_indexed';
                $params[] = 'success';
            } else {
                $where_clauses[] = 'status = %s';
                $params[] = $filters['status'];
            }
        }

        if (!empty($filters['type'])) {
            if ($filters['type'] === 'site') {
                $where_clauses[] = '(' . implode(' OR ', [
                    '(post_id IS NOT NULL)',
                    '(message LIKE %s)',
                    '(file_id LIKE %s)',
                    '(provider = %s AND message LIKE %s AND message LIKE %s)',
                ]) . ')';
                $params[] = '%wordpress post content submitted for indexing%';
                $params[] = 'wp_post_%';
                $params[] = 'Qdrant';
                $params[] = '%points upserted to qdrant%';
                $params[] = '%post id:%';
            } elseif ($filters['type'] === 'text') {
                $where_clauses[] = '(' . implode(' OR ', [
                    '(message LIKE %s)',
                    '(file_id LIKE %s)',
                    '(provider = %s AND message LIKE %s AND (post_id IS NULL OR post_id = 0) AND message NOT LIKE %s)',
                ]) . ')';
                $params[] = '%text content submitted for indexing%';
                $params[] = 'text_%';
                $params[] = 'Qdrant';
                $params[] = '%points upserted to qdrant%';
                $params[] = '%post id:%';
            } elseif ($filters['type'] === 'file') {
                $where_clauses[] = '(' . implode(' OR ', [
                    '(message LIKE %s)',
                    '(message LIKE %s)',
                    '(message LIKE %s)',
                    '(message LIKE %s)',
                    '(file_id LIKE %s)',
                ]) . ')';
                $params[] = '%file content submitted for indexing%';
                $params[] = '%file content embedded and upserted%';
                $params[] = '%original filename:%';
                $params[] = '%file uploaded%';
                $params[] = 'pinecone_file_%';
            }
        }

        if (!empty($filters['hide_user_uploads'])) {
            $where_clauses[] = 'NOT (' . implode(' OR ', [
                '(provider = %s AND COALESCE(vector_store_name, \'\') LIKE %s)',
                '(provider = %s AND COALESCE(file_id, \'\') LIKE %s)',
                '(provider = %s AND (COALESCE(batch_id, \'\') LIKE %s OR COALESCE(file_id, \'\') LIKE %s))',
            ]) . ')';
            $params[] = 'OpenAI';
            $params[] = 'chat_file_%';
            $params[] = 'Pinecone';
            $params[] = 'chatfile_%';
            $params[] = 'Qdrant';
            $params[] = 'qdrant_chat_file_%';
            $params[] = 'qdrant_chat_file_%';
        }

        if (!empty($filters['search'])) {
            $like = '%' . $wpdb->esc_like($filters['search']) . '%';
            $where_clauses[] = '(message LIKE %s OR post_title LIKE %s OR file_id LIKE %s OR vector_store_name LIKE %s OR indexed_content LIKE %s)';
            $params = array_merge($params, array_fill(0, 5, $like));
        }

        if (!empty($filters['store_id'])) {
            $where_clauses[] = 'vector_store_id = %s';
            $params[] = $filters['store_id'];
        }

        return [implode(' AND ', $where_clauses), $params];
    }

================================================================================
FUNCION: get_available_vector_source_providers
Resumen: Función que maneja $human.
CODIGO:
function get_available_vector_source_providers(array $provider_map): array
    {
        global $wpdb;
        $table_name = $wpdb->prefix . 'aipkit_vector_data_source';

        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching -- Distinct providers from custom table.
        $provider_labels = $wpdb->get_col("SELECT DISTINCT provider FROM {$table_name} WHERE provider <> ''");
        $provider_labels = array_filter(array_map('sanitize_text_field', (array) $provider_labels));

        if (empty($provider_labels)) {
            $provider_labels = array_values($provider_map);
        }

        $providers = [];
        foreach ($provider_map as $key => $label) {
            if (in_array($label, $provider_labels, true)) {
                $providers[] = [
                    'key' => $key,
                    'label' => $label,
                ];
            }
        }

        return $providers;
    }

================================================================================
FUNCION: ajax_get_chunk_logs_by_batch
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_chunk_logs_by_batch()
    {
        $permission_check = $this->check_any_module_access_permissions(['sources', 'chatbot'], 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        global $wpdb;
        $table = $wpdb->prefix . 'aipkit_vector_data_source';
        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- already checked
        $post = wp_unslash($_POST);
        $provider = isset($post['provider']) ? sanitize_text_field($post['provider']) : '';
        $store_id = isset($post['store_id']) ? sanitize_text_field($post['store_id']) : '';
        $batch_id = isset($post['batch_id']) ? sanitize_text_field($post['batch_id']) : '';
        $page = isset($post['page']) ? max(1, absint($post['page'])) : 1;
        $per_page = isset($post['per_page']) ? min(50, max(1, absint($post['per_page']))) : 10;

        if (!$provider || !$store_id || !$batch_id) {
            $this->send_wp_error(new \WP_Error('missing_params_chunk_logs', __('Missing provider, store_id or batch_id.', 'gpt3-ai-content-generator')));
            return;
        }

        $offset = ($page - 1) * $per_page;
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching, WordPress.DB.PreparedSQL.InterpolatedNotPrepared, PluginCheck.Security.DirectDB.UnescapedDBParameter -- Table name is safe; logs are dynamic.
        $total = (int) $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM {$table} WHERE provider = %s AND vector_store_id = %s AND batch_id = %s",
            $provider, $store_id, $batch_id
        ));
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching, WordPress.DB.PreparedSQL.InterpolatedNotPrepared, PluginCheck.Security.DirectDB.UnescapedDBParameter -- Table name is safe; logs are dynamic.
        $rows = $wpdb->get_results($wpdb->prepare(
            "SELECT id, file_id, indexed_content, timestamp FROM {$table} WHERE provider = %s AND vector_store_id = %s AND batch_id = %s ORDER BY id ASC LIMIT %d OFFSET %d",
            $provider, $store_id, $batch_id, $per_page, $offset
        ), ARRAY_A);

        if ($wpdb->last_error) {
            $this->send_wp_error(new \WP_Error('db_error_chunk_logs', __('Failed to fetch chunk logs.', 'gpt3-ai-content-generator'), ['status' => 500]));
            return;
        }

        wp_send_json_success([
            'chunks' => $rows,
            'pagination' => [
                'total' => $total,
                'total_pages' => $per_page ? (int) ceil($total / $per_page) : 1,
                'current_page' => $page,
                'per_page' => $per_page,
            ],
        ]);
    }

================================================================================
FUNCION: ajax_get_cpt_indexing_options
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_cpt_indexing_options()
    {
        $permission_check = $this->check_module_access_permissions(
            'sources',
            'aipkit_ai_training_settings_nonce'
        );
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        $cpt_data = [];
        $post_types = get_post_types(['public' => true], 'objects');
        unset($post_types['attachment']);

        foreach ($post_types as $cpt) {
            $taxonomies = get_object_taxonomies($cpt->name, 'objects');
            $public_taxonomies = [];
            foreach ($taxonomies as $tax) {
                if ($tax->public) {
                    $public_taxonomies[$tax->name] = $tax->label;
                }
            }

            $cpt_data[$cpt->name] = [
                'label'      => $cpt->label,
                'fields'     => $this->get_public_meta_keys_for_post_type($cpt->name),
                'taxonomies' => $public_taxonomies,
                'basic_labels' => [
                    'source_url' => __('Source URL', 'gpt3-ai-content-generator'),
                    'title'      => __('Title', 'gpt3-ai-content-generator'),
                    'excerpt'    => __('Excerpt', 'gpt3-ai-content-generator'),
                    'content'    => __('Content', 'gpt3-ai-content-generator'),
                ]
            ];

            if ($cpt->name === 'product' && class_exists('WooCommerce')) {
                $cpt_data[$cpt->name]['woo_attributes'] = [
                    'sku'        => __('SKU', 'gpt3-ai-content-generator'),
                    'price'      => __('Price', 'gpt3-ai-content-generator'),
                    'stock'      => __('Stock Status', 'gpt3-ai-content-generator'),
                    'dimensions' => __('Weight & Dimensions', 'gpt3-ai-content-generator'),
                    'attributes' => __('Product Attributes', 'gpt3-ai-content-generator'),
                ];
            }
        }

        $saved_settings = get_option('aipkit_indexing_field_settings', []);

        $response_data = [
            'cpt_data'       => $cpt_data,
            'saved_settings' => $saved_settings,
        ];
        
        wp_send_json_success($response_data);
    }

================================================================================
FUNCION: ajax_save_cpt_indexing_options
Resumen: Función que maneja $human.
CODIGO:
function ajax_save_cpt_indexing_options()
    {
        $permission_check = $this->check_module_access_permissions(
            'sources',
            'aipkit_ai_training_settings_nonce'
        );
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }
        $settings_json = isset($_POST['settings']) ? wp_unslash($_POST['settings']) : '{}';
        $settings = json_decode($settings_json, true);

        if (json_last_error() !== JSON_ERROR_NONE || !is_array($settings)) {
            $this->send_wp_error(new WP_Error('invalid_json', __('Invalid settings format.', 'gpt3-ai-content-generator')));
            return;
        }

        // --- NEW: Handle general settings separately ---
        $general_settings = get_option('aipkit_training_general_settings', []);
        $general_dirty = false;
        if (isset($settings['hide_user_uploads'])) {
            $general_settings['hide_user_uploads'] = (bool) $settings['hide_user_uploads'];
            unset($settings['hide_user_uploads']);
            $general_dirty = true;
        }
        if (isset($settings['show_index_button'])) {
            $general_settings['show_index_button'] = (bool) $settings['show_index_button'];
            unset($settings['show_index_button']);
            $general_dirty = true;
        }
        // Chunking settings (Pro only)
        if (isset($settings['chunk_avg_chars_per_token']) || isset($settings['chunk_max_tokens_per_chunk']) || isset($settings['chunk_overlap_tokens'])) {
            // Only allow saving if Pro
            $is_pro = \WPAICG\aipkit_dashboard::is_pro_plan();
            if ($is_pro) {
                $avg = isset($settings['chunk_avg_chars_per_token']) ? (int)$settings['chunk_avg_chars_per_token'] : null;
                $max = isset($settings['chunk_max_tokens_per_chunk']) ? (int)$settings['chunk_max_tokens_per_chunk'] : null;
                $ovl = isset($settings['chunk_overlap_tokens']) ? (int)$settings['chunk_overlap_tokens'] : null;

                // Validate ranges
                if ($avg !== null) {
                    if ($avg < 2 || $avg > 10) {
                        $this->send_wp_error(new \WP_Error('invalid_chunk_avg', __('Average chars per token must be between 2 and 10.', 'gpt3-ai-content-generator')));
                        return;
                    }
                    $general_settings['chunk_avg_chars_per_token'] = $avg;
                    $general_dirty = true;
                }
                if ($max !== null) {
                    if ($max < 256 || $max > 8000) {
                        $this->send_wp_error(new \WP_Error('invalid_chunk_max', __('Max tokens per chunk must be between 256 and 8000.', 'gpt3-ai-content-generator')));
                        return;
                    }
                    $general_settings['chunk_max_tokens_per_chunk'] = $max;
                    $general_dirty = true;
                }
                if ($ovl !== null) {
                    if ($ovl < 0 || $ovl > 1000) {
                        $this->send_wp_error(new \WP_Error('invalid_chunk_overlap', __('Overlap tokens must be between 0 and 1000.', 'gpt3-ai-content-generator')));
                        return;
                    }
                    $general_settings['chunk_overlap_tokens'] = $ovl;
                    $general_dirty = true;
                }
            }
            // Remove from specific settings payload
            unset($settings['chunk_avg_chars_per_token'], $settings['chunk_max_tokens_per_chunk'], $settings['chunk_overlap_tokens']);
        }

        if ($general_dirty) {
            update_option('aipkit_training_general_settings', $general_settings);
        }
        // --- END NEW ---

        // Sanitize the settings array
        $sanitized_settings = [];
        foreach ($settings as $cpt => $cpt_settings) {
            $cpt = sanitize_key($cpt);
            $sanitized_settings[$cpt] = [
                'fields' => [],
                'taxonomies' => [],
                'woo_attributes' => [],
                'basic_labels' => [],
            ];
            
            // Handle basic labels
            if (isset($cpt_settings['basic_labels']) && is_array($cpt_settings['basic_labels'])) {
                $allowed_basic_labels = ['source_url', 'title', 'excerpt', 'content'];
                foreach ($cpt_settings['basic_labels'] as $key => $label) {
                    if (in_array($key, $allowed_basic_labels)) {
                        $sanitized_settings[$cpt]['basic_labels'][sanitize_key($key)] = sanitize_text_field($label);
                    }
                }
            }
            
            if (isset($cpt_settings['fields']) && is_array($cpt_settings['fields'])) {
                foreach ($cpt_settings['fields'] as $key => $config) {
                    // Preserve original meta key (may include ":" etc.)
                    $key = is_string($key) ? wp_unslash($key) : $key;
                    // Ensure enabled is properly converted to boolean
                    $enabled = isset($config['enabled']) && $config['enabled'];
                    $sanitized_settings[$cpt]['fields'][$key] = [
                        'enabled' => (bool) $enabled,
                        'label'   => sanitize_text_field($config['label'] ?? ''),
                    ];
                }
            }
            if (isset($cpt_settings['taxonomies']) && is_array($cpt_settings['taxonomies'])) {
                foreach ($cpt_settings['taxonomies'] as $key => $config) {
                    // Preserve original taxonomy slug key
                    $key = is_string($key) ? wp_unslash($key) : $key;
                    // Ensure enabled is properly converted to boolean
                    $enabled = isset($config['enabled']) && $config['enabled'];
                    $sanitized_settings[$cpt]['taxonomies'][$key] = [
                        'enabled' => (bool) $enabled,
                        'label'   => sanitize_text_field($config['label'] ?? ''),
                    ];
                }
            }
            if (isset($cpt_settings['woo_attributes']) && is_array($cpt_settings['woo_attributes'])) {
                foreach ($cpt_settings['woo_attributes'] as $key => $config) {
                    // Preserve original key
                    $key = is_string($key) ? wp_unslash($key) : $key;
                    // Ensure enabled is properly converted to boolean
                    $enabled = isset($config['enabled']) && $config['enabled'];
                    $sanitized_settings[$cpt]['woo_attributes'][$key] = [
                        'enabled' => (bool) $enabled,
                        'label'   => sanitize_text_field($config['label'] ?? ''),
                    ];
                }
            }
        }

        update_option('aipkit_indexing_field_settings', $sanitized_settings, 'no');

        // DEBUG: Log the saved settings structure
        wp_send_json_success(['message' => __('Indexing settings saved successfully.', 'gpt3-ai-content-generator')]);
    }

================================================================================
FUNCION: get_public_meta_keys_for_post_type
Resumen: Función que maneja $human.
CODIGO:
function get_public_meta_keys_for_post_type(string $post_type, int $limit = 10): array
    {
        global $wpdb;
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching -- Efficiently sampling meta keys.
        $keys = $wpdb->get_col($wpdb->prepare(
            "SELECT DISTINCT meta_key FROM {$wpdb->postmeta} pm JOIN {$wpdb->posts} p ON p.ID = pm.post_id WHERE p.post_type = %s AND meta_key NOT LIKE %s ORDER BY pm.meta_id DESC LIMIT 100",
            $post_type,
            $wpdb->esc_like('_') . '%'
        ));
        $formatted_keys = [];
        if ($keys) {
            foreach ($keys as $key) {
                $formatted_keys[$key] = ucwords(str_replace(['_', '-'], ' ', $key));
            }
        }
        return $formatted_keys;
    }

================================================================================
FUNCION: resolve_stats_days
Resumen: Función que maneja $human.
CODIGO:
function resolve_stats_days($raw_days): int
    {
        $days = absint($raw_days);
        $allowed = [7, 30, 90];
        if (!in_array($days, $allowed, true)) {
            $days = 30;
        }
        return $days;
    }

================================================================================
FUNCION: get_stats_time_range
Resumen: Función que maneja $human.
CODIGO:
function get_stats_time_range(int $days): array
    {
        $wp_timezone = wp_timezone();
        $end_datetime = new \DateTime('now', $wp_timezone);
        $start_datetime = new \DateTime("-{$days} days", $wp_timezone);
        $start_datetime->setTime(0, 0, 0);

        return [
            'start_ts' => $start_datetime->getTimestamp(),
            'end_ts' => $end_datetime->getTimestamp(),
            'period_label' => sprintf(
                /* translators: %d: number of days */
                __('Last %d days', 'gpt3-ai-content-generator'),
                $days
            ),
        ];
    }

================================================================================
FUNCION: ajax_get_stats_overview
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_stats_overview()
    {
        $permission_check = $this->check_module_access_permissions('stats', 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce checked above.
        $post_data = wp_unslash($_POST);
        $days = $this->resolve_stats_days($post_data['days'] ?? 30);
        $range = $this->get_stats_time_range($days);

        global $wpdb;
        $table_name = $wpdb->prefix . 'aipkit_chat_logs';

        $total_conversations = (int) $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM {$table_name} WHERE last_message_ts >= %d AND last_message_ts <= %d",
            $range['start_ts'],
            $range['end_ts']
        ));

        $total_messages = (int) $wpdb->get_var($wpdb->prepare(
            "SELECT COALESCE(SUM(message_count), 0) FROM {$table_name} WHERE last_message_ts >= %d AND last_message_ts <= %d",
            $range['start_ts'],
            $range['end_ts']
        ));

        $unique_users = (int) $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT CASE
                WHEN is_guest = 1 AND session_id IS NOT NULL AND session_id != '' THEN CONCAT('g:', session_id)
                WHEN user_id IS NOT NULL THEN CONCAT('u:', user_id)
                ELSE NULL
            END)
            FROM {$table_name}
            WHERE last_message_ts >= %d AND last_message_ts <= %d",
            $range['start_ts'],
            $range['end_ts']
        ));

        $daily_rows = $wpdb->get_results($wpdb->prepare(
            "SELECT FROM_UNIXTIME(last_message_ts, '%%Y-%%m-%%d') AS day, COUNT(*) AS cnt
             FROM {$table_name}
             WHERE last_message_ts >= %d AND last_message_ts <= %d
             GROUP BY day
             ORDER BY day ASC",
            $range['start_ts'],
            $range['end_ts']
        ), ARRAY_A);

        $daily_conversations = [];
        if (!empty($daily_rows)) {
            foreach ($daily_rows as $row) {
                if (!empty($row['day'])) {
                    $daily_conversations[$row['day']] = (int) $row['cnt'];
                }
            }
        }

        $avg_tokens = 0;
        $daily_tokens = [];
        if (class_exists(AIPKit_Stats::class)) {
            $stats = new AIPKit_Stats();
            $token_stats = $stats->get_token_stats_last_days($days);
            if (!is_wp_error($token_stats)) {
                $avg_tokens = (int) ($token_stats['avg_tokens_per_interaction'] ?? 0);
            }
            $daily_stats = $stats->get_daily_token_stats($days);
            if (!is_wp_error($daily_stats)) {
                $daily_tokens = $daily_stats;
            }
        }

        wp_send_json_success([
            'summary' => [
                'total_conversations' => $total_conversations,
                'total_messages' => $total_messages,
                'unique_users' => $unique_users,
                'avg_tokens' => $avg_tokens,
                'period_label' => $range['period_label'],
            ],
            'charts' => [
                'daily_conversations' => $daily_conversations,
                'daily_tokens' => $daily_tokens,
            ],
        ]);
    }

================================================================================
FUNCION: ajax_get_stats_logs
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_stats_logs()
    {
        $permission_check = $this->check_module_access_permissions('stats', 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce checked above.
        $post_data = wp_unslash($_POST);
        $days = $this->resolve_stats_days($post_data['days'] ?? 30);
        $range = $this->get_stats_time_range($days);

        $page = isset($post_data['page']) ? absint($post_data['page']) : 1;
        $per_page = isset($post_data['per_page']) ? absint($post_data['per_page']) : 20;
        if ($page < 1) {
            $page = 1;
        }
        if ($per_page < 1) {
            $per_page = 20;
        }
        if ($per_page > 100) {
            $per_page = 100;
        }
        $offset = ($page - 1) * $per_page;

        $filters = [
            'start_ts' => $range['start_ts'],
            'end_ts' => $range['end_ts'],
        ];

        $bot_id_raw = isset($post_data['bot_id']) ? sanitize_text_field($post_data['bot_id']) : '';
        if ($bot_id_raw !== '') {
            $filters['bot_id'] = $bot_id_raw;
        }

        $module = isset($post_data['module']) ? sanitize_key($post_data['module']) : '';
        if ($module !== '') {
            $filters['module'] = $module;
        }

        $search = isset($post_data['search']) ? sanitize_text_field($post_data['search']) : '';
        if ($search !== '') {
            $filters['search'] = $search;
        }

        if (!class_exists(LogStorage::class)) {
            $this->send_wp_error(new WP_Error('missing_log_storage', __('Log storage is unavailable.', 'gpt3-ai-content-generator')));
            return;
        }

        $log_storage = new LogStorage();
        $logs = $log_storage->get_logs($filters, $per_page, $offset);
        $total_logs = $log_storage->count_logs($filters);
        $total_pages = $per_page > 0 ? (int) ceil($total_logs / $per_page) : 1;

        wp_send_json_success([
            'logs' => $logs ?: [],
            'pagination' => [
                'total_logs' => (int) $total_logs,
                'total_pages' => $total_pages,
                'current_page' => $page,
            ],
        ]);
    }

================================================================================
FUNCION: ajax_get_stats_log_detail
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_stats_log_detail()
    {
        $permission_check = $this->check_module_access_permissions('stats', 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce checked above.
        $post_data = wp_unslash($_POST);
        $log_id = isset($post_data['log_id']) ? absint($post_data['log_id']) : 0;
        if (!$log_id) {
            $this->send_wp_error(new WP_Error('missing_log_id', __('Log ID is required.', 'gpt3-ai-content-generator')));
            return;
        }

        if (!class_exists(LogStorage::class)) {
            $this->send_wp_error(new WP_Error('missing_log_storage', __('Log storage is unavailable.', 'gpt3-ai-content-generator')));
            return;
        }

        $log_storage = new LogStorage();
        $log_row = $log_storage->get_log_by_id($log_id);
        if (!$log_row) {
            $this->send_wp_error(new WP_Error('log_not_found', __('Log entry not found.', 'gpt3-ai-content-generator')));
            return;
        }

        global $wpdb;
        $table_name = $wpdb->prefix . 'aipkit_chat_logs';
        $messages_json = $wpdb->get_var($wpdb->prepare(
            "SELECT messages FROM {$table_name} WHERE id = %d",
            $log_id
        ));

        $messages = [];
        if (!empty($messages_json)) {
            $conversation_data = json_decode($messages_json, true);
            if (is_array($conversation_data) && isset($conversation_data['messages']) && is_array($conversation_data['messages'])) {
                $messages = $conversation_data['messages'];
            } elseif (is_array($conversation_data)) {
                $messages = $conversation_data;
            }
        }

        $log_row['messages'] = $messages;
        $log_row['message_count'] = $log_row['message_count'] ?? count($messages);

        wp_send_json_success($log_row);
    }

================================================================================
FUNCION: ajax_export_stats_logs
Resumen: Función que maneja $human.
CODIGO:
function ajax_export_stats_logs()
    {
        $permission_check = $this->check_module_access_permissions('stats', 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce checked above.
        $post_data = wp_unslash($_POST);
        $filters = $this->build_stats_log_filters($post_data);
        $limit = isset($post_data['limit']) ? absint($post_data['limit']) : 1000;
        if ($limit < 1) {
            $limit = 1000;
        }
        if ($limit > 5000) {
            $limit = 5000;
        }

        if (!class_exists(LogStorage::class)) {
            $this->send_wp_error(new WP_Error('missing_log_storage', __('Log storage is unavailable.', 'gpt3-ai-content-generator')));
            return;
        }

        $log_storage = new LogStorage();
        $logs = $log_storage->get_logs($filters, $limit, 0);
        $total_logs = $log_storage->count_logs($filters);

        $headers = [
            'log_id' => __('Log ID', 'gpt3-ai-content-generator'),
            'date' => __('Date', 'gpt3-ai-content-generator'),
            'user' => __('User', 'gpt3-ai-content-generator'),
            'source' => __('Source', 'gpt3-ai-content-generator'),
            'module' => __('Module', 'gpt3-ai-content-generator'),
            'messages' => __('Messages', 'gpt3-ai-content-generator'),
            'tokens' => __('Tokens', 'gpt3-ai-content-generator'),
            'preview' => __('Preview', 'gpt3-ai-content-generator'),
            'conversation_uuid' => __('Conversation UUID', 'gpt3-ai-content-generator'),
        ];

        $lines = [];
        $lines[] = implode(',', array_map([$this, 'escape_csv_field'], array_values($headers)));

        if (!empty($logs)) {
            foreach ($logs as $log_row) {
                $date = !empty($log_row['last_message_ts']) ? gmdate('Y-m-d H:i:s', (int) $log_row['last_message_ts']) : '';
                $preview = isset($log_row['last_message_content']) ? (string) $log_row['last_message_content'] : '';
                $line = [
                    $log_row['id'] ?? '',
                    $date,
                    $log_row['user_display_name'] ?? '',
                    $log_row['bot_name'] ?? '',
                    $log_row['module'] ?? '',
                    $log_row['message_count'] ?? '',
                    $log_row['total_conversation_tokens'] ?? '',
                    $preview,
                    $log_row['conversation_uuid'] ?? '',
                ];
                $lines[] = implode(',', array_map([$this, 'escape_csv_field'], $line));
            }
        }

        $csv = implode("\r\n", $lines);
        $filename = sprintf('aipkit-logs-%s.csv', gmdate('Ymd-His'));
        $message = __('Export ready.', 'gpt3-ai-content-generator');
        if ($total_logs > $limit) {
            $message = sprintf(
                /* translators: %d: number of exported rows */
                __('Exported first %d logs (filtered).', 'gpt3-ai-content-generator'),
                $limit
            );
        }

        wp_send_json_success([
            'csv' => $csv,
            'filename' => $filename,
            'message' => $message,
        ]);
    }

================================================================================
FUNCION: ajax_delete_stats_log
Resumen: Función que maneja $human.
CODIGO:
function ajax_delete_stats_log()
    {
        $permission_check = $this->check_module_access_permissions('stats', 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce checked above.
        $post_data = wp_unslash($_POST);
        $log_id = isset($post_data['log_id']) ? absint($post_data['log_id']) : 0;
        if (!$log_id) {
            $this->send_wp_error(new WP_Error('missing_log_id', __('Log ID is required.', 'gpt3-ai-content-generator')));
            return;
        }

        if (!class_exists(LogStorage::class)) {
            $this->send_wp_error(new WP_Error('missing_log_storage', __('Log storage is unavailable.', 'gpt3-ai-content-generator')));
            return;
        }

        $log_storage = new LogStorage();
        $log_row = $log_storage->get_log_by_id($log_id);
        if (!$log_row) {
            $this->send_wp_error(new WP_Error('log_not_found', __('Log entry not found.', 'gpt3-ai-content-generator')));
            return;
        }

        $result = $log_storage->delete_single_conversation(
            $log_row['user_id'] ?? null,
            $log_row['session_id'] ?? null,
            $log_row['bot_id'] ?? null,
            $log_row['conversation_uuid'] ?? ''
        );
        if (is_wp_error($result)) {
            $this->send_wp_error($result);
            return;
        }

        wp_send_json_success([
            'message' => __('Conversation deleted.', 'gpt3-ai-content-generator'),
            'log_id' => $log_id,
        ]);
    }

================================================================================
FUNCION: ajax_delete_stats_logs
Resumen: Función que maneja $human.
CODIGO:
function ajax_delete_stats_logs()
    {
        $permission_check = $this->check_module_access_permissions('stats', 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce checked above.
        $post_data = wp_unslash($_POST);
        $filters = $this->build_stats_log_filters($post_data);

        if (!class_exists(LogStorage::class)) {
            $this->send_wp_error(new WP_Error('missing_log_storage', __('Log storage is unavailable.', 'gpt3-ai-content-generator')));
            return;
        }

        $log_storage = new LogStorage();
        $batch_size = 500;
        $max_batches = 200;
        $total_deleted = 0;
        $batch = 0;

        do {
            $deleted = $log_storage->delete_logs($filters, $batch_size);
            if ($deleted === false) {
                $this->send_wp_error(new WP_Error('delete_failed', __('Failed to delete logs.', 'gpt3-ai-content-generator')));
                return;
            }
            $total_deleted += (int) $deleted;
            $batch++;
        } while ($deleted === $batch_size && $batch < $max_batches);

        $message = sprintf(
            /* translators: %d: number of log entries deleted */
            _n('%d log deleted.', '%d logs deleted.', $total_deleted, 'gpt3-ai-content-generator'),
            number_format_i18n($total_deleted)
        );

        if ($batch >= $max_batches && $deleted === $batch_size) {
            $message = __('Log deletion reached the maximum batch limit. Please run again to continue.', 'gpt3-ai-content-generator');
        }

        wp_send_json_success([
            'message' => $message,
            'deleted' => $total_deleted,
        ]);
    }

================================================================================
FUNCION: ajax_save_stats_settings
Resumen: Función que maneja $human.
CODIGO:
function ajax_save_stats_settings()
    {
        $permission_check = $this->check_module_access_permissions('stats', 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce checked above.
        $post_data = wp_unslash($_POST);
        $enable_pruning = isset($post_data['enable_pruning']) && $post_data['enable_pruning'] === '1';
        $retention_period = isset($post_data['retention_period_days']) ? floatval($post_data['retention_period_days']) : 90;

        if (!LogConfig::is_valid_period($retention_period)) {
            $retention_period = 90;
        }

        $is_pro = class_exists('\\WPAICG\\aipkit_dashboard') ? \WPAICG\aipkit_dashboard::is_pro_plan() : false;
        if ($enable_pruning && !$is_pro) {
            $this->send_wp_error(new WP_Error('pro_required', __('Auto-delete logs is a Pro feature.', 'gpt3-ai-content-generator')));
            return;
        }

        $settings = [
            'enable_pruning' => $enable_pruning && $is_pro,
            'retention_period_days' => $retention_period,
        ];
        update_option('aipkit_log_settings', $settings, 'no');

        if (class_exists(LogCronManager::class)) {
            if ($enable_pruning && $is_pro) {
                LogCronManager::schedule_event();
            } else {
                LogCronManager::unschedule_event();
            }
        }

        wp_send_json_success([
            'message' => __('Settings saved.', 'gpt3-ai-content-generator'),
        ]);
    }

================================================================================
FUNCION: ajax_get_stats_log_cron_status
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_stats_log_cron_status()
    {
        $permission_check = $this->check_module_access_permissions('stats', 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        $log_settings = LogConfig::get_log_settings();
        $enable_pruning = (bool) ($log_settings['enable_pruning'] ?? false);

        $cron_hook = LogCronManager::HOOK_NAME;
        $next_scheduled = wp_next_scheduled($cron_hook);
        $is_cron_active = $next_scheduled !== false;

        $state = 'disabled';
        $status_text = __('Disabled', 'gpt3-ai-content-generator');
        if ($enable_pruning) {
            if ($is_cron_active) {
                $state = 'scheduled';
                $status_text = __('Scheduled', 'gpt3-ai-content-generator');
            } else {
                $state = 'not-scheduled';
                $status_text = __('Not Scheduled', 'gpt3-ai-content-generator');
            }
        }

        $last_run_option = get_option('aipkit_log_pruning_last_run', '');
        $last_run_label = $last_run_option
            ? wp_date(get_option('date_format') . ' ' . get_option('time_format'), strtotime($last_run_option))
            : __('Never', 'gpt3-ai-content-generator');

        wp_send_json_success([
            'state' => $state,
            'status_text' => $status_text,
            'last_run_label' => sprintf(
                /* translators: %s: last run time */
                __('Last run: %s', 'gpt3-ai-content-generator'),
                $last_run_label
            ),
        ]);
    }

================================================================================
FUNCION: ajax_prune_stats_logs_now
Resumen: Función que maneja $human.
CODIGO:
function ajax_prune_stats_logs_now()
    {
        $permission_check = $this->check_module_access_permissions('stats', 'aipkit_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        if (!class_exists('\\WPAICG\\aipkit_dashboard') || !\WPAICG\aipkit_dashboard::is_pro_plan()) {
            $this->send_wp_error(new WP_Error('pro_required', __('Manual log pruning is a Pro feature. Please upgrade.', 'gpt3-ai-content-generator')));
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce checked above.
        $post_data = wp_unslash($_POST);
        $retention_period = isset($post_data['retention_period_days']) ? floatval($post_data['retention_period_days']) : 90;

        if (!LogConfig::is_valid_period($retention_period)) {
            $this->send_wp_error(new WP_Error('invalid_period', __('Invalid retention period provided.', 'gpt3-ai-content-generator')));
            return;
        }

        if (!class_exists(LogManager::class)) {
            $this->send_wp_error(new WP_Error('dependency_missing', __('Log manager component is unavailable.', 'gpt3-ai-content-generator')));
            return;
        }

        $log_manager = new LogManager();
        $deleted_rows = $log_manager->prune_logs($retention_period);

        if ($deleted_rows === false) {
            $this->send_wp_error(new WP_Error('pruning_failed', __('An error occurred while pruning the logs.', 'gpt3-ai-content-generator')));
            return;
        }

        update_option('aipkit_log_pruning_last_run', current_time('mysql', true), 'no');

        /* translators: %d: number of log entries deleted */
        $message = sprintf(_n('%d log entry pruned.', '%d log entries pruned.', $deleted_rows, 'gpt3-ai-content-generator'), number_format_i18n($deleted_rows));
        wp_send_json_success([
            'message' => $message,
            'deleted_count' => $deleted_rows,
        ]);
    }

================================================================================
FUNCION: build_stats_log_filters
Resumen: Función que maneja $human.
CODIGO:
function build_stats_log_filters(array $post_data): array
    {
        $days = $this->resolve_stats_days($post_data['days'] ?? 30);
        $range = $this->get_stats_time_range($days);

        $filters = [
            'start_ts' => $range['start_ts'],
            'end_ts' => $range['end_ts'],
        ];

        $bot_id_raw = isset($post_data['bot_id']) ? sanitize_text_field($post_data['bot_id']) : '';
        if ($bot_id_raw !== '') {
            $filters['bot_id'] = $bot_id_raw;
        }

        $module = isset($post_data['module']) ? sanitize_key($post_data['module']) : '';
        if ($module !== '') {
            $filters['module'] = $module;
        }

        $search = isset($post_data['search']) ? sanitize_text_field($post_data['search']) : '';
        if ($search !== '') {
            $filters['search'] = $search;
        }

        return $filters;
    }

================================================================================
FUNCION: escape_csv_field
Resumen: Función que maneja $human.
CODIGO:
function escape_csv_field(string|int|float|null $value): string
    {
        $string_value = (string) $value;
        $string_value = str_replace(["\r\n", "\n", "\r"], ' ', $string_value);
        $string_value = str_replace('"', '""', $string_value);
        return '"' . $string_value . '"';
    }

================================================================================
FUNCION: __construct
Resumen: Función que maneja $human.
CODIGO:
function __construct() {
        // Call the constructor logic from the init sub-namespace
        Init\ConstructorLogic($this);
    }

================================================================================
FUNCION: schedule_token_reset_event
Resumen: Función que maneja $human.
CODIGO:
function schedule_token_reset_event() {
        Cron\ScheduleTokenResetEventLogic(CronHookConstant::CRON_HOOK);
    }

================================================================================
FUNCION: unschedule_token_reset_event
Resumen: Función que maneja $human.
CODIGO:
function unschedule_token_reset_event() {
        Cron\UnscheduleTokenResetEventLogic(CronHookConstant::CRON_HOOK);
    }

================================================================================
FUNCION: perform_token_reset
Resumen: Función que maneja $human.
CODIGO:
function perform_token_reset() {
        Reset\PerformTokenResetLogic($this);
    }

================================================================================
FUNCION: is_reset_due
Resumen: Función que maneja $human.
CODIGO:
function is_reset_due(int $last_reset_timestamp, string $period): bool {
        return Reset\IsResetDueLogic($last_reset_timestamp, $period);
    }

================================================================================
FUNCION: check_and_reset_tokens
Resumen: Función que maneja $human.
CODIGO:
function check_and_reset_tokens(?int $user_id, ?string $session_id, ?int $context_id_or_bot_id, string $module_context = 'chat'): bool|WP_Error {
        return Check\CheckAndResetTokensLogic($this, $user_id, $session_id, $context_id_or_bot_id, $module_context);
    }

================================================================================
FUNCION: record_token_usage
Resumen: Función que maneja $human.
CODIGO:
function record_token_usage(?int $user_id, ?string $session_id, ?int $context_id_or_bot_id, int $tokens_used, string $module_context = 'chat') {
        Record\RecordTokenUsageLogic($this, $user_id, $session_id, $context_id_or_bot_id, $tokens_used, $module_context);
    }

================================================================================
FUNCION: get_guest_table_name
Resumen: Función que maneja $human.
CODIGO:
function get_guest_table_name(): string {
        return $this->guest_table_name;
    }

================================================================================
FUNCION: get_bot_storage
Resumen: Función que maneja $human.
CODIGO:
function get_bot_storage() { // Type hint can be added if BotStorage class is defined in a way it can be type-hinted here
        return $this->bot_storage;
    }

================================================================================
FUNCION: set_guest_table_name
Resumen: Función que maneja $human.
CODIGO:
function set_guest_table_name(string $name): void {
        $this->guest_table_name = $name;
    }

================================================================================
FUNCION: set_bot_storage
Resumen: Función que maneja $human.
CODIGO:
function set_bot_storage($storage_instance): void { // Type hint can be added
        $this->bot_storage = $storage_instance;
    }

================================================================================
FUNCION: RecordTokenUsageLogic
Resumen (del comentario): Logic for recording token usage for a given context (chat bot or module). This function is called by the record_token_usage method in AIPKit_Token_Manager. @param AIPKit_Token_Manager $managerInstance The instance of AIPKit_Token_Manager. @param int|null $user_id User ID, or null for guests. @param string|null $session_id Session ID for guests. @param int|null $context_id_or_bot_id Bot ID for 'chat', IMG_GEN_GUEST_CONTEXT_ID for 'image_generator' guest table. Can be null for others. @param int $tokens_used Number of tokens to record. @param string $module_context 'chat', 'image_generator', or other module slug.
CODIGO:
function RecordTokenUsageLogic(
    AIPKit_Token_Manager $managerInstance,
    ?int $user_id,
    ?string $session_id,
    ?int $context_id_or_bot_id,
    int $tokens_used,
    string $module_context = 'chat'
): void {
    global $wpdb;

    if ($tokens_used <= 0) {
        return;
    }

    $tokens_left_to_deduct = $tokens_used;

    // --- MODIFIED: Deduct from persistent balance first, then periodic ---
    if ($user_id) {
        $token_balance_raw = get_user_meta($user_id, MetaKeysConstants::TOKEN_BALANCE_META_KEY, true);
        if (is_numeric($token_balance_raw) && (int)$token_balance_raw > 0) {
            $current_balance = (int) $token_balance_raw;
            $deducted_from_balance = min($current_balance, $tokens_left_to_deduct);
            $new_balance = $current_balance - $deducted_from_balance;
            update_user_meta($user_id, MetaKeysConstants::TOKEN_BALANCE_META_KEY, $new_balance);
            $tokens_left_to_deduct -= $deducted_from_balance;
        }
    }

    if ($tokens_left_to_deduct <= 0) {
        return; // All tokens were covered by the persistent balance.
    }
    // --- END MODIFICATION ---

    // If tokens are still left to deduct, proceed with the original periodic usage tracking logic.

    // Validation
    if ($module_context === 'chat' && empty($context_id_or_bot_id)) {
        return;
    }
    if ($module_context === 'image_generator' && $context_id_or_bot_id === null) {
        return;
    }
    if ($module_context === 'ai_forms' && $context_id_or_bot_id === null && !$user_id) {
        return;
    }

    if (!$user_id && empty($session_id)) {
        return;
    }

    $is_guest = !$user_id;
    $settings = [];
    $usage_key = '';
    $reset_key = '';
    $guest_context_table_id = is_numeric($context_id_or_bot_id) ? $context_id_or_bot_id : null;

    // Fetch settings based on module context
    if ($module_context === 'chat') {
        $bot_storage = $managerInstance->get_bot_storage();
        if (!$bot_storage) {
            return;
        }
        if ($guest_context_table_id === null) {
            return;
        }
        $settings = $bot_storage->get_chatbot_settings($guest_context_table_id);
        $usage_key = MetaKeysConstants::CHAT_USAGE_META_KEY_PREFIX . $guest_context_table_id;
        $reset_key = MetaKeysConstants::CHAT_RESET_META_KEY_PREFIX . $guest_context_table_id;
    } elseif ($module_context === 'image_generator') {
        if (!class_exists(AIPKit_Image_Settings_Ajax_Handler::class)) {
            return;
        }
        $img_settings_all = AIPKit_Image_Settings_Ajax_Handler::get_settings();
        $settings = $img_settings_all['token_management'] ?? [];
        $usage_key = MetaKeysConstants::IMG_USAGE_META_KEY;
        $reset_key = MetaKeysConstants::IMG_RESET_META_KEY;
        $guest_context_table_id = GuestTableConstants::IMG_GEN_GUEST_CONTEXT_ID;
    } elseif ($module_context === 'ai_forms') {
        if (!class_exists(AIPKit_AI_Form_Settings_Ajax_Handler::class)) {
            return;
        }
        $aiforms_settings_all = AIPKit_AI_Form_Settings_Ajax_Handler::get_settings();
        $settings = $aiforms_settings_all['token_management'] ?? [];
        $usage_key = MetaKeysConstants::AIFORMS_USAGE_META_KEY;
        $reset_key = MetaKeysConstants::AIFORMS_RESET_META_KEY;
        $guest_context_table_id = GuestTableConstants::AI_FORMS_GUEST_CONTEXT_ID;
    } else {
        return;
    }

    if ($guest_context_table_id === null && $is_guest) {
        return;
    }

    $reset_period = $settings['token_reset_period'] ?? 'never';
    $should_record = false;

    // Determine if tokens should be recorded based on limits
    if ($is_guest) {
        $limit = $settings['token_guest_limit'] ?? null;
        if ($limit === null || $limit === '' || (ctype_digit((string)$limit) && (int)$limit > 0)) {
            $should_record = true;
        } // Record if unlimited or limit > 0
    } else { // Logged-in User
        $limit_mode = $settings['token_limit_mode'] ?? 'general';
        $limit_value_source = ($limit_mode === 'general') ? ($settings['token_user_limit'] ?? null) : 'role_based';
        if ($limit_value_source === null || $limit_value_source === '' || $limit_value_source === 'role_based') {
            $should_record = true; // Record if unlimited or role-based (as roles might have limits)
        } elseif (ctype_digit((string)$limit_value_source) && (int)$limit_value_source > 0) {
            $should_record = true; // Record if general limit > 0
        }
    }

    if ($should_record) {
        $guest_table_name = $wpdb->prefix . GuestTableConstants::GUEST_TABLE_NAME_SUFFIX;
        $new_usage = 0;
        if ($is_guest && $guest_context_table_id !== null) {
            // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching, WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- Reason: Direct query to a custom table. Caches will be invalidated.
            $guest_row = $wpdb->get_row($wpdb->prepare("SELECT tokens_used, last_reset_timestamp FROM {$guest_table_name} WHERE session_id = %s AND bot_id = %d", $session_id, $guest_context_table_id), ARRAY_A);
            $current_usage = $guest_row ? (int) $guest_row['tokens_used'] : 0;
            $last_reset = $guest_row ? (int) $guest_row['last_reset_timestamp'] : 0;
            $new_usage = $current_usage + $tokens_left_to_deduct; // Use remaining tokens
            if ($last_reset === 0 && $reset_period !== 'never') {
                $last_reset = time();
            } // Set initial reset time if not set
            // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching
            $upsert_result = $wpdb->replace($guest_table_name, ['session_id' => $session_id, 'bot_id' => $guest_context_table_id, 'tokens_used' => $new_usage, 'last_reset_timestamp' => $last_reset, 'last_updated_at' => current_time('mysql', 1)], ['%s', '%d', '%d', '%d', '%s']);
        } elseif (!$is_guest) {
            $current_usage = (int) get_user_meta($user_id, $usage_key, true);
            $new_usage = $current_usage + $tokens_left_to_deduct; // Use remaining tokens
            update_user_meta($user_id, $usage_key, $new_usage);
            if ($reset_period !== 'never') {
                if (!get_user_meta($user_id, $reset_key, true)) {
                    update_user_meta($user_id, $reset_key, time());
                } // Set initial reset time
            }
        }
        $log_context_str = $is_guest ? "Guest {$session_id}" : "User {$user_id}";
        $log_module_str = ($module_context === 'chat') ? "Bot {$context_id_or_bot_id}" : "Module {$module_context}";
    } else {
        $log_context_str = $is_guest ? "Guest {$session_id}" : "User {$user_id}";
        $log_module_str = ($module_context === 'chat') ? "Bot {$context_id_or_bot_id}" : "Module {$module_context}";
    }
}

================================================================================
FUNCION: CheckAndResetTokensLogic
Resumen (del comentario): Logic for checking token usage against limits for a given context (chat bot or module). This function is called by the check_and_reset_tokens method in AIPKit_Token_Manager. @param AIPKit_Token_Manager $managerInstance The instance of AIPKit_Token_Manager. @param int|null $user_id User ID, or null for guests. @param string|null $session_id Session ID for guests. @param int|null $context_id_or_bot_id Bot ID for 'chat', or IMG_GEN_GUEST_CONTEXT_ID for 'image_generator'. Can be null for other modules. @param string $module_context 'chat', 'image_generator', or other module slug. @return bool|WP_Error True if allowed, WP_Error if limit exceeded or other error.
CODIGO:
function CheckAndResetTokensLogic(
    AIPKit_Token_Manager $managerInstance,
    ?int $user_id,
    ?string $session_id,
    ?int $context_id_or_bot_id,
    string $module_context = 'chat'
): bool|WP_Error {
    global $wpdb;

    // --- NEW: First, check for a persistent token balance for logged-in users ---
    if ($user_id) {
        $token_balance = get_user_meta($user_id, MetaKeysConstants::TOKEN_BALANCE_META_KEY, true);
        if (is_numeric($token_balance) && (int)$token_balance > 0) {
            // User has a positive balance, so they are allowed to proceed.
            // The deduction will happen in RecordTokenUsageLogic.
            return true;
        }
    }
    // --- END NEW ---

    // If no balance, or a guest, proceed with the original periodic usage tracking logic.

    // Validation
    if ($module_context === 'chat' && empty($context_id_or_bot_id)) {
        return new WP_Error('token_check_no_bot_id_logic', __('Bot ID missing for chat token check.', 'gpt3-ai-content-generator'));
    }
    if ($module_context === 'image_generator' && $context_id_or_bot_id === null) { // image_generator uses 0 for guests
        return new WP_Error('token_check_no_img_context_logic', __('Image Generator context ID missing for token check.', 'gpt3-ai-content-generator'));
    }
    if ($module_context === 'ai_forms' && $context_id_or_bot_id === null && !$user_id) { // ai_forms uses 1 for guests, null for users
        // This is a valid state for logged-in users, so only error if guest AND null
        return new WP_Error('token_check_no_aiforms_context_logic', __('AI Forms context ID missing for guest token check.', 'gpt3-ai-content-generator'));
    }

    if (!$user_id && empty($session_id)) {
        return new WP_Error('token_check_no_identifier_logic', __('User/Session ID missing for token check.', 'gpt3-ai-content-generator'));
    }

    $is_guest = !$user_id;
    $settings = [];
    $usage_key = '';
    $reset_key = '';
    $guest_context_table_id = is_numeric($context_id_or_bot_id) ? $context_id_or_bot_id : null;

    // Fetch settings based on module context
    if ($module_context === 'chat') {
        $bot_storage = $managerInstance->get_bot_storage();
        if (!$bot_storage) {
            return new WP_Error('init_error_chat_storage_logic', __('Token manager (bot storage) not initialized.', 'gpt3-ai-content-generator'));
        }
        if ($guest_context_table_id === null) { // Ensure bot_id is numeric for chat
            return new WP_Error('internal_error_chat_context_id_logic', __('Chat context requires a valid Bot ID for token check.', 'gpt3-ai-content-generator'));
        }
        $settings = $bot_storage->get_chatbot_settings($guest_context_table_id);
        $usage_key = MetaKeysConstants::CHAT_USAGE_META_KEY_PREFIX . $guest_context_table_id;
        $reset_key = MetaKeysConstants::CHAT_RESET_META_KEY_PREFIX . $guest_context_table_id;
    } elseif ($module_context === 'image_generator') {
        if (!class_exists(AIPKit_Image_Settings_Ajax_Handler::class)) {
            return new WP_Error('init_error_img_settings_logic', __('Token manager (image settings) not initialized.', 'gpt3-ai-content-generator'));
        }
        $img_settings_all = AIPKit_Image_Settings_Ajax_Handler::get_settings();
        $settings = $img_settings_all['token_management'] ?? [];
        $usage_key = MetaKeysConstants::IMG_USAGE_META_KEY;
        $reset_key = MetaKeysConstants::IMG_RESET_META_KEY;
        // guest_context_table_id for image generator is a constant (e.g., 0)
        $guest_context_table_id = GuestTableConstants::IMG_GEN_GUEST_CONTEXT_ID;
    } elseif ($module_context === 'ai_forms') {
        if (!class_exists(\WPAICG\AIForms\Admin\AIPKit_AI_Form_Settings_Ajax_Handler::class)) {
            return new WP_Error('init_error_aiforms_settings_logic', __('Token manager (AI Forms settings) not initialized.', 'gpt3-ai-content-generator'));
        }
        $aiforms_settings_all = \WPAICG\AIForms\Admin\AIPKit_AI_Form_Settings_Ajax_Handler::get_settings();
        $settings = $aiforms_settings_all['token_management'] ?? [];
        $usage_key = MetaKeysConstants::AIFORMS_USAGE_META_KEY;
        $reset_key = MetaKeysConstants::AIFORMS_RESET_META_KEY;
        $guest_context_table_id = GuestTableConstants::AI_FORMS_GUEST_CONTEXT_ID;
    } else {
        if ($context_id_or_bot_id === null) {
            return true;
        } // No specific limits for this generic module context if no ID
        return new WP_Error('invalid_module_context_for_tokens_logic', __('Invalid module context or ID for token check.', 'gpt3-ai-content-generator'));
    }

    if ($guest_context_table_id === null && $is_guest) {
        return true; // Or error, based on policy. For now, allow if this unlikely scenario happens.
    }

    // Determine limit and reset period
    $limit = null;
    $reset_period = $settings['token_reset_period'] ?? 'never';
    $default_limit_message = class_exists(BotSettingsManager::class) ? BotSettingsManager::DEFAULT_TOKEN_LIMIT_MESSAGE : __('You have reached your token limit for this period.', 'gpt3-ai-content-generator');
    $limit_message_template = $settings['token_limit_message'] ?? '';
    $limit_message = !empty($limit_message_template) ? $limit_message_template : $default_limit_message;

    $current_usage = 0;
    $last_reset_time = 0;
    $guest_table_name = $wpdb->prefix . GuestTableConstants::GUEST_TABLE_NAME_SUFFIX;

    if ($is_guest) {
        $limit = $settings['token_guest_limit'] ?? null;
        if ($limit === 0 || (is_string($limit) && $limit === '0')) { // Check for string '0' too
            return new WP_Error('token_limit_exceeded_guest_logic', __('Access disabled for guests.', 'gpt3-ai-content-generator'));
        }
        if ($limit === null || $limit === '') {
            return true;
        } // Unlimited for this context

        if ($guest_context_table_id !== null) {
            $cache_key = "aipkit_guest_usage_{$session_id}_{$guest_context_table_id}";
            $guest_row = wp_cache_get($cache_key, 'aipkit_token_usage');
            if (false === $guest_row) {
                // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- Custom table query; unavoidable.
                $guest_row = $wpdb->get_row($wpdb->prepare("SELECT tokens_used, last_reset_timestamp FROM {$guest_table_name} WHERE session_id = %s AND bot_id = %d",
                    $session_id,
                    $guest_context_table_id
                ), ARRAY_A);
                wp_cache_set($cache_key, $guest_row, 'aipkit_token_usage', 300); // Cache for 5 minutes
            }
            if ($guest_row) {
                $current_usage = (int) $guest_row['tokens_used'];
                $last_reset_time = (int) $guest_row['last_reset_timestamp'];
            }
        } else {
            return true; // Should have been caught earlier
        }
    } else { // Logged-in User
        $limit_mode = $settings['token_limit_mode'] ?? 'general';
        if ($limit_mode === 'general') {
            $limit = $settings['token_user_limit'] ?? null;
        } else { // Role-based
            $user_data = get_userdata($user_id);
            $user_roles = $user_data ? (array) $user_data->roles : [];
            $role_limits_raw = $settings['token_role_limits'] ?? [];
            $role_limits = is_string($role_limits_raw) ? json_decode($role_limits_raw, true) : (is_array($role_limits_raw) ? $role_limits_raw : []);
            if (!is_array($role_limits)) {
                $role_limits = [];
            }

            if (empty($user_roles) || empty($role_limits)) {
                $limit = null;
            } else {
                $highest_limit = -1;
                foreach ($user_roles as $role) {
                    if (isset($role_limits[$role])) {
                        $role_limit_value_raw = $role_limits[$role];
                        if ($role_limit_value_raw === null || $role_limit_value_raw === '') {
                            $highest_limit = null; // Explicitly unlimited for this role, overrides others
                            break;
                        }
                        if ($role_limit_value_raw === '0' || $role_limit_value_raw === 0) {
                            $highest_limit = max($highest_limit, 0); // Found a "disabled" (0) limit
                        } elseif (ctype_digit((string)$role_limit_value_raw)) {
                            $highest_limit = max($highest_limit, (int)$role_limit_value_raw);
                        }
                    }
                }
                $limit = ($highest_limit === -1) ? null : $highest_limit;
            }
        }
        if ($limit === 0 || (is_string($limit) && $limit === '0')) {
            return new WP_Error('token_limit_exceeded_user_logic', __('Access disabled for your account/role.', 'gpt3-ai-content-generator'));
        }
        if ($limit === null || $limit === '') {
            return true;
        } // Unlimited

        $current_usage = (int) get_user_meta($user_id, $usage_key, true);
        $last_reset_time = (int) get_user_meta($user_id, $reset_key, true);
    }

    // Fail-safe reset if due (not relying on cron exclusively for active users)
    if ($reset_period !== 'never' && ($limit !== null && $limit !== '')) { // Only reset if there's a limit
        if (\WPAICG\Core\TokenManager\Reset\IsResetDueLogic($last_reset_time, $reset_period)) { // Call the reset due logic
            $log_context_str = $is_guest ? "Guest {$session_id}" : "User {$user_id}";
            $log_module_str = ($module_context === 'chat') ? "Bot {$context_id_or_bot_id}" : "Module {$module_context}";

            $current_usage = 0;
            $last_reset_time_new = time(); // Use a different var name for new reset time
            if ($is_guest && $guest_context_table_id !== null) {
                // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching -- Caching is not applicable for a write operation (REPLACE). Cache is invalidated after.
                $wpdb->replace($guest_table_name, ['session_id' => $session_id, 'bot_id' => $guest_context_table_id, 'tokens_used' => 0, 'last_reset_timestamp' => $last_reset_time_new, 'last_updated_at' => current_time('mysql', 1)], ['%s', '%d', '%d', '%d', '%s']);
                // Invalidate cache after write
                $cache_key = "aipkit_guest_usage_{$session_id}_{$guest_context_table_id}";
                wp_cache_delete($cache_key, 'aipkit_token_usage');
            } elseif (!$is_guest) {
                update_user_meta($user_id, $usage_key, 0);
                update_user_meta($user_id, $reset_key, $last_reset_time_new);
            }
        }
    }

    // Final Limit Check
    if (($limit !== null && $limit !== '') && $current_usage >= (int)$limit) {
        return new WP_Error('token_limit_exceeded_final_logic', $limit_message);
    }
    return true; // Allowed
}

================================================================================
FUNCION: GetGuestUsageLogic
Resumen (del comentario): Logic to get current token usage and last reset time for a guest. @param AIPKit_Token_Manager $managerInstance The instance of AIPKit_Token_Manager. @param string $session_id The guest's session ID. @param int $guest_context_table_id The context ID for the guest table (bot_id or module identifier). @return array ['current_usage' => int, 'last_reset_time' => int]
CODIGO:
function GetGuestUsageLogic(AIPKit_Token_Manager $managerInstance, string $session_id, int $guest_context_table_id): array {
    global $wpdb;
    $guest_table_name = $wpdb->prefix . GuestTableConstants::GUEST_TABLE_NAME_SUFFIX;
    $current_usage = 0;
    $last_reset_time = 0;

    // Define a unique cache key for this specific guest and context.
    $cache_key = "aipkit_guest_usage_{$session_id}_{$guest_context_table_id}";
    $cache_group = 'aipkit_token_usage';

    // Try to get the cached result first.
    $guest_row = wp_cache_get($cache_key, $cache_group);

    if (false === $guest_row) {
        // Cache miss: Query the database.
        // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.PreparedSQL.InterpolatedNotPrepared -- Reason: Custom table query; unavoidable for this functionality.
        $guest_row = $wpdb->get_row($wpdb->prepare("SELECT tokens_used, last_reset_timestamp FROM {$guest_table_name} WHERE session_id = %s AND bot_id = %d",
            $session_id, $guest_context_table_id
        ), ARRAY_A);

        // Cache the result to avoid future database hits.
        // Cache even if it's null/false to prevent repeated queries for non-existent rows.
        wp_cache_set($cache_key, $guest_row, $cache_group, 300); // Cache for 5 minutes.
    }


    if ($guest_row) {
        $current_usage = (int) $guest_row['tokens_used'];
        $last_reset_time = (int) $guest_row['last_reset_timestamp'];
    }
    return ['current_usage' => $current_usage, 'last_reset_time' => $last_reset_time];
}

================================================================================
FUNCION: UpsertGuestUsageLogic
Resumen (del comentario): Logic to update or insert guest token usage data. @param AIPKit_Token_Manager $managerInstance The instance of AIPKit_Token_Manager. @param string $session_id The guest's session ID. @param int $guest_context_table_id The context ID for the guest table. @param int $new_usage The new total token usage. @param int $last_reset_timestamp The timestamp of the last reset.
CODIGO:
function UpsertGuestUsageLogic(
    AIPKit_Token_Manager $managerInstance,
    string $session_id,
    int $guest_context_table_id,
    int $new_usage,
    int $last_reset_timestamp
): void {
    global $wpdb;
    $guest_table_name = $managerInstance->get_guest_table_name();

    // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching -- Caching is not applicable for a write operation (REPLACE). Cache is invalidated below.
    $upsert_result = $wpdb->replace(
        $guest_table_name,
        [
            'session_id' => $session_id,
            'bot_id' => $guest_context_table_id,
            'tokens_used' => $new_usage,
            'last_reset_timestamp' => $last_reset_timestamp,
            'last_updated_at' => current_time('mysql', 1)
        ],
        ['%s', '%d', '%d', '%d', '%s']
    );

    // After a successful database write, invalidate the corresponding object cache entry
    // to ensure the next read fetches fresh data.
    if ($upsert_result !== false) {
        $cache_key = "aipkit_guest_usage_{$session_id}_{$guest_context_table_id}";
        wp_cache_delete($cache_key, 'aipkit_token_usage');
    }
}

================================================================================
FUNCION: init_hooks
Resumen: Función que maneja $human.
CODIGO:
function init_hooks()
    {
        add_action('wp_ajax_aipkit_get_token_usage_details', [$this, 'ajax_get_token_usage_details']);
    }

================================================================================
FUNCION: ajax_get_token_usage_details
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_token_usage_details()
    {
        check_ajax_referer('aipkit_token_usage_details_nonce', 'nonce');

        if (!is_user_logged_in()) {
            wp_send_json_error(['message' => __('You must be logged in to view details.', 'gpt3-ai-content-generator')], 403);
            return;
        }

        $user_id = get_current_user_id();
        $module = isset($_POST['module']) ? sanitize_key($_POST['module']) : '';
        $context_id = isset($_POST['context_id']) ? absint($_POST['context_id']) : 0;
        $page = isset($_POST['page']) ? absint($_POST['page']) : 1;
        $per_page = 10;

        if (empty($module)) {
            wp_send_json_error(['message' => __('Module not specified.', 'gpt3-ai-content-generator')], 400);
            return;
        }

        global $wpdb;
        $table_name = $wpdb->prefix . 'aipkit_chat_logs';
        $where_clauses = ['user_id = %d', 'module = %s'];
        $params = [$user_id, $module];

        if ($module === 'chat') {
            if (empty($context_id)) {
                wp_send_json_error(['message' => __('Chatbot ID is required.', 'gpt3-ai-content-generator')], 400);
                return;
            }
            $where_clauses[] = 'bot_id = %d';
            $params[] = $context_id;
        } else {
            $where_clauses[] = 'bot_id IS NULL';
        }

        $where_sql = implode(' AND ', $where_clauses);

        // --- Caching for token usage details query ---
        $cache_key = 'aipkit_token_usage_details_' . md5(serialize($params));
        $cache_group = 'aipkit_token_usage';
        $conversations = wp_cache_get($cache_key, $cache_group);

        if (false === $conversations) {
            // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching, WordPress.DB.PreparedSQL.InterpolatedNotPrepared, WordPress.DB.PreparedSQLPlaceholders.UnfinishedPrepare, PluginCheck.Security.DirectDB.UnescapedDBParameter -- Reason: Necessary for fetching and processing usage data from the custom logs table. Caching is implemented.
            $conversations = $wpdb->get_results($wpdb->prepare("SELECT messages FROM {$table_name} WHERE {$where_sql}", $params), ARRAY_A);
            wp_cache_set($cache_key, $conversations, $cache_group, MINUTE_IN_SECONDS); // Cache for 1 minute
        }
        // --- End Caching ---

        $usage_details = [];
        if (!empty($conversations)) {
            foreach ($conversations as $conv) {
                $messages_data = json_decode($conv['messages'], true);
                $messages_array = $messages_data['messages'] ?? ($messages_data ?? []);
                if (is_array($messages_array)) {
                    foreach ($messages_array as $msg) {
                        if (isset($msg['role']) && ($msg['role'] === 'bot' || $msg['role'] === 'assistant') && isset($msg['usage']['total_tokens']) && $msg['usage']['total_tokens'] > 0) {
                            $usage_details[] = [
                                'timestamp' => $msg['timestamp'] ?? 0,
                                'tokens'    => (int) $msg['usage']['total_tokens']
                            ];
                        }
                    }
                }
            }
        }

        // Sort by most recent
        usort($usage_details, fn ($a, $b) => $b['timestamp'] <=> $a['timestamp']);

        $total_items = count($usage_details);
        $total_pages = ceil($total_items / $per_page);
        $offset = ($page - 1) * $per_page;
        $paginated_items = array_slice($usage_details, $offset, $per_page);

        wp_send_json_success([
            'items' => $paginated_items,
            'pagination' => [
                'currentPage' => $page,
                'totalPages'  => $total_pages,
                'totalItems'  => $total_items
            ]
        ]);
    }

================================================================================
FUNCION: render_shortcode
Resumen: Función que maneja $human.
CODIGO:
function render_shortcode($atts = [])
    {
        return TokenUsageRenderer\render_shortcode_logic($this, $atts);
    }

================================================================================
FUNCION: get_user_limit_for_module
Resumen: Función que maneja $human.
CODIGO:
function get_user_limit_for_module(int $user_id, array $module_token_settings): ?int
    {
        return TokenUsageHelpers\get_user_limit_for_module_logic($user_id, $module_token_settings);
    }

================================================================================
FUNCION: get_user_token_usage_data
Resumen: Función que maneja $human.
CODIGO:
function get_user_token_usage_data($user_id)
    {
        return TokenUsageData\get_user_token_usage_data_logic($this, $user_id);
    }

================================================================================
FUNCION: render_dashboard
Resumen: Función que maneja $human.
CODIGO:
function render_dashboard($usage_data, bool $show_chatbot = true, bool $show_aiforms = true, bool $show_imagegenerator = true)
    {
        return TokenUsageRenderer\render_dashboard_logic($this, $usage_data, $show_chatbot, $show_aiforms, $show_imagegenerator);
    }

================================================================================
FUNCION: render_usage_row
Resumen: Función que maneja $human.
CODIGO:
function render_usage_row(array $item, string $first_column_label): string
    {
        return TokenUsageRenderer\render_usage_row_logic($this, $item, $first_column_label);
    }

================================================================================
FUNCION: render_progress_bar
Resumen: Función que maneja $human.
CODIGO:
function render_progress_bar($percentage)
    {
        return TokenUsageRenderer\render_progress_bar_logic($percentage);
    }

================================================================================
FUNCION: __construct
Resumen: Función que maneja $human.
CODIGO:
function __construct($version)
    {
        $this->version = $version;
        if (!class_exists('\\WPAICG\\aipkit_dashboard')) {
            $dashboard_path = WPAICG_PLUGIN_DIR . 'classes/dashboard/class-aipkit_dashboard.php';
            if (file_exists($dashboard_path)) {
                require_once $dashboard_path;
            }
        }
        if (class_exists('\\WPAICG\\aipkit_dashboard')) {
            $module_settings = aipkit_dashboard::get_module_settings();
            $this->is_image_generator_active = !empty($module_settings['image_generator']);
        }
    }

================================================================================
FUNCION: init_hooks
Resumen: Función que maneja $human.
CODIGO:
function init_hooks()
    {
        $this->load_dependencies();
        if ($this->is_token_management_active && $this->token_usage_shortcode) {
            add_shortcode('aipkit_token_usage', [$this->token_usage_shortcode, 'render_shortcode']);
            if (method_exists($this->token_usage_shortcode, 'init_hooks')) {
                $this->token_usage_shortcode->init_hooks();
            }
        }
        if ($this->is_image_generator_active && $this->image_generator_shortcode) {
            add_shortcode('aipkit_image_generator', [$this->image_generator_shortcode, 'render_shortcode']);
        }
        if ($this->is_semantic_search_active && $this->semantic_search_shortcode) {
            add_shortcode('aipkit_semantic_search', [$this->semantic_search_shortcode, 'render_shortcode']);
        }
        add_action('wp_enqueue_scripts', [$this, 'register_and_enqueue_assets']);
    }

================================================================================
FUNCION: load_dependencies
Resumen: Función que maneja $human.
CODIGO:
function load_dependencies()
    {
        if ($this->is_token_management_active) {
            $token_usage_path = WPAICG_PLUGIN_DIR . 'classes/shortcodes/class-aipkit-token-usage-shortcode.php';
            if (file_exists($token_usage_path)) {
                require_once $token_usage_path;
                if (class_exists('\\WPAICG\\Shortcodes\\AIPKit_Token_Usage_Shortcode')) {
                    $this->token_usage_shortcode = new AIPKit_Token_Usage_Shortcode();
                }
            }
        }
        if ($this->is_image_generator_active) {
            $image_gen_path = WPAICG_PLUGIN_DIR . 'classes/shortcodes/class-aipkit-image-generator-shortcode.php';
            if (file_exists($image_gen_path)) {
                require_once $image_gen_path;
                if (class_exists('\\WPAICG\\Shortcodes\\AIPKit_Image_Generator_Shortcode')) {
                    $this->image_generator_shortcode = new AIPKit_Image_Generator_Shortcode();
                }
            }
        }
        if ($this->is_semantic_search_active) {
            $semantic_search_path = WPAICG_PLUGIN_DIR . 'classes/shortcodes/class-aipkit-semantic-search-shortcode.php';
            if (file_exists($semantic_search_path)) {
                require_once $semantic_search_path;
                if (class_exists('\\WPAICG\\Shortcodes\\AIPKit_Semantic_Search_Shortcode')) {
                    $this->semantic_search_shortcode = new AIPKit_Semantic_Search_Shortcode();
                }
            }
        }
    }

================================================================================
FUNCION: register_and_enqueue_assets
Resumen: Función que maneja $human.
CODIGO:
function register_and_enqueue_assets()
    {
        if (is_admin()) {
            return;
        }

        global $post;
        $content = is_a($post, 'WP_Post') ? $post->post_content : '';
        $dist_css_url = WPAICG_PLUGIN_URL . 'dist/css/';
        $dist_js_url = WPAICG_PLUGIN_URL . 'dist/js/';
        $public_main_js_handle = 'aipkit-public-main'; // Central handle for public JS

        $ai_forms_present = has_shortcode($content, 'aipkit_ai_form');
        $force_load_ai_forms = apply_filters('aipkit_enqueue_public_ai_forms_assets', false);
        if ($ai_forms_present || $force_load_ai_forms) {
            $public_ai_forms_css_handle = 'aipkit-public-ai-forms';
            if (!wp_style_is($public_ai_forms_css_handle, 'registered')) {
                wp_register_style(
                    $public_ai_forms_css_handle,
                    $dist_css_url . 'public-ai-forms.bundle.css',
                    [],
                    $this->version
                );
            }
            if (!$this->is_ai_forms_css_enqueued && !wp_style_is($public_ai_forms_css_handle, 'enqueued')) {
                wp_enqueue_style($public_ai_forms_css_handle);
                $this->is_ai_forms_css_enqueued = true;
            }
        }

        if ($this->is_token_management_active && has_shortcode($content, 'aipkit_token_usage')) {
            $token_usage_css_handle = 'aipkit-public-token-usage';
            if (!wp_style_is($token_usage_css_handle, 'registered')) {
                wp_register_style($token_usage_css_handle, $dist_css_url . 'public-token-usage.bundle.css', [], $this->version);
            }
            if (!$this->is_token_usage_css_enqueued && !wp_style_is($token_usage_css_handle, 'enqueued')) {
                wp_enqueue_style($token_usage_css_handle);
                $this->is_token_usage_css_enqueued = true;
            }
        }

        $image_generator_present = $this->is_image_generator_active && has_shortcode($content, 'aipkit_image_generator');
        $force_load_image_gen = apply_filters('aipkit_enqueue_public_image_generator_assets', false);

        if ($image_generator_present || $force_load_image_gen) {
            $public_img_gen_css_handle = 'aipkit-public-image-generator-css';
            if (!wp_style_is($public_img_gen_css_handle, 'registered')) {
                wp_register_style($public_img_gen_css_handle, $dist_css_url . 'public-image-generator.bundle.css', [], $this->version);
            }
            if (!$this->is_image_generator_css_enqueued && !wp_style_is($public_img_gen_css_handle, 'enqueued')) {
                wp_enqueue_style($public_img_gen_css_handle);
                $this->is_image_generator_css_enqueued = true;
            }
        }

        if ($this->is_semantic_search_active && has_shortcode($content, 'aipkit_semantic_search')) {
            $semantic_search_css_handle = 'aipkit-public-semantic-search';
            if (!wp_style_is($semantic_search_css_handle, 'registered')) {
                wp_register_style($semantic_search_css_handle, $dist_css_url . 'public-semantic-search.bundle.css', [], $this->version);
            }
            if (!$this->is_semantic_search_css_enqueued && !wp_style_is($semantic_search_css_handle, 'enqueued')) {
                wp_enqueue_style($semantic_search_css_handle);
                $this->is_semantic_search_css_enqueued = true;
            }
        }

        // Enqueue main public script if any of our shortcodes are present
        if ($ai_forms_present || ($this->is_token_management_active && has_shortcode($content, 'aipkit_token_usage')) || $image_generator_present || ($this->is_semantic_search_active && has_shortcode($content, 'aipkit_semantic_search')) || $force_load_ai_forms || $force_load_image_gen) {
            if (!wp_script_is($public_main_js_handle, 'registered')) {
                wp_register_script($public_main_js_handle, $dist_js_url . 'public-main.bundle.js', ['wp-i18n', 'aipkit_markdown-it'], $this->version, true);
            }
            if (!$this->is_public_main_js_enqueued_by_shortcodes && !wp_script_is($public_main_js_handle, 'enqueued')) {
                wp_enqueue_script($public_main_js_handle);
                wp_set_script_translations($public_main_js_handle, 'gpt3-ai-content-generator', WPAICG_PLUGIN_DIR . 'languages');
                $this->is_public_main_js_enqueued_by_shortcodes = true;
            }
        }

        // --- START FIX: Localize data for Image Generator shortcode ---
        if (($image_generator_present || $force_load_image_gen) && wp_script_is($public_main_js_handle, 'enqueued')) {
            static $image_gen_localized = false;
            if (!$image_gen_localized) {
                if (!class_exists('\\WPAICG\\AIPKit_Providers')) {
                    $providers_path = WPAICG_PLUGIN_DIR . 'classes/dashboard/class-aipkit_providers.php';
                    if (file_exists($providers_path)) {
                        require_once $providers_path;
                    }
                }

                // Get attributes from the shortcode class
                $image_gen_atts = class_exists('\\WPAICG\\Shortcodes\\AIPKit_Image_Generator_Shortcode')
                                  ? AIPKit_Image_Generator_Shortcode::get_current_attributes()
                                  : [];
                $allowed_models_str = $image_gen_atts['allowed_models'] ?? null;


                wp_localize_script($public_main_js_handle, 'aipkit_image_generator_config_public', [
                    'ajaxUrl' => admin_url('admin-ajax.php'),
                    'nonce' => wp_create_nonce('aipkit_image_generator_nonce'),
                    'allowed_models' => $allowed_models_str,
                    'text' => [
                        'generating' => __('Generating...', 'gpt3-ai-content-generator'),
                        'error'      => __('Error generating image.', 'gpt3-ai-content-generator'),
                        'generateButton' => __('Generate Image', 'gpt3-ai-content-generator'),
                        'noPrompt' => __('Please enter a prompt.', 'gpt3-ai-content-generator'),
                        'initialPlaceholder' => __('Generated images will appear here.', 'gpt3-ai-content-generator'),
                        'viewFullImage' => __('Click to view full image', 'gpt3-ai-content-generator'),
                    ],
                    'openai_models' => [
                        ['id' => 'gpt-image-1.5', 'name' => 'GPT Image 1.5'],
                        ['id' => 'gpt-image-1', 'name' => 'GPT Image 1'],
                        ['id' => 'gpt-image-1-mini', 'name' => 'GPT Image 1 mini'],
                        ['id' => 'dall-e-3', 'name' => 'DALL-E 3'],
                        ['id' => 'dall-e-2', 'name' => 'DALL-E 2'],
                    ],
                    'azure_models' => class_exists('\\WPAICG\\AIPKit_Providers') ? AIPKit_Providers::get_azure_image_models() : [],
                    'google_models' => [
                        'image' => (class_exists('\\WPAICG\\AIPKit_Providers') ? AIPKit_Providers::get_google_image_models() : []),
                        'video' => (class_exists('\\WPAICG\\AIPKit_Providers') ? AIPKit_Providers::get_google_video_models() : []),
                    ],
                    'replicate_models' => class_exists('\\WPAICG\\AIPKit_Providers') ? AIPKit_Providers::get_replicate_models() : []
                ]);
                $image_gen_localized = true;
            }
        }
        // --- END FIX ---

        // Localize data for each shortcode if present and script is enqueued
        if ($this->is_token_management_active && has_shortcode($content, 'aipkit_token_usage') && wp_script_is($public_main_js_handle, 'enqueued')) {
            static $token_usage_localized = false;
            if (!$token_usage_localized) {
                wp_localize_script($public_main_js_handle, 'aipkit_token_usage_config', [
                    'ajaxUrl' => admin_url('admin-ajax.php'), 'nonce'   => wp_create_nonce('aipkit_token_usage_details_nonce'),
                    /* translators: %s is the name of the token, e.g. "OpenAI" */
                    'text' => ['loadingDetails' => __('Loading details...', 'gpt3-ai-content-generator'), 'errorLoading' => __('Error loading details.', 'gpt3-ai-content-generator'), 'close' => __('Close', 'gpt3-ai-content-generator'), 'usageDetailsTitle' => __('Usage Details for %s', 'gpt3-ai-content-generator'), 'pageLabel' => __('Page', 'gpt3-ai-content-generator'), 'ofLabel' => __('of', 'gpt3-ai-content-generator'), 'previous' => __('Previous', 'gpt3-ai-content-generator'), 'next' => __('Next', 'gpt3-ai-content-generator'),]
                ]);
                $token_usage_localized = true;
            }
        }
        if ($this->is_semantic_search_active && has_shortcode($content, 'aipkit_semantic_search') && wp_script_is($public_main_js_handle, 'enqueued')) {
            static $semantic_search_localized = false;
            if (!$semantic_search_localized) {
                $opts = get_option('aipkit_options', []);
                $semantic_search_settings = $opts['semantic_search'] ?? [];
                wp_localize_script($public_main_js_handle, 'aipkit_semantic_search_config', [
                    'ajaxUrl' => admin_url('admin-ajax.php'), 'nonce' => wp_create_nonce('aipkit_semantic_search_nonce'),
                    'settings' => $semantic_search_settings,
                    'text' => ['searching' => __('Searching...', 'gpt3-ai-content-generator'), 'error' => __('An error occurred while searching.', 'gpt3-ai-content-generator'),]
                ]);
                $semantic_search_localized = true;
            }
        }
    }

================================================================================
FUNCION: aipkit_create_logs_table
Resumen (del comentario): Database Schema Definitions for AIPKit. Contains functions to create and update plugin-specific database tables. if (!defined('ABSPATH')) { exit; } Creates or updates the chat logs database table. Uses dbDelta for safe table creation/updates. REVISED** Schema: One row per conversation thread, messages stored in JSON. ADDED**: `module` column to track the source.
CODIGO:
function aipkit_create_logs_table()
{
    global $wpdb;
    $table_name = $wpdb->prefix . 'aipkit_chat_logs';
    $charset_collate = $wpdb->get_charset_collate();

    // Use LONGTEXT for messages JSON to store potentially long history
    $sql = "CREATE TABLE $table_name (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        bot_id bigint(20) unsigned DEFAULT NULL,
        user_id bigint(20) unsigned DEFAULT NULL,
        session_id varchar(64) DEFAULT NULL,
        conversation_uuid varchar(36) NOT NULL,
        is_guest tinyint(1) NOT NULL DEFAULT 0,
        module varchar(50) NULL DEFAULT NULL,
        messages longtext NOT NULL,
        message_count int unsigned NOT NULL DEFAULT 0,
        first_message_ts bigint(20) unsigned DEFAULT NULL,
        last_message_ts bigint(20) unsigned DEFAULT NULL,
        ip_address varchar(100) DEFAULT NULL,
        user_wp_role varchar(100) DEFAULT NULL,
        created_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        UNIQUE KEY unique_conversation (bot_id, user_id, session_id, conversation_uuid, module),
        KEY bot_id (bot_id),
        KEY user_id (user_id),
        KEY session_id (session_id),
        KEY conversation_uuid (conversation_uuid),
        KEY is_guest (is_guest),
        KEY module (module),
        KEY last_message_ts (last_message_ts),
        KEY created_at (created_at),
        KEY updated_at (updated_at)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

================================================================================
FUNCION: aipkit_create_guest_token_usage_table
Resumen (del comentario): Creates or updates the guest token usage database table. Uses dbDelta for safe table creation/updates.
CODIGO:
function aipkit_create_guest_token_usage_table()
{
    global $wpdb;
    $table_name = $wpdb->prefix . 'aipkit_guest_token_usage';
    $charset_collate = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE $table_name (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        session_id varchar(64) NOT NULL,
        bot_id bigint(20) unsigned NOT NULL,
        tokens_used bigint(20) unsigned NOT NULL DEFAULT 0,
        last_reset_timestamp bigint(20) unsigned NOT NULL DEFAULT 0,
        last_updated_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        UNIQUE KEY unique_guest_bot (session_id, bot_id),
        KEY session_id (session_id),
        KEY bot_id (bot_id),
        KEY last_reset_timestamp (last_reset_timestamp)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

================================================================================
FUNCION: aipkit_create_sse_message_cache_table
Resumen (del comentario): Creates or updates the SSE message cache database table. Uses dbDelta for safe table creation/updates. Only used if WP Object Cache is not available.
CODIGO:
function aipkit_create_sse_message_cache_table()
{
    global $wpdb;
    $table_name = $wpdb->prefix . 'aipkit_sse_message_cache';
    $charset_collate = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE $table_name (
        cache_key varchar(191) NOT NULL,
        message_content longtext NOT NULL,
        expires_at datetime NOT NULL,
        PRIMARY KEY  (cache_key),
        KEY expires_at (expires_at)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

================================================================================
FUNCION: aipkit_create_vector_data_source_table
Resumen (del comentario): Creates or updates the SSE message cache database table. Uses dbDelta for safe table creation/updates. Only used if WP Object Cache is not available. function aipkit_create_sse_message_cache_table() { global $wpdb; $table_name = $wpdb->prefix . 'aipkit_sse_message_cache'; $charset_collate = $wpdb->get_charset_collate(); $sql = "CREATE TABLE $table_name ( cache_key varchar(191) NOT NULL, message_content longtext NOT NULL, expires_at datetime NOT NULL, PRIMARY KEY (cache_key), KEY expires_at (expires_at) ) $charset_collate;"; require_once(ABSPATH . 'wp-admin/includes/upgrade.php'); dbDelta($sql); } Creates or updates the vector data source table.
CODIGO:
function aipkit_create_vector_data_source_table()
{
    global $wpdb;
    $table_name = $wpdb->prefix . 'aipkit_vector_data_source';
    $charset_collate = $wpdb->get_charset_collate();

    // REMOVED ALL INLINE SQL COMMENTS FOR dbDelta COMPATIBILITY
    $sql = "CREATE TABLE $table_name (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        user_id bigint(20) unsigned DEFAULT NULL,
        timestamp datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
        provider varchar(50) NOT NULL,
        vector_store_id varchar(100) NOT NULL,
        vector_store_name varchar(255) DEFAULT NULL,
        post_id bigint(20) unsigned DEFAULT NULL,
        post_title text DEFAULT NULL,
        status varchar(50) NOT NULL,
        message text DEFAULT NULL,
        indexed_content longtext DEFAULT NULL,
        file_id varchar(100) DEFAULT NULL,
        batch_id varchar(100) DEFAULT NULL,
        embedding_provider varchar(50) DEFAULT NULL,
        embedding_model varchar(100) DEFAULT NULL,
        PRIMARY KEY  (id),
        KEY user_id (user_id),
        KEY timestamp (timestamp),
        KEY provider_store_id (provider, vector_store_id),
        KEY provider_store_time (provider, vector_store_id, timestamp),
        KEY post_id (post_id),
        KEY file_id (file_id),
        KEY status (status),
        KEY embedding_provider (embedding_provider),
        KEY embedding_model (embedding_model)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

================================================================================
FUNCION: aipkit_create_automated_tasks_table
Resumen (del comentario): RENAMED: Creates or updates the automated tasks table.
CODIGO:
function aipkit_create_automated_tasks_table()
{
    global $wpdb;
    $table_name = $wpdb->prefix . 'aipkit_automated_tasks';
    $charset_collate = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE $table_name (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        task_name varchar(255) NOT NULL,
        task_type varchar(50) NOT NULL,
        task_config longtext NOT NULL,
        status varchar(20) NOT NULL DEFAULT 'paused',
        last_run_time datetime DEFAULT NULL,
        next_run_time datetime DEFAULT NULL,
        created_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        KEY task_type (task_type),
        KEY status (status),
        KEY next_run_time (next_run_time)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

================================================================================
FUNCION: aipkit_create_automated_task_queue_table
Resumen (del comentario): RENAMED: Creates or updates the automated task queue table.
CODIGO:
function aipkit_create_automated_task_queue_table()
{
    global $wpdb;
    $table_name = $wpdb->prefix . 'aipkit_automated_task_queue';
    $charset_collate = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE $table_name (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        task_id bigint(20) unsigned NOT NULL,
        target_identifier varchar(255) NOT NULL,
        task_type varchar(50) NOT NULL,
        item_config longtext DEFAULT NULL,
        status varchar(20) NOT NULL DEFAULT 'pending',
        attempts tinyint unsigned NOT NULL DEFAULT 0,
        last_attempt_time datetime DEFAULT NULL,
        error_message text DEFAULT NULL,
        added_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        KEY task_id (task_id),
        KEY target_identifier (target_identifier),
        KEY task_type (task_type),
        KEY status_added_at (status, added_at)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

================================================================================
FUNCION: aipkit_create_content_writer_templates_table
Resumen (del comentario): NEW: Creates or updates the content writer templates table. UPDATED: Added new fields for post settings. UPDATED: Removed post_tags column.
CODIGO:
function aipkit_create_content_writer_templates_table()
{
    global $wpdb;
    $table_name = $wpdb->prefix . 'aipkit_content_writer_templates';
    $charset_collate = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE $table_name (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        user_id bigint(20) unsigned NOT NULL,
        template_name varchar(255) NOT NULL,
        template_type varchar(50) NOT NULL DEFAULT 'content_writer',
        config longtext NOT NULL,
        is_default tinyint(1) NOT NULL DEFAULT 0,
        created_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        post_type varchar(20) DEFAULT 'post',
        post_author bigint(20) unsigned DEFAULT NULL,
        post_status varchar(20) DEFAULT 'draft',
        post_schedule datetime DEFAULT NULL,
        post_categories text DEFAULT NULL,
        PRIMARY KEY  (id),
        UNIQUE KEY user_template_name_type (user_id, template_name, template_type),
        KEY user_id (user_id),
        KEY template_type (template_type),
        KEY is_default (is_default),
        KEY post_type (post_type)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

================================================================================
FUNCION: aipkit_create_rss_history_table
Resumen (del comentario): Creates the RSS history table to prevent re-processing feed items.
CODIGO:
function aipkit_create_rss_history_table()
{
    global $wpdb;
    $table_name = $wpdb->prefix . 'aipkit_rss_history';
    $charset_collate = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE $table_name (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        task_id bigint(20) unsigned NOT NULL,
        item_guid varchar(255) NOT NULL,
        processed_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        UNIQUE KEY unique_task_guid (task_id, item_guid),
        KEY task_id (task_id)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

================================================================================
FUNCION: __construct
Resumen: Función que maneja $human.
CODIGO:
function __construct()
    {
        // --- MODIFIED: Ensure New Token Manager is loaded ---
        if (!class_exists(\WPAICG\Core\TokenManager\AIPKit_Token_Manager::class)) {
            return;
        }
        $this->token_manager = new AIPKit_Token_Manager();
        // --- END MODIFICATION ---
    }

================================================================================
FUNCION: ajax_get_user_credits_data
Resumen: Función que maneja $human.
CODIGO:
function ajax_get_user_credits_data()
    {
        $permission_check = $this->check_module_access_permissions('stats'); // Permissions now live under the Usage/Stats module
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }

        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce is checked in check_module_access_permissions method.
        $current_page = isset($_POST['page']) ? absint($_POST['page']) : 1;
        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce is checked in check_module_access_permissions method.
        $search_term = isset($_POST['search']) ? sanitize_text_field(wp_unslash($_POST['search'])) : '';
        $users_per_page = 20; // Or make this configurable

        $users_data = $this->get_users_with_token_usage($current_page, $users_per_page, $search_term);

        wp_send_json_success($users_data);
    }

================================================================================
FUNCION: ajax_admin_update_token_balance
Resumen: Función que maneja $human.
CODIGO:
function ajax_admin_update_token_balance()
    {
        $permission_check = $this->check_module_access_permissions('stats', 'aipkit_user_credits_nonce');
        if (is_wp_error($permission_check)) {
            $this->send_wp_error($permission_check);
            return;
        }
        // phpcs:ignore WordPress.Security.NonceVerification.Missing -- Nonce is checked in check_module_access_permissions method.
        $post_data = wp_unslash($_POST);

        $user_id = isset($post_data['user_id']) ? absint($post_data['user_id']) : 0;
        $new_balance_raw = isset($post_data['balance']) ? $post_data['balance'] : null;

        if (empty($user_id) || !get_userdata($user_id)) {
            wp_send_json_error(['message' => __('Invalid user ID.', 'gpt3-ai-content-generator')], 400);
            return;
        }
        if ($new_balance_raw === null || !is_numeric($new_balance_raw)) {
            wp_send_json_error(['message' => __('Invalid balance amount. Please provide a number.', 'gpt3-ai-content-generator')], 400);
            return;
        }

        $new_balance = max(0, intval($new_balance_raw));
        update_user_meta($user_id, MetaKeysConstants::TOKEN_BALANCE_META_KEY, $new_balance);

        wp_send_json_success(['message' => __('Token balance updated successfully.', 'gpt3-ai-content-generator'), 'new_balance' => $new_balance]);
    }

================================================================================
FUNCION: get_users_with_token_usage
Resumen: Función que maneja $human.
CODIGO:
function get_users_with_token_usage(int $page = 1, int $number = 20, string $search = ''): array
    {
        global $wpdb;
        $offset = ($page - 1) * $number;

        // --- Base User Query Args ---
        $args = [
            'number' => $number,
            'offset' => $offset,
            'orderby' => 'display_name',
            'order' => 'ASC',
            'count_total' => false,
        ];

        $total_users_for_pagination = 0;
        $all_relevant_bot_ids = [];

        // --- Define Meta Key Prefixes using new constants ---
        $chat_usage_prefix = MetaKeysConstants::CHAT_USAGE_META_KEY_PREFIX;
        $chat_reset_prefix = MetaKeysConstants::CHAT_RESET_META_KEY_PREFIX;
        $img_usage_key = MetaKeysConstants::IMG_USAGE_META_KEY;
        $img_reset_key = MetaKeysConstants::IMG_RESET_META_KEY;
        // --- NEW: Add balance key ---
        $balance_key = MetaKeysConstants::TOKEN_BALANCE_META_KEY;
        // --- END NEW ---

        // --- Fetching Logic ---
        if (!empty($search)) {
            // Searching logic (remains the same, fetches users first)
            $args['search'] = '*' . esc_sql($search) . '*';
            $args['search_columns'] = ['user_login', 'user_email', 'user_nicename', 'display_name'];
            $count_args = $args;
            $count_args['number'] = -1;
            $count_args['offset'] = 0;
            $count_args['fields'] = 'ID';
            $count_query = new WP_User_Query($count_args);
            $total_users_for_pagination = $count_query->get_total();
        } else {
            // Not Searching: Find user IDs with EITHER chat OR image usage OR balance meta
            $chat_usage_like = $wpdb->esc_like($chat_usage_prefix) . '%';
            $cache_key_user_ids = 'aipkit_credits_all_user_ids';
            $cache_group_user_ids = 'aipkit_user_credits';
            $user_ids_with_any_usage = wp_cache_get($cache_key_user_ids, $cache_group_user_ids);

            if (false === $user_ids_with_any_usage) {
                // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching
                $user_ids_with_any_usage = $wpdb->get_col($wpdb->prepare(
                    "SELECT DISTINCT user_id FROM {$wpdb->usermeta} WHERE meta_key LIKE %s OR meta_key LIKE %s OR meta_key = %s OR meta_key = %s OR meta_key = %s ORDER BY user_id",
                    $chat_usage_like,
                    $wpdb->esc_like($chat_reset_prefix) . '%',
                    $img_usage_key,
                    $img_reset_key,
                    $balance_key
                ));
                wp_cache_set($cache_key_user_ids, $user_ids_with_any_usage, $cache_group_user_ids, MINUTE_IN_SECONDS);
            }

            if (empty($user_ids_with_any_usage)) {
                return ['users_data' => [], 'pagination' => ['total_users' => 0, 'total_pages' => 0, 'current_page' => 1, 'per_page' => $number], 'bot_titles' => []];
            }
            $total_users_for_pagination = count($user_ids_with_any_usage);
            $user_ids_to_query = array_slice($user_ids_with_any_usage, $offset, $number);
            if (empty($user_ids_to_query)) {
                return ['users_data' => [], 'pagination' => ['total_users' => $total_users_for_pagination, 'total_pages' => ceil($total_users_for_pagination / $number), 'current_page' => $page, 'per_page' => $number], 'bot_titles' => []];
            }
            $args['include'] = $user_ids_to_query;
        }
        // --- End Fetching Logic ---

        // --- Execute User Query ---
        $user_query = new WP_User_Query($args);
        $users = $user_query->get_results();
        $total_pages = ceil($total_users_for_pagination / $number);
        // --- End User Query ---

        $users_output = [];

        if (!empty($users)) {
            $user_ids = wp_list_pluck($users, 'ID');
            $user_ids_placeholder = implode(',', array_fill(0, count($user_ids), '%d'));

            // --- Fetch ALL relevant meta keys (chat usage, chat reset, image usage, image reset, balance) ---
            $meta_keys_to_fetch_patterns = [
                $wpdb->esc_like($chat_usage_prefix) . '%',
                $wpdb->esc_like($chat_reset_prefix) . '%',
                $img_usage_key,
                $img_reset_key,
                $balance_key // NEW
            ];

            $cache_key_meta = 'aipkit_credits_meta_' . md5(implode(',', $user_ids));
            $cache_group_meta = 'aipkit_user_credits';
            $all_meta = wp_cache_get($cache_key_meta, $cache_group_meta);

            if (false === $all_meta) {
                // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching, WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQL.InterpolatedNotPrepared, WordPress.DB.PreparedSQLPlaceholders.ReplacementsWrongNumber -- The dynamic IN clause is securely built with %d placeholders, and the number of arguments is correctly matched. This is a false positive from the linter.
                $all_meta = $wpdb->get_results($wpdb->prepare("SELECT user_id, meta_key, meta_value FROM {$wpdb->usermeta} WHERE user_id IN ($user_ids_placeholder) AND (meta_key LIKE %s OR meta_key LIKE %s OR meta_key = %s OR meta_key = %s OR meta_key = %s)", array_merge($user_ids, $meta_keys_to_fetch_patterns)), ARRAY_A);
                wp_cache_set($cache_key_meta, $all_meta, $cache_group_meta, MINUTE_IN_SECONDS);
            }
            // --- End Fetch Meta ---

            // --- Process Meta Data ---
            $user_meta_map = [];
            foreach ($all_meta as $meta) {
                $uid = (int) $meta['user_id'];
                if (!isset($user_meta_map[$uid])) {
                    $user_meta_map[$uid] = [];
                }
                $user_meta_map[$uid][$meta['meta_key']] = $meta['meta_value'];

                // Collect bot IDs encountered from CHAT usage/reset keys
                if (strpos($meta['meta_key'], $chat_usage_prefix) === 0 || strpos($meta['meta_key'], $chat_reset_prefix) === 0) {
                    $bot_id_str = preg_replace('/^' . preg_quote($chat_usage_prefix, '/') . '|^' . preg_quote($chat_reset_prefix, '/') . '/', '', $meta['meta_key']);
                    if (ctype_digit($bot_id_str)) {
                        $all_relevant_bot_ids[] = (int) $bot_id_str;
                    }
                }
            }
            // --- End Process Meta ---

            // --- Fetch Bot Titles (remains the same) ---
            $bot_titles = [];
            $unique_bot_ids = array_unique(array_filter($all_relevant_bot_ids));
            if (!empty($unique_bot_ids)) {
                $bot_query_args = [
                    'post_type' => AdminSetup::POST_TYPE, 'post__in' => $unique_bot_ids, 'posts_per_page' => -1,
                    'post_status' => ['publish', 'draft'], 'no_found_rows' => true, 'update_post_meta_cache' => false, 'update_post_term_cache' => false,
                ];
                $bot_posts = get_posts($bot_query_args);
                foreach ($bot_posts as $bot_post) {
                    if (is_object($bot_post) && isset($bot_post->ID) && isset($bot_post->post_title)) {
                        $bot_titles[$bot_post->ID] = $bot_post->post_title;
                    }
                }
            }
            // --- End Fetch Bot Titles ---

            // --- Aggregate User Data ---
            if (!function_exists('WPAICG\Shortcodes\TokenUsage\Data\get_user_purchase_history_logic')) {
                $history_logic_path = WPAICG_PLUGIN_DIR . 'classes/shortcodes/token-usage/data/get_user_purchase_history.php';
                if (file_exists($history_logic_path)) {
                    require_once $history_logic_path;
                }
            }

            foreach ($users as $user) {
                $user_id = $user->ID;
                $user_specific_meta = $user_meta_map[$user_id] ?? [];
                $tokens_used_per_bot = [];
                $last_reset_per_bot = [];
                $total_used_all_bots = 0;
                $token_balance = isset($user_specific_meta[$balance_key]) ? (int)$user_specific_meta[$balance_key] : 0; // NEW

                // Image Generator Specific Data
                $image_usage = ['used' => 0, 'last_reset' => 0];

                foreach ($user_specific_meta as $meta_key => $meta_value) {
                    if (strpos($meta_key, $chat_usage_prefix) === 0) {
                        $bot_id = (int) str_replace($chat_usage_prefix, '', $meta_key);
                        if ($bot_id > 0) {
                            $usage = absint($meta_value);
                            $tokens_used_per_bot[$bot_id] = $usage;
                            $total_used_all_bots += $usage;
                        }
                    } elseif (strpos($meta_key, $chat_reset_prefix) === 0) {
                        $bot_id = (int) str_replace($chat_reset_prefix, '', $meta_key);
                        if ($bot_id > 0) {
                            $last_reset_per_bot[$bot_id] = absint($meta_value);
                        }
                    } elseif ($meta_key === MetaKeysConstants::IMG_USAGE_META_KEY) {
                        $usage = absint($meta_value);
                        $image_usage['used'] = $usage;
                        $total_used_all_bots += $usage;
                    } elseif ($meta_key === MetaKeysConstants::IMG_RESET_META_KEY) {
                        $image_usage['last_reset'] = absint($meta_value);
                    }
                }

                $purchase_history = [];
                if (function_exists('WPAICG\Shortcodes\TokenUsage\Data\get_user_purchase_history_logic') && class_exists('WooCommerce')) {
                    $purchase_history = \WPAICG\Shortcodes\TokenUsage\Data\get_user_purchase_history_logic($user_id);
                }


                $users_output[] = [
                    'id' => $user_id,
                    'display_name' => $user->display_name,
                    'email' => $user->user_email,
                    'token_balance' => $token_balance, // NEW
                    'total_used_all_bots' => $total_used_all_bots,
                    'tokens_used' => $tokens_used_per_bot,
                    'last_reset' => $last_reset_per_bot,
                    'image_usage' => $image_usage,
                    'purchase_history' => $purchase_history,
                ];
            }
            // --- End Aggregate ---
        }

        return [
            'users_data' => $users_output,
            'pagination' => ['total_users' => $total_users_for_pagination, 'total_pages' => $total_pages, 'current_page' => $page, 'per_page' => $number],
            'bot_titles' => $bot_titles,
        ];
    }

================================================================================
FUNCION: __construct
Resumen: Función que maneja $human.
CODIGO:
function __construct()
    {
        global $wpdb;
        $this->wpdb = $wpdb;
        $this->table_name = $wpdb->prefix . 'aipkit_chat_logs';

        // Ensure AIPKit_IP_Anonymization is loaded as it's used by externalized logic
        if (!class_exists(AIPKit_IP_Anonymization::class)) {
            $ip_anon_path = WPAICG_PLUGIN_DIR . 'classes/addons/class-aipkit-ip-anonymization.php';
            if (file_exists($ip_anon_path)) {
                require_once $ip_anon_path;
            }
        }
    }

================================================================================
FUNCION: log_message
Resumen: Función que maneja $human.
CODIGO:
function log_message(array $log_data): array|false
    {
        // --- 1. Basic Validation ---
        if (empty($log_data['conversation_uuid']) || empty($log_data['message_role']) ||
            !isset($log_data['message_content']) || empty($log_data['module']) ||
            (!isset($log_data['user_id']) && empty($log_data['session_id']))
        ) {
            return false;
        }

        // --- 2. Sanitize Core Identifiers ---
        $bot_id = null;
        if (isset($log_data['bot_id'])) {
            if (is_numeric($log_data['bot_id']) && intval($log_data['bot_id']) > 0) {
                $bot_id = absint($log_data['bot_id']);
            } // null, empty string, '0' will result in $bot_id = null
        }
        $user_id           = isset($log_data['user_id']) && $log_data['user_id'] > 0 ? absint($log_data['user_id']) : null;
        $session_id        = $user_id ? null : sanitize_text_field($log_data['session_id'] ?? '');
        $conversation_uuid = sanitize_key($log_data['conversation_uuid']);
        $module            = sanitize_key($log_data['module']);
        $is_guest          = $user_id ? 0 : 1;
        $original_ip = isset($log_data['ip_address']) ? sanitize_text_field($log_data['ip_address']) : null;
        $ip_anonymize = isset($log_data['ip_anonymize']) && in_array($log_data['ip_anonymize'], ['1', 1, true], true);
        $ip_to_store = ($ip_anonymize && class_exists(AIPKit_IP_Anonymization::class))
            ? AIPKit_IP_Anonymization::maybe_anonymize($original_ip, true)
            : $original_ip;
        $user_wp_role = $log_data['user_wp_role'] ?? ($user_id ? implode(', ', wp_get_current_user()->roles) : null);

        // --- 3. Determine Message ID and Timestamp ---
        $current_timestamp = isset($log_data['timestamp']) ? absint($log_data['timestamp']) : time();
        $message_id = isset($log_data['bot_message_id']) && !empty(trim($log_data['bot_message_id']))
                       ? str_replace('.', '', sanitize_key($log_data['bot_message_id']))
                       : (isset($log_data['message_id']) && !empty(trim($log_data['message_id']))
                          ? str_replace('.', '', sanitize_key($log_data['message_id']))
                          : LoggerMethods\generate_message_id_logic());

        // --- 4. Build the New Message Object ---
        $new_message = LoggerMethods\build_message_object_logic($log_data, $message_id, $current_timestamp);

        // --- 5. Find Existing Conversation Row ---
        $where_parts = LoggerMethods\build_where_clauses_logic($conversation_uuid, $module, $bot_id, $user_id, $session_id);
        
        // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQL.InterpolatedNotPrepared, WordPress.DB.PreparedSQLPlaceholders.UnfinishedPrepare -- Reason: $this->table_name is safe (from $wpdb->prefix), and $where_parts['where_sql'] contains placeholders for the prepare method.
        $sql = "SELECT id, messages FROM {$this->table_name} WHERE {$where_parts['where_sql']} LIMIT 1";

        // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQL.InterpolatedNotPrepared, WordPress.DB.PreparedSQLPlaceholders.UnfinishedPrepare, PluginCheck.Security.DirectDB.UnescapedDBParameter -- Reason: $sql is constructed with placeholders and safe variables, and is prepared here.
        $existing_log_row = $this->wpdb->get_row($this->wpdb->prepare($sql, $where_parts['params']), ARRAY_A);

        // --- 6. Update or Insert ---
        if ($existing_log_row) {
            $update_result = LoggerMethods\update_existing_log_logic(
                $this->wpdb,
                $this->table_name,
                $existing_log_row,
                $new_message,
                $current_timestamp,
                $ip_to_store,
                $user_wp_role
            );
            if (is_array($update_result)) {
                $update_result['is_new_session'] = false; // It's an update to an existing log
            }
            return $update_result;
        } else {
            // insert_new_log_logic already sets 'is_new_session' => true
            return LoggerMethods\insert_new_log_logic(
                $this->wpdb,
                $this->table_name,
                $bot_id,
                $user_id,
                $session_id,
                $conversation_uuid,
                $module,
                $is_guest,
                $new_message,
                $current_timestamp,
                $ip_to_store,
                $user_wp_role
            );
        }
    }

================================================================================
FUNCION: log_bot_response_logic
Resumen (del comentario): Logs the final successful bot response. @param \WPAICG\Core\Stream\Processor\SSEStreamProcessor $processorInstance The instance of the processor class. @return void
CODIGO:
function log_bot_response_logic(\WPAICG\Core\Stream\Processor\SSEStreamProcessor $processorInstance): void
{
    $full_bot_response = $processorInstance->get_full_bot_response();
    $log_base_data = $processorInstance->get_log_base_data();
    $error_occurred = $processorInstance->get_error_occurred_status();
    $current_bot_message_id = $processorInstance->get_current_bot_message_id();
    $log_storage = $processorInstance->get_log_storage();
    $current_provider = $processorInstance->get_current_provider();
    $current_model = $processorInstance->get_current_model();
    $final_usage_data = $processorInstance->get_final_usage_data();
    $request_payload_log = $processorInstance->get_request_payload_log();
    $current_stream_context = $processorInstance->get_current_stream_context();
    $current_conversation_uuid = $processorInstance->get_current_conversation_uuid();
    $current_openai_response_id = $processorInstance->get_current_openai_response_id();
    $used_previous_openai_response_id = $processorInstance->get_used_previous_openai_response_id_status();
    $grounding_metadata = $processorInstance->get_grounding_metadata();
    $token_manager = $processorInstance->get_token_manager();
    $vector_search_scores = $processorInstance->get_vector_search_scores();

    if (!$log_storage) {
        return;
    }


    if (!empty($full_bot_response) && !empty($log_base_data) && !$error_occurred && !empty($current_bot_message_id)) {
        $log_bot_data = array_merge($log_base_data, [
            'message_role'    => 'bot',
            'message_content' => $full_bot_response,
            'timestamp'       => time(),
            'ai_provider'     => $current_provider,
            'ai_model'        => $current_model,
            'usage'           => $final_usage_data,
            'message_id'      => $current_bot_message_id,
            'request_payload' => $request_payload_log,
        ]);

        if ($current_provider === 'OpenAI') {
            if ($current_openai_response_id) {
                $log_bot_data['openai_response_id'] = $current_openai_response_id;
            }
            if ($used_previous_openai_response_id) {
                $log_bot_data['used_previous_response_id'] = true;
            }
        }
        if ($current_provider === 'Google' && $grounding_metadata !== null) {
            $log_bot_data['grounding_metadata'] = $grounding_metadata;
        }
        if (!empty($vector_search_scores)) {
            $log_bot_data['vector_search_scores'] = $vector_search_scores;
        }
        $log_storage->log_message($log_bot_data);

        $tokens_consumed = $final_usage_data['total_tokens'] ?? 0;
        if ($token_manager && $tokens_consumed > 0) { // Check if token_manager is available
            $module_for_tokens = $current_stream_context;
            $context_id_for_tokens = null;

            if ($module_for_tokens === 'chat' && !empty($log_base_data['bot_id'])) {
                $context_id_for_tokens = $log_base_data['bot_id'];
            } elseif ($module_for_tokens === 'ai_forms') {
                if ($log_base_data['is_guest']) {
                    $context_id_for_tokens = GuestTableConstants::AI_FORMS_GUEST_CONTEXT_ID;
                } else {
                    $context_id_for_tokens = null; // Correct for logged-in users with a generic AI Forms limit
                }
            } elseif ($module_for_tokens === 'content_writer') {
                if ($log_base_data['is_guest']) {
                    $context_id_for_tokens = GuestTableConstants::CONTENT_WRITER_GUEST_CONTEXT_ID;
                } else {
                    $context_id_for_tokens = null;
                }
            }


            if ($context_id_for_tokens !== null || !$log_base_data['is_guest']) {
                $token_manager->record_token_usage(
                    $log_base_data['user_id'],
                    $log_base_data['session_id'],
                    $context_id_for_tokens,
                    $tokens_consumed,
                    $module_for_tokens
                );
            }
        }

    } elseif (empty($current_bot_message_id)) {
        // Cannot log bot response because current_bot_message_id is empty. This indicates an internal error state.
    } elseif ($error_occurred) {
        // Skipped logging a successful response because an error was flagged earlier in the process.
    } elseif (empty($full_bot_response)) {
        if (function_exists(__NAMESPACE__ . '\log_bot_error_logic')) {
            log_bot_error_logic($processorInstance, "(Empty Response)");
        }
    }
}

================================================================================
FUNCION: __construct
Resumen: Función que maneja $human.
CODIGO:
function __construct(LogStorage $log_storage, AIPKit_Token_Manager $token_manager)
    {
        $this->log_storage = $log_storage;
        $this->token_manager = $token_manager;
    }

================================================================================
FUNCION: log_user_message_initial
Resumen: Función que maneja $human.
CODIGO:
function log_user_message_initial(array $base_log_data, string $user_message_text, ?array $image_inputs_for_service): array|\WP_Error
    {
        $log_user_data = array_merge($base_log_data, [
            'message_role'    => 'user',
            'message_content' => $user_message_text,
            'timestamp'       => time(),
        ]);
        if (!empty($image_inputs_for_service)) {
            $log_user_data['response_data'] = ['type' => 'user_image_upload', 'images' => $image_inputs_for_service];
        }
        $user_log_result = $this->log_storage->log_message($log_user_data);
        if ($user_log_result === false) {
            return new WP_Error('user_log_failed', __('Failed to log user message.', 'gpt3-ai-content-generator'), ['status' => 500]);
        }
        return $user_log_result; // Contains ['log_id', 'message_id', 'is_new_session']
    }

================================================================================
FUNCION: log_and_send_response
Resumen: Función que maneja $human.
CODIGO:
function log_and_send_response(array|WP_Error $ai_result, array $base_log_data, array $bot_settings, ?int $user_id, ?string $session_id): void
    {
        $provider = $bot_settings['provider'] ?? \WPAICG\AIPKit_Providers::get_current_provider(); // For logging

        if (is_wp_error($ai_result)) {
            $error_data = $ai_result->get_error_data();
            $request_payload_on_error = is_array($error_data) ? ($error_data['request_payload_log'] ?? null) : null;
            $log_error_data = array_merge($base_log_data, [
                'message_role'    => 'bot',
                'message_content' => "Error: " . $ai_result->get_error_message(),
                'timestamp'       => time(),
                'ai_provider'     => $provider,
                'ai_model'        => $bot_settings['model'] ?? '',
                'usage'           => null,
                'request_payload' => $request_payload_on_error,
            ]);
            $this->log_storage->log_message($log_error_data);
            $status_code = is_array($error_data) && isset($error_data['status_code']) ? (int)$error_data['status_code'] : 400; // Use status_code
            wp_send_json_error(['message' => $ai_result->get_error_message()], $status_code);
        } else {
            $ai_response = $ai_result['content'] ?? '';
            $usage_data = $ai_result['usage'] ?? null;
            $request_payload_log = $ai_result['request_payload_log'] ?? null;
            $openai_response_id_for_log = $ai_result['openai_response_id'] ?? null;
            $used_previous_id_for_log = $ai_result['used_previous_response_id'] ?? false;
            $grounding_metadata_for_log = $ai_result['grounding_metadata'] ?? null;
            $vector_search_scores_for_log = $ai_result['vector_search_scores'] ?? null;

            $tokens_consumed = $usage_data['total_tokens'] ?? 0;
            if ($tokens_consumed > 0) {
                $this->token_manager->record_token_usage($user_id, $session_id, $bot_settings['bot_id'], $tokens_consumed);
            }

            $log_bot_data = array_merge($base_log_data, [
                'message_role'    => 'bot', 'message_content' => $ai_response, 'timestamp' => time(),
                'ai_provider'     => $provider, 'ai_model' => $bot_settings['model'] ?? '', 'usage' => $usage_data,
                'request_payload' => $request_payload_log, 'openai_response_id' => $openai_response_id_for_log,
                'used_previous_response_id' => $used_previous_id_for_log, 'grounding_metadata' => $grounding_metadata_for_log,
                'vector_search_scores' => $vector_search_scores_for_log,
            ]);
            $bot_log_result = $this->log_storage->log_message($log_bot_data);

            $response_payload = ['reply' => $ai_response, 'message_id' => ($bot_log_result !== false) ? $bot_log_result['message_id'] : null];
            if ($openai_response_id_for_log) {
                $response_payload['openai_response_id'] = $openai_response_id_for_log;
            }
            if ($grounding_metadata_for_log) {
                $response_payload['grounding_metadata'] = $grounding_metadata_for_log;
            }
            wp_send_json_success($response_payload);
        }
    }

================================================================================
FUNCION: send_trigger_json_response
Resumen: Función que maneja $human.
CODIGO:
function send_trigger_json_response(string $status, string $message_to_user, string $message_id): void
    {
        if ($status === 'blocked') {
            wp_send_json_error(['message' => $message_to_user, 'is_trigger_response' => true, 'message_id' => $message_id], 400);
        } elseif ($status === 'ai_stopped') {
            wp_send_json_success(['reply' => $message_to_user, 'is_trigger_response' => true, 'message_id' => $message_id]);
        }
    }

================================================================================
FUNCION: n
Resumen: Función que maneja $human.
CODIGO:
function n(e){e&&e.classList.remove("aipkit_active")}

================================================================================
FUNCION: o
Resumen: Función que maneja $human.
CODIGO:
function o(n,e){if(n.innerHTML="",typeof window.aipkit_assignModuleColors!="function"||typeof window.aipkit_getModuleColor!="function"||typeof window.aipkit_formatChartNumber!="function"||typeof window.aipkit_formatChartDate!="function"||typeof window.aipkit_showStackedTooltip!="function"||typeof window.aipkit_moveChartTooltip!="function"||typeof window.aipkit_hideChartTooltip!="function"){console.error("AIPKit Chart Renderer: Missing required chart utility/color/tooltip functions."),n.innerHTML='<p style="color:red">Error rendering chart: Dependencies missing.</p>';return}let i=Object.keys(e);if(i.length===0){n.innerHTML='<p style="text-align:center; padding:20px;">No data available for chart.</p>';return}let c=new Set;i.forEach(x=>{Object.keys(e[x]).forEach(v=>c.add(v))});let s=Array.from(c);s.sort((x,v)=>{if(x==="Other")return 1;if(v==="Other")return-1;let C=P=>P?r(P.replace(/[-_]/g," ")):"Unknown";return C(x).localeCompare(C(v))}),window.aipkit_assignModuleColors(s);let t=1;i.forEach(x=>{let v=Object.values(e[x]).reduce((C,P)=>C+P,0);v>t&&(t=v)}),t=t*1.05;let d=i.length,a=250,l=s.length>0?Math.max(40,Math.ceil(s.length/3)*20):0,p={top:20,right:20,bottom:30+l,left:50},_=n.clientWidth-p.left-p.right,u=a-p.top-p.bottom,m=Math.max(1,_/d*.8),k=Math.max(0,_/d*.2),f=document.createElementNS(g,"svg");f.setAttribute("viewBox",`0 0 ${n.clientWidth} ${a}`),f.setAttribute("preserveAspectRatio","xMidYMid meet"),f.setAttribute("class","aipkit_token_usage_chart_svg"),f.setAttribute("aria-label","Token usage per module per day chart");let w=document.createElementNS(g,"g");w.setAttribute("transform",`translate(${p.left}, ${p.top})`),f.appendChild(w);let E=document.createElement("div");E.className="aipkit_chart_tooltip",n.style.position="relative",n.appendChild(E);let y=document.createElementNS(g,"g");y.setAttribute("class","aipkit_chart_axis aipkit_chart_axis_y"),w.appendChild(y);let I=document.createElementNS(g,"line");I.setAttribute("x1",0),I.setAttribute("y1",0),I.setAttribute("x2",0),I.setAttribute("y2",u),y.appendChild(I);let S=5;for(let x=0;x<S;x++){let v=Math.round(t*(x/(S-1))),C=u-u*(x/(S-1)),P=document.createElementNS(g,"text");P.setAttribute("x",-5),P.setAttribute("y",C+3),P.setAttribute("class","aipkit_chart_label aipkit_chart_label_y"),P.textContent=window.aipkit_formatChartNumber(v),y.appendChild(P);let $=document.createElementNS(g,"line");$.setAttribute("x1",0),$.setAttribute("y1",C),$.setAttribute("x2",_),$.setAttribute("y2",C),$.setAttribute("class","aipkit_chart_grid_line"),w.insertBefore($,w.firstChild)}let h=document.createElementNS(g,"g");h.setAttribute("class","aipkit_chart_axis aipkit_chart_axis_x"),h.setAttribute("transform",`translate(0, ${u})`),w.appendChild(h);let M=document.createElementNS(g,"line");M.setAttribute("x1",0),M.setAttribute("y1",0),M.setAttribute("x2",_),M.setAttribute("y2",0),h.appendChild(M);let b=Math.max(1,Math.ceil(d/(_/60)));i.forEach((x,v)=>{if(v%b===0||v===d-1){let C=v*(m+k)+m/2+k/2,P=document.createElementNS(g,"text");P.setAttribute("x",C),P.setAttribute("y",p.bottom-l-10),P.setAttribute("class","aipkit_chart_label aipkit_chart_label_x"),P.textContent=window.aipkit_formatChartDate(x),h.appendChild(P)}});let A=document.createElementNS(g,"g");if(w.appendChild(A),i.forEach((x,v)=>{let C=e[x],P=u,$=0;s.filter(D=>C[D]>0).forEach(D=>{let N=C[D]||0;$+=N;let R=N/t*u;P-=R;let j=v*(m+k)+k/2,L=document.createElementNS(g,"rect");L.setAttribute("x",j),L.setAttribute("y",P),L.setAttribute("width",m),L.setAttribute("height",Math.max(.1,R)),L.setAttribute("class","aipkit_chart_bar"),L.setAttribute("fill",window.aipkit_getModuleColor(D)),L.setAttribute("data-date",x),L.setAttribute("data-module",D),L.setAttribute("data-value",N),L.setAttribute("data-daily-total",0),L.addEventListener("mouseenter",K=>window.aipkit_showStackedTooltip(K,E)),L.addEventListener("mousemove",K=>window.aipkit_moveChartTooltip(K,E)),L.addEventListener("mouseleave",()=>window.aipkit_hideChartTooltip(E)),A.appendChild(L)}),A.querySelectorAll(`rect[data-date="${x}"]`).forEach(D=>D.setAttribute("data-daily-total",$))}),s.length>0){let x=document.createElementNS(g,"g");x.setAttribute("class","aipkit_chart_legend"),x.setAttribute("transform",`translate(0, ${u+p.bottom-l+5})`),w.appendChild(x);let v=0,C=0,P=20,$=_,U=35;s.forEach(B=>{let D=r(B.replace(/[-_]/g," ")),R=D.length*7+25+U;v>0&&v+R>$&&(v=0,C+=P);let j=document.createElementNS(g,"g");j.setAttribute("transform",`translate(${v}, ${C})`);let L=document.createElementNS(g,"rect");L.setAttribute("width",10),L.setAttribute("height",10),L.setAttribute("y",-5),L.setAttribute("fill",window.aipkit_getModuleColor(B)),j.appendChild(L);let K=document.createElementNS(g,"text");K.setAttribute("x",15),K.setAttribute("y",0),K.setAttribute("class","aipkit_chart_legend_label"),K.textContent=D,j.appendChild(K),x.appendChild(j),v+=R})}n.appendChild(f)}

================================================================================
FUNCION: r
Resumen: Función que maneja $human.
CODIGO:
function r(n){return n?n.charAt(0).toUpperCase()+n.slice(1):""}

================================================================================
FUNCION: g
Resumen: Función que maneja $human.
CODIGO:
function g(o){let r=document.getElementById("aipkit_token_usage_chart_container");if(!r){console.warn("AIPKit Chart Fetcher: Container not found.");return}if(typeof window.aipkit_apiRequest!="function"||typeof window.aipkit_renderTokenUsageChart!="function"){console.error("AIPKit Chart Fetcher: Missing required API or render functions.");return}let n=r.querySelector(".aipkit_chart_loading_placeholder"),e=r.querySelector(".aipkit_chart_error_placeholder"),i=r.querySelector(".aipkit_chart_nodata_placeholder");e&&(e.style.display="none"),i&&(i.style.display="none"),n&&(n.style.display="flex");let c=[3,7,14,30,90],s=parseInt(o,10);if(!s||isNaN(s)){try{let d=localStorage.getItem("aipkit_stats_period_days"),a=parseInt(d,10);d&&!isNaN(a)&&c.includes(a)&&(s=a)}catch{}let t=document.getElementById("aipkit_stats_period_select");if(t){let d=parseInt(t.value,10);(!s||isNaN(s))&&(s=!isNaN(d)&&c.includes(d)?d:3),c.includes(s)&&String(t.value)!==String(s)&&(t.value=String(s))}else r.dataset.defaultDays?s=parseInt(r.dataset.defaultDays,10)||3:s=3}window.aipkit_apiRequest("aipkit_get_token_usage_chart_data",{days:s}).then(t=>{if(n&&(n.style.display="none"),t&&t.daily_token_data){let d=t.daily_token_data;if(d&&typeof d=="object"&&Object.values(d).some(l=>l&&typeof l=="object"&&Object.values(l).some(p=>Number(p)>0)))window.aipkit_renderTokenUsageChart(r,d);else{let l=t.notice||window.aipkit_dashboard?.text?.chartNoData||"No token usage data found for the selected period.",p=t.manage_logs_url,_=e||i;if(_){_.textContent="";let u=document.createTextNode(l+" ");if(_.appendChild(u),p){let m=document.createElement("a");m.href=p,m.target="_blank",m.rel="noopener noreferrer",m.textContent=window.aipkit_dashboard?.text?.manageLogs||"View stats",_.appendChild(m)}_.style.display="flex"}else{let u=document.createElement("div");u.className="aipkit_chart_error_placeholder",u.textContent=l,r.innerHTML="",r.appendChild(u)}}}else throw new Error("Invalid data received for chart.")}).catch(t=>{if(console.error("AIPKit Chart Fetcher: Error loading data:",t),n&&(n.style.display="none"),e)e.textContent=(window.aipkit_dashboard?.text?.chartError||"Error loading chart data.")+` (${t.message})`,e.style.display="flex";else{let d=document.createElement("div");d.className="aipkit_chart_error_placeholder",d.textContent=(window.aipkit_dashboard?.text?.chartError||"Error loading chart data.")+` (${t.message})`,r.innerHTML="",r.appendChild(d)}})}

================================================================================
FUNCION: g
Resumen: Función que maneja $human.
CODIGO:
function g(o){window.aipkit_dashboard&&(window.aipkit_dashboard.models=window.aipkit_dashboard.models||{},window.aipkit_dashboard.models.openai=o);let r=document.getElementById("aipkit_openai_model"),n=document.querySelectorAll('select[id^="aipkit_bot_"][id$="_openai_model"]');if(!r&&n.length===0){console.warn("OpenAI Sync: No OpenAI model selects found (#aipkit_openai_model or chat selects).");return}if(!o||Object.keys(o).length===0){r.appendChild(new Option("No models found.",""));return}let e=!1,i=["o1 models","o3 models","o4 models","gpt-3.5 models","gpt-4 models","gpt-5 models","fine-tuned models","others"],c=Object.keys(o),s=i.filter(l=>c.includes(l)).concat(c.filter(l=>!i.includes(l)).sort()),t=(l,p)=>{let _=!1;return s.forEach(u=>{let m=o[u]||[];if(m.length===0)return;let k=document.createElement("optgroup");k.label=u,m.sort((f,w)=>(f.name||f.id||"").localeCompare(w.name||w.id||"")),m.forEach(f=>{let w=new Option(f.name||f.id,f.id);f.id===p&&(w.selected=!0,_=!0),k.appendChild(w)}),l.appendChild(k)}),_};if(r){let l=t(r,r.value);if(!l&&r.value&&!r.querySelector(`option[value="${CSS.escape(r.value)}"]`)){let p=new Option(r.value+" (manual)",r.value,!1,!0),_=r.querySelector('optgroup[label="Other"]');_?_.appendChild(p):r.insertBefore(p,r.firstChild),l=!0}if(!l&&r.options.length>0&&r.selectedIndex===-1){let p=-1;for(let _=0;_<r.options.length;_++)if(!r.options[_].disabled&&r.options[_].value){p=_;break}r.selectedIndex=p!==-1?p:0}}n.forEach(l=>{if(!t(l,l.value)&&l.value&&!l.querySelector(`option[value="${CSS.escape(l.value)}"]`)){let _=new Option(l.value+" (manual)",l.value,!1,!0);l.insertBefore(_,l.firstChild)}l.options.length>0&&l.selectedIndex===-1&&(l.selectedIndex=0)});let d=document.getElementById("aipkit_content_writer_provider"),a=document.getElementById("aipkit_content_writer_model");d&&a&&d.value==="openai"&&typeof window.aipkit_populateModelsForContentWriter=="function"&&window.aipkit_populateModelsForContentWriter(d,a)}

================================================================================
FUNCION: o
Resumen: Función que maneja $human.
CODIGO:
function o(r){window.aipkit_dashboard&&(window.aipkit_dashboard.models=window.aipkit_dashboard.models||{},window.aipkit_dashboard.models.openrouter=Array.isArray(r)?r:[]);let n=document.getElementById("aipkit_openrouter_model"),e=document.querySelectorAll('select[id^="aipkit_bot_"][id$="_openrouter_model"]');if(!n&&e.length===0){console.warn("OpenRouter Sync: No OpenRouter model selects found (#aipkit_openrouter_model or chat selects).");return}let i=window.aipkit_dashboard?.recommendedModels?.openrouter||[],c=Array.isArray(i)?i:[],s=a=>{if(!a)return[];let l=g("Recommended","gpt3-ai-content-generator"),p=Array.from(a.querySelectorAll("optgroup")).find(_=>_.label===l||_.label==="Recommended");return p?Array.from(p.querySelectorAll("option")).map(_=>({id:_.value,name:_.textContent.trim()||_.value})).filter(_=>_.id):[]};if(c.length===0){let a=n||e[0];c=s(a)}let t=new Set(c.map(a=>a?.id).filter(Boolean)),d=a=>{let l=a.value;a.innerHTML="";let p=!1,_=!1;if(c.length>0){let k=document.createElement("optgroup");k.label=g("Recommended","gpt3-ai-content-generator"),c.forEach(f=>{if(f&&typeof f=="object"&&f.id){let w=new Option(f.name||f.id,f.id);f.id===l&&(w.selected=!0,p=!0),k.appendChild(w)}}),k.children.length>0&&(a.appendChild(k),_=!0)}if(!r||!r.length){_||a.appendChild(new Option("No models found.",""));return}let u={};if(r.forEach(k=>{if(!k||!k.id||t.has(k.id))return;let f=k.id.split("/"),w=(f.length>1?f[0]:"other").toLowerCase();u[w]||(u[w]=[]),u[w].push(k)}),Object.keys(u).sort().forEach(k=>{let f=document.createElement("optgroup");f.label=k.charAt(0).toUpperCase()+k.slice(1),u[k].sort((w,E)=>(w.name||"").localeCompare(E.name||"")),u[k].forEach(w=>{let E=new Option(w.name||w.id,w.id);w.id===l&&(E.selected=!0,p=!0),f.appendChild(E)}),f.children.length>0&&(a.appendChild(f),_=!0)}),!p&&l&&!a.querySelector(`option[value="${CSS.escape(l)}"]`)){let k=new Option(l+" (manual)",l,!1,!0);a.insertBefore(k,a.firstChild)}if(!p&&a.options.length>0&&a.selectedIndex===-1){let k=-1;for(let f=0;f<a.options.length;f++)if(!a.options[f].disabled&&a.options[f].value){k=f;break}a.selectedIndex=k!==-1?k:0}};n&&d(n),e.forEach(d)}

================================================================================
FUNCION: o
Resumen: Función que maneja $human.
CODIGO:
function o(r){let n=document.getElementById("aipkit_google_model"),e=document.querySelectorAll('select[id^="aipkit_bot_"][id$="_google_model"]');if(!n&&e.length===0){console.warn("Google Sync: No Google model selects found (#aipkit_google_model or chat selects).");return}let i=window.aipkit_dashboard?.recommendedModels?.google||[],c=Array.isArray(i)?i:[],s=l=>{if(!l)return[];let p=g("Recommended","gpt3-ai-content-generator"),_=Array.from(l.querySelectorAll("optgroup")).find(u=>u.label===p||u.label==="Recommended");return _?Array.from(_.querySelectorAll("option")).map(u=>({id:u.value,name:u.textContent.trim()||u.value})).filter(u=>u.id):[]};if(c.length===0){let l=n||e[0];c=s(l)}let t=new Set(c.map(l=>l?.id).filter(Boolean)),d=Array.isArray(r)?r.slice():[];d.sort((l,p)=>(l.name||l.id||"").localeCompare(p.name||p.id||""));let a=l=>{let p=l.value;l.innerHTML="";let _=!1,u=!1,m=c.length>0?document.createElement("optgroup"):null;if(m&&(m.label=g("All models","gpt3-ai-content-generator")),c.length>0){let k=document.createElement("optgroup");k.label=g("Recommended","gpt3-ai-content-generator"),c.forEach(f=>{if(f&&typeof f=="object"&&f.id){let w=new Option(f.name||f.id,f.id);(f.id===p||`models/${f.id}`===p)&&(w.selected=!0,_=!0),k.appendChild(w)}}),k.children.length>0&&(l.appendChild(k),u=!0)}if(!d.length){u||l.appendChild(new Option("No models found.",""));return}if(d.forEach(k=>{let f=k.id||"",w=k.name||f;if(!f||t.has(f))return;let E=new Option(w,f);(f===p||`models/${f}`===p)&&(E.selected=!0,_=!0),m?m.appendChild(E):(l.appendChild(E),u=!0)}),m&&m.children.length>0&&(l.appendChild(m),u=!0),!_&&p){let k=p.startsWith("models/")?p.substring(7):p;if(!l.querySelector(`option[value="${CSS.escape(k)}"]`)){let f=k,w=new Option(f+" (manual)",p,!1,!0);l.insertBefore(w,l.firstChild),l.value=p}}if(l.options.length>0&&l.selectedIndex===-1){let k=-1;for(let f=0;f<l.options.length;f++)if(!l.options[f].disabled&&l.options[f].value){k=f;break}l.selectedIndex=k!==-1?k:0}};n&&a(n),e.forEach(a)}

================================================================================
FUNCION: g
Resumen: Función que maneja $human.
CODIGO:
ion r(e,i){if(!i)return;let c=i.parentElement;if(!c)return;let s=c.getBoundingClientRect(),t=e.clientX-s.left,d=e.clientY-s.top,a=i.offsetWidth,l=i.offsetHeight,p=t+15,_=d-l-10;p+a>s.width-5&&(p=t-a-15),p<5&&(p=5),_<5&&(_=d+15),_+l>s.height-5&&(_=s.height-l-5),i.style.left=`${p}px`,i.style.top=`${_}px`,i.style.transform="translate(0, 0)"}function n(e){e&&e.classList.remove("aipkit_active")}window.aipkit_showStackedTooltip=g,window.aipkit_moveChartTooltip=r,window.aipkit_hideChartTooltip=n})();(function(){"use strict";let g="http://www.w3.org/2000/svg";function o(n,e){if(n.innerHTML="",typeof window.aipkit_assignModuleColors!="function"||typeof window.aipkit_getModuleColor!="function"||typeof window.aipkit_formatChartNumber!="function"||typeof window.aipkit_formatChartDate!="function"||typeof window.aipkit_showStackedTooltip!="function"||typeof window.aipkit_moveChartTooltip!="function"||typeof window.aipkit_hideChartTooltip!="function"){console.error("AIPKit Chart Renderer: Missing required chart utility/color/tooltip functions."),n.innerHTML='<p style="color:red">Error rendering chart: Dependencies missing.</p>';return}let i=Object.keys(e);if(i.length===0){n.innerHTML='<p style="text-align:center; padding:20px;">No data available for chart.</p>';return}let c=new Set;i.forEach(x=>{Object.keys(e[x]).forEach(v=>c.add(v))});let s=Array.from(c);s.sort((x,v)=>{if(x==="Other")return 1;if(v==="Other")return-1;let C=P=>P?r(P.replace(/[-_]/g," ")):"Unknown";return C(x).localeCompare(C(v))}),window.aipkit_assignModuleColors(s);let t=1;i.forEach(x=>{let v=Object.values(e[x]).reduce((C,P)=>C+P,0);v>t&&(t=v)}),t=t*1.05;let d=i.length,a=250,l=s.length>0?Math.max(40,Math.ceil(s.length/3)*20):0,p={top:20,right:20,bottom:30+l,left:50},_=n.clientWidth-p.left-p.right,u=a-p.top-p.bottom,m=Math.max(1,_/d*.8),k=Math.max(0,_/d*.2),f=document.createElementNS(g,"svg");f.setAttribute("viewBox",`0 0 ${n.clientWidth} ${a}`),f.setAttribute("preserveAspectRatio","xMidYMid meet"),f.setAttribute("class","aipkit_token_usage_chart_svg"),f.setAttribute("aria-label","Token usage per module per day chart");let w=document.createElementNS(g,"g");w.setAttribute("transform",`translate(${p.left}, ${p.top})`),f.appendChild(w);let E=document.createElement("div");E.className="aipkit_chart_tooltip",n.style.position="relative",n.appendChild(E);let y=document.createElementNS(g,"g");y.setAttribute("class","aipkit_chart_axis aipkit_chart_axis_y"),w.appendChild(y);let I=document.createElementNS(g,"line");I.setAttribute("x1",0),I.setAttribute("y1",0),I.setAttribute("x2",0),I.setAttribute("y2",u),y.appendChild(I);let S=5;for(let x=0;x<S;x++){let v=Math.round(t*(x/(S-1))),C=u-u*(x/(S-1)),P=document.createElementNS(g,"text");P.setAttribute("x",-5),P.setAttribute("y",C+3),P.setAttribute("class","aipkit_chart_label aipkit_chart_label_y"),P.textContent=window.aipkit_formatChartNumber(v),y.appendChild(P);let $=document.createElementNS(g,"line");$.setAttribute("x1",0),$.setAttribute("y1",C),$.setAttribute("x2",_),$.setAttribute("y2",C),$.setAttribute("class","aipkit_chart_grid_line"),w.insertBefore($,w.firstChild)}let h=document.createElementNS(g,"g");h.setAttribute("class","aipkit_chart_axis aipkit_chart_axis_x"),h.setAttribute("transform",`translate(0, ${u})`),w.appendChild(h);let M=document.createElementNS(g,"line");M.setAttribute("x1",0),M.setAttribute("y1",0),M.setAttribute("x2",_),M.setAttribute("y2",0),h.appendChild(M);let b=Math.max(1,Math.ceil(d/(_/60)));i.forEach((x,v)=>{if(v%b===0||v===d-1){let C=v*(m+k)+m/2+k/2,P=document.createElementNS(g,"text");P.setAttribute("x",C),P.setAttribute("y",p.bottom-l-10),P.setAttribute("class","aipkit_chart_label aipkit_chart_label_x"),P.textContent=window.aipkit_formatChartDate(x),h.appendChild(P)}});let A=document.createElementNS(g,"g");if(w.appendChild(A),i.forEach((x,v)=>{let C=e[x],P=u,$=0;s.filter(D=>C[D]>0).forEach(D=>{let N=C[D]||0;$+=N;let R=N/t*u;P-=R;let j=v*(m+k)+k/2,L=document.createElementNS(g,"rect");L.setAttribute("x",j),L.setAttribute("y",P),L.setAttribute("width",m),L.setAttribute("height",Math.max(.1,R)),L.setAttribute("class","aipkit_chart_bar"),L.setAttribute("fill",window.aipkit_getModuleColor(D)),L.setAttribute("data-date",x),L.setAttribute("data-module",D),L.setAttribute("data-value",N),L.setAttribute("data-daily-total",0),L.addEventListener("mouseenter",K=>window.aipkit_showStackedTooltip(K,E)),L.addEventListener("mousemove",K=>window.aipkit_moveChartTooltip(K,E)),L.addEventListener("mouseleave",()=>window.aipkit_hideChartTooltip(E)),A.appendChild(L)}),A.querySelectorAll(`rect[data-date="${x}"]`).forEach(D=>D.setAttribute("data-daily-total",$))}),s.length>0){let x=document.createElementNS(g,"g");x.setAttribute("class","aipkit_chart_legend"),x.setAttribute("transform",`translate(0, ${u+p.bottom-l+5})`),w.appendChild(x);let v=0,C=0,P=20,$=_,U=35;s.forEach(B=>{let D=r(B.replace(/[-_]/g," ")),R=D.length*7+25+U;v>0&&v+R>$&&(v=0,C+=P);let j=document.createElementNS(g,"g");j.setAttribute("transform",`translate(${v}, ${C})`);let L=document.createElementNS(g,"rect");L.setAttribute("width",10),L.setAttribute("height",10),L.setAttribute("y",-5),L.setAttribute("fill",window.aipkit_getModuleColor(B)),j.appendChild(L);let K=document.createElementNS(g,"text");K.setAttribute("x",15),K.setAttribute("y",0),K.setAttribute("class","aipkit_chart_legend_label"),K.textContent=D,j.appendChild(K),x.appendChild(j),v+=R})}n.appendChild(f)}function r(n){return n?n.charAt(0).toUpperCase()+n.slice(1):""}window.aipkit_renderTokenUsageChart=o})();(function(){"use strict";function g(o){let r=document.getElementById("aipkit_token_usage_chart_container");if(!r){console.warn("AIPKit Chart Fetcher: Container not found.");return}if(typeof window.aipkit_apiRequest!="function"||typeof window.aipkit_renderTokenUsageChart!="function"){console.error("AIPKit Chart Fetcher: Missing required API or render functions.");return}let n=r.querySelector(".aipkit_chart_loading_placeholder"),e=r.querySelector(".aipkit_chart_error_placeholder"),i=r.querySelector(".aipkit_chart_nodata_placeholder");e&&(e.style.display="none"),i&&(i.style.display="none"),n&&(n.style.display="flex");let c=[3,7,14,30,90],s=parseInt(o,10);if(!s||isNaN(s)){try{let d=localStorage.getItem("aipkit_stats_period_days"),a=parseInt(d,10);d&&!isNaN(a)&&c.includes(a)&&(s=a)}catch{}let t=document.getElementById("aipkit_stats_period_select");if(t){let d=parseInt(t.value,10);(!s||isNaN(s))&&(s=!isNaN(d)&&c.includes(d)?d:3),c.includes(s)&&String(t.value)!==String(s)&&(t.value=String(s))}else r.dataset.defaultDays?s=parseInt(r.dataset.defaultDays,10)||3:s=3}window.aipkit_apiRequest("aipkit_get_token_usage_chart_data",{days:s}).then(t=>{if(n&&(n.style.display="none"),t&&t.daily_token_data){let d=t.daily_token_data;if(d&&typeof d=="object"&&Object.values(d).some(l=>l&&typeof l=="object"&&Object.values(l).some(p=>Number(p)>0)))window.aipkit_renderTokenUsageChart(r,d);else{let l=t.notice||window.aipkit_dashboard?.text?.chartNoData||"No token usage data found for the selected period.",p=t.manage_logs_url,_=e||i;if(_){_.textContent="";let u=document.createTextNode(l+" ");if(_.appendChild(u),p){let m=document.createElement("a");m.href=p,m.target="_blank",m.rel="noopener noreferrer",m.textContent=window.aipkit_dashboard?.text?.manageLogs||"View stats",_.appendChild(m)}_.style.display="flex"}else{let u=document.createElement("div");u.className="aipkit_chart_error_placeholder",u.textContent=l,r.innerHTML="",r.appendChild(u)}}}else throw new Error("Invalid data received for chart.")}).catch(t=>{if(console.error("AIPKit Chart Fetcher: Error loading data:",t),n&&(n.style.display="none"),e)e.textContent=(window.aipkit_dashboard?.text?.chartError||"Error loading chart data.")+` (${t.message})`,e.style.display="flex";else{let d=document.createElement("div");d.className="aipkit_chart_error_placeholder",d.textContent=(window.aipkit_dashboard?.text?.chartError||"Error loading chart data.")+` (${t.message})`,r.innerHTML="",r.appendChild(d)}})}window.aipkit_loadTokenUsageChart=g,document.addEventListener("change",function(o){let r=o.target;if(r&&r.id==="aipkit_stats_period_select"){let n=parseInt(r.value,10)||7;typeof window.aipkit_loadTokenUsageChart=="function"&&window.aipkit_loadTokenUsageChart(n);try{[3,7,14,30,90].includes(n)&&localStorage.setItem("aipkit_stats_period_days",String(n))}catch{}}})})();(function(){"use strict";function g(o){window.aipkit_dashboard&&(window.aipkit_dashboard.models=window.aipkit_dashboard.models||{},window.aipkit_dashboard.models.openai=o);let r=document.getElementById("aipkit_openai_model"),n=document.querySelectorAll('select[id^="aipkit_bot_"][id$="_openai_model"]');if(!r&&n.length===0){console.warn("OpenAI Sync: No OpenAI model selects found (#aipkit_openai_model or chat selects).");return}if(!o||Object.keys(o).length===0){r.appendChild(new Option("No models found.",""));return}let e=!1,i=["o1 models","o3 models","o4 models","gpt-3.5 models","gpt-4 models","gpt-5 models","fine-tuned models","others"],c=Object.keys(o),s=i.filter(l=>c.includes(l)).concat(c.filter(l=>!i.includes(l)).sort()),t=(l,p)=>{let _=!1;return s.forEach(u=>{let m=o[u]||[];if(m.length===0)return;let k=document.createElement("optgroup");k.label=u,m.sort((f,w)=>(f.name||f.id||"").localeCompare(w.name||w.id||"")),m.forEach(f=>{let w=new Option(f.name||f.id,f.id);f.id===p&&(w.selected=!0,_=!0),k.appendChild(w)}),l.appendChild(k)}),_};if(r){let l=t(r,r.value);if(!l&&r.value&&!r.querySelector(`option[value="${CSS.escape(r.value)}"]`)){let p=new Option(r.value+" (manual)",r.value,!1,!0),_=r.querySelector('optgroup[label="Other"]');_?_.appendChild(p):r.insertBefore(p,r.firstChild),l=!0}if(!l&&r.options.length>0&&r.selectedIndex===-1){let p=-1;for(let _=0;_<r.options.length;_++)if(!r.options[_].disabled&&r.options[_].value){p=_;break}r.selectedIndex=p!==-1?p:0}}n.forEach(l=>{if(!t(l,l.value)&&l.value&&!l.querySelector(`option[value="${CSS.escape(l.value)}"]`)){let _=new Option(l.value+" (manual)",l.value,!1,!0);l.insertBefore(_,l.firstChild)}l.options.length>0&&l.selectedIndex===-1&&(l.selectedIndex=0)});let d=document.getElementById("aipkit_content_writer_provider"),a=document.getElementById("aipkit_content_writer_model");d&&a&&d.value==="openai"&&typeof window.aipkit_populateModelsForContentWriter=="function"&&window.aipkit_populateModelsForContentWriter(d,a)}window.aipkit_updateOpenAIModels=g})();(function(){"use strict";let g=window.wp?.i18n?.__||function(r){return r};function o(r){window.aipkit_dashboard&&(window.aipkit_dashboard.models=window.aipkit_dashboard.models||{},window.aipkit_dashboard.models.openrouter=Array.isArray(r)?r:[]);let n=document.getElementById("aipkit_openrouter_model"),e=document.querySelectorAll('select[id^="aipkit_bot_"][id$="_openrouter_model"]');if(!n&&e.length===0){console.warn("OpenRouter Sync: No OpenRouter model selects found (#aipkit_openrouter_model or chat selects).");return}let i=window.aipkit_dashboard?.recommendedModels?.openrouter||[],c=Array.isArray(i)?i:[],s=a=>{if(!a)return[];let l=g("Recommended","gpt3-ai-content-generator"),p=Array.from(a.querySelectorAll("optgroup")).find(_=>_.label===l||_.label==="Recommended");return p?Array.from(p.querySelectorAll("option")).map(_=>({id:_.value,name:_.textContent.trim()||_.value})).filter(_=>_.id):[]};if(c.length===0){let a=n||e[0];c=s(a)}let t=new Set(c.map(a=>a?.id).filter(Boolean)),d=a=>{let l=a.value;a.innerHTML="";let p=!1,_=!1;if(c.length>0){let k=document.createElement("optgroup");k.label=g("Recommended","gpt3-ai-content-generator"),c.forEach(f=>{if(f&&typeof f=="object"&&f.id){let w=new Option(f.name||f.id,f.id);f.id===l&&(w.selected=!0,p=!0),k.appendChild(w)}}),k.children.length>0&&(a.appendChild(k),_=!0)}if(!r||!r.length){_||a.appendChild(new Option("No models found.",""));return}let u={};if(r.forEach(k=>{if(!k||!k.id||t.has(k.id))return;let f=k.id.split("/"),w=(f.length>1?f[0]:"other").toLowerCase();u[w]||(u[w]=[]),u[w].push(k)}),Object.keys(u).sort().forEach(k=>{let f=document.createElement("optgroup");f.label=k.charAt(0).toUpperCase()+k.slice(1),u[k].sort((w,E)=>(w.name||"").localeCompare(E.name||"")),u[k].forEach(w=>{let E=new Option(w.name||w.id,w.id);w.id===l&&(E.selected=!0,p=!0),f.appendChild(E)}),f.children.length>0&&(a.appendChild(f),_=!0)}),!p&&l&&!a.querySelector(`option[value="${CSS.escape(l)}"]`)){let k=new Option(l+" (manual)",l,!1,!0);a.insertBefore(k,a.firstChild)}if(!p&&a.options.length>0&&a.selectedIndex===-1){let k=-1;for(let f=0;f<a.options.length;f++)if(!a.options[f].disabled&&a.options[f].value){k=f;break}a.selectedIndex=k!==-1?k:0}};n&&d(n),e.forEach(d)}window.aipkit_updateOpenRouterModels=o})();(function(){"use strict";let g=window.wp?.i18n?.__||function(r){return r};function o(r){let n=document.getElementById("aipkit_google_model"),e=document.querySelectorAll('select[id^="aipkit_bot_"][id$="_google_model"]');if(!n&&e.length===0){console.warn("Google Sync: No Google model selects found (#aipkit_google_model or chat selects).");return}let i=window.aipkit_dashboard?.recommendedModels?.google||[],c=Array.isArray(i)?i:[],s=l=>{if(!l)return[];let p=g("Recommended","gpt3-ai-content-generator"),_=Array.from(l.querySelectorAll("optgroup")).find(u=>u.label===p||u.label==="Recommended");return _?Array.from(_.querySelectorAll("option")).map(u=>({id:u.value,name:u.textContent.trim()||u.value})).filter(u=>u.id):[]};if(c.length===0){let l=n||e[0];c=s(l)}let t=new Set(c.map(l=>l?.id).filter(Boolean)),d=Array.isArray(r)?r.slice():[];d.sort((l,p)=>(l.name||l.id||"").localeCompare(p.name||p.id||""));let a=l=>{let p=l.value;l.innerHTML="";let _=!1,u=!1,m=c.length>0?document.createElement("optgroup"):null;if(m&&(m.label=g("All models","gpt3-ai-content-generator")),c.length>0){let k=document.createElement("optgroup");k.label=g("Recommended","gpt3-ai-content-generator"),c.forEach(f=>{if(f&&typeof f=="object"&&f.id){let w=new Option(f.name||f.id,f.id);(f.id===p||`models/${f.id}`===p)&&(w.selected=!0,_=!0),k.appendChild(w)}}),k.children.length>0&&(l.appendChild(k),u=!0)}if(!d.length){u||l.appendChild(new Option("No models found.",""));return}if(d.forEach(k=>{let f=k.id||"",w=k.name||f;if(!f||t.has(f))return;let E=new Option(w,f);(f===p||`models/${f}`===p)&&(E.selected=!0,_=!0),m?m.appendChild(E):(l.appendChild(E),u=!0)}),m&&m.children.length>0&&(l.appendChild(m),u=!0),!_&&p){let k=p.startsWith("models/")?p.substring(7):p;if(!l.querySelector(`option[value="${CSS.escape(k)}"]`)){let f=k,w=new Option(f+" (manual)",p,!1,!0);l.insertBefore(w,l.firstChild),l.value=p}}if(l.options.length>0&&l.selectedIndex===-1){let k=-1;for(let f=0;f<l.options.length;f++)if(!l.options[f].disabled&&l.options[f].value){k=f;break}l.selectedIndex=k!==-1?k:0}};n&&a(n),e.forEach(a)}window.aipkit_updateGoogleModels=o})();(function(){"use strict";function g(o){let r=document.getElementById("aipkit_azure_deployment"),n=document.querySelectorAll('select[id^="aipkit_bot_"][id$="_azure_deployment"]');if(!r&&n.length===0){console.warn("Azure Sync: No Azure deployment selects found (#aipkit_azure_deployment or chat selects).");return}let e=i=>{let c=i.value;i.innerHTML="";let s=o&&typeof o=="object"&&!Array.isArray(o)&&(o["Chat Models"]||o["Embedding Models"]||o["Image Models"]);if(!o||Array.isArray(o)&&!o.length||s&&Object.keys(o).length===0){if(r.appendChild(new Option("No deployments found.","")),c){let d=new Option(c+" (manual)",c,!1,!0);r.appendChild(d),r.value=c}return}let t=!1;if(s)Object.keys(o).forEach(d=>{let a=o[d];if(a&&Array.isArray(a)&&a.length>0){let l=document.createElement("optgroup");l.label=d,a.sort((p,_)=>(p.id||"").localeCompare(_.id||"")),a.forEach(p=>{let _=p.id||"",u=p.name||_;if(!_)return;let m=_+(u&&u!==_?` (model: ${u})`:""),k=new Option(m,_);_===c&&(k.selected=!0,t=!0),l.appendChild(k)}),i.appendChild(l)}});else{let d=Array.isArray(o)?o:[];d.sort((a,l)=>(a.id||"").localeCompare(l.id||"")),d.forEach(a=>{let l=a.id||"",p=a.name||l;if(!l)return;let _=l+(p&&p!==l?` (model: ${p})`:""),u=new Option(_,l);l===c&&(u.selec

================================================================================
FUNCION: n
Resumen: Función que maneja $human.
CODIGO:
function n(i,o,t,a,r,s,l,p,d,u,_,f){let m=0;s&&(s.textContent=_.generatingVideo||"Generating Video..."),r.innerHTML='<p class="aipkit_image_results_placeholder" style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;"></span> Video generation in progress...</p>';function g(){if(m>=60){r.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Video generation timed out. Please try again.</p>',a.disabled=!1,s&&(s.textContent=p),l&&(l.style.display="none");return}m++;let k=Math.min(m/60*100,95);r.innerHTML=`<p class="aipkit_image_results_placeholder" style="text-align:center;">
        <span class="aipkit_spinner" style="display:inline-block;"></span> 
        Generating video... (${Math.round(k)}%)
      </p>`;let y=new FormData;y.append("action","aipkit_check_video_status"),y.append("_ajax_nonce",t),y.append("operation_name",i),y.append("model_id",o),y.append("prompt",u),fetch(window.aipkit_image_generator_config_public.ajaxUrl,{method:"POST",body:y,credentials:"same-origin"}).then(I=>I.json()).then(I=>{if(I.success)if(I.data.status==="completed")e(I.data,a,r,s,l,p,d,u,_,f);else if(I.data.status==="processing")setTimeout(g,5e3);else throw new Error(`Unknown status: ${I.data.status}`);else throw new Error(I.data?.message||"Status check failed")}).catch(I=>{console.error("AIPKit Video Status Check Error:",I),r.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">Video generation failed: ${f(I.message||"Unknown error")}</p>`,a.disabled=!1,s&&(s.textContent=p),l&&(l.style.display="none")})}setTimeout(g,5e3)}

================================================================================
FUNCION: g
Resumen: Función que maneja $human.
CODIGO:
function g(){if(m>=60){r.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Video generation timed out. Please try again.</p>',a.disabled=!1,s&&(s.textContent=p),l&&(l.style.display="none");return}m++;let k=Math.min(m/60*100,95);r.innerHTML=`<p class="aipkit_image_results_placeholder" style="text-align:center;">
        <span class="aipkit_spinner" style="display:inline-block;"></span> 
        Generating video... (${Math.round(k)}%)
      </p>`;let y=new FormData;y.append("action","aipkit_check_video_status"),y.append("_ajax_nonce",t),y.append("operation_name",i),y.append("model_id",o),y.append("prompt",u),fetch(window.aipkit_image_generator_config_public.ajaxUrl,{method:"POST",body:y,credentials:"same-origin"}).then(I=>I.json()).then(I=>{if(I.success)if(I.data.status==="completed")e(I.data,a,r,s,l,p,d,u,_,f);else if(I.data.status==="processing")setTimeout(g,5e3);else throw new Error(`Unknown status: ${I.data.status}`);else throw new Error(I.data?.message||"Status check failed")}).catch(I=>{console.error("AIPKit Video Status Check Error:",I),r.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">Video generation failed: ${f(I.message||"Unknown error")}</p>`,a.disabled=!1,s&&(s.textContent=p),l&&(l.style.display="none")})}

================================================================================
FUNCION: e
Resumen: Función que maneja $human.
CODIGO:
function e(i,o,t,a,r,s,l,p,d,u){let _=i.images||i.videos||[];if(_.length>0)t.innerHTML="",_.forEach(f=>{let w=document.createElement("div");w.className=l?"aipkit_video_result":"aipkit_image_result";let h="",m=f.media_library_url||f.url||null,g=l?d.viewFullVideo||"Click to view full video":d.viewFullImage||"Click to view full image";if(l)if(f.url){let k=`<video controls preload="metadata" style="max-width: 100%; height: auto;">
              <source src="${u(f.url)}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`;m&&m!==f.url?h=`<a href="${u(m)}" target="_blank" rel="noopener noreferrer" title="${u(g)}">${k}</a>`:h=k}else h='<p class="aipkit_video_results_message aipkit_message-error">Error: No video data found.</p>';else{let k=f.url||(f.b64_json?`data:image/png;base64,${f.b64_json}`:null);if(k){let y=`<img src="${u(k)}" alt="${u(p)}">`;m?h=`<a href="${u(m)}" target="_blank" rel="noopener noreferrer" title="${u(g)}">${y}</a>`:h=y}else h='<p class="aipkit_image_results_message aipkit_message-error">Error: No image data found.</p>'}if(w.innerHTML=h,f.revised_prompt){let k=document.createElement("p");k.style.fontSize="11px",k.style.fontStyle="italic",k.style.marginTop="5px",k.textContent=`Revised: ${f.revised_prompt}`,w.appendChild(k)}t.appendChild(w)});else{let f=l?"videos":"images";t.innerHTML=`<p class="aipkit_image_results_message aipkit_message-info">${d.initialPlaceholder||`No ${f} returned. Try a different prompt.`}</p>`}o.disabled=!1,a&&(a.textContent=s),r&&(r.style.display="none")}

================================================================================
FUNCION: c
Resumen: Función que maneja $human.
CODIGO:
function c(n){let e=n.currentTarget;if(e.disabled)return;let i=e.closest("#aipkit_public_image_generator");if(!i)return;let t=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,a=i.querySelector("#aipkit_image_generator_public_nonce")?.value,r=i.querySelector(".aipkit-image-history-grid");if(!t||!a||!r){console.error("Image History Load More: Missing required elements or config.");return}let s=parseInt(e.dataset.currentPage,10)||1,l=parseInt(e.dataset.maxPages,10)||1,p=s+1;if(p>l)return;let d=e.querySelector(".aipkit_btn-icon-content"),u=e.querySelector(".aipkit_spinner");d&&(d.style.display="none"),u&&(u.style.display="inline-block"),e.disabled=!0;let _=new FormData;_.append("action","aipkit_load_more_image_history"),_.append("_ajax_nonce",a),_.append("page",p),fetch(t,{method:"POST",body:_,credentials:"same-origin"}).then(f=>f.json()).then(f=>{if(!f.success)throw new Error(f.data?.message||"Failed to load more images.");f.data.html&&r.insertAdjacentHTML("beforeend",f.data.html),e.dataset.currentPage=p,f.data.has_more||(e.style.display="none")}).catch(f=>{console.error("Image History Load More Error:",f)}).finally(()=>{d&&(d.style.display="inline-block"),u&&(u.style.display="none"),p<l?e.disabled=!1:e.style.display="none"})}

================================================================================
FUNCION: c
Resumen: Función que maneja $human.
CODIGO:
function c(){let n=document.getElementById("aipkit_public_image_generator");if(!n)return;let e=n.querySelector("#aipkit_public_generate_image_btn"),i=n.querySelector("#aipkit_public_image_results"),o=n.querySelector("#aipkit_public_image_provider"),t=n.querySelector("#aipkit_public_image_model"),a=n.dataset.allowedModels||"",r=n.querySelector(".aipkit-image-history-grid"),s=n.querySelector(".aipkit-image-history-load-more-btn");if(!e||!i){console.error("AIPKit Image Generator (Public): Could not find essential UI elements (button, results)."),i&&(i.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Core UI elements missing.</p>'),i.style.display="grid";return}o&&t&&typeof window.aipkit_populatePublicModelsForProvider=="function"&&(window.aipkit_populatePublicModelsForProvider(o.value,t,a),o.addEventListener("change",()=>{window.aipkit_populatePublicModelsForProvider(o.value,t,a)})),e.dataset.listenerAttached!=="true"&&(e.addEventListener("click",window.aipkit_handlePublicImageGeneration),e.dataset.listenerAttached="true"),r&&r.addEventListener("click",window.aipkit_handleDeleteImage),s&&s.addEventListener("click",window.aipkit_handleLoadMoreHistory),i&&(i.style.display="none",i.innerHTML="")}

================================================================================
FUNCION: c
Resumen: Función que maneja $human.
CODIGO:
function c(i,o,t,a){let r=window.aipkit_token_usage_config||{},s=r.text||{},l=document.createElement("div");l.className="aipkit-usage-details-table-container";let p=document.createElement("div");p.className="aipkit-usage-details-pagination-container",a.appendChild(l),a.appendChild(p),l.innerHTML=`<p style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;width:20px;height:20px;"></span> ${s.loadingDetails||"Loading details..."}</p>`;let d={action:"aipkit_get_token_usage_details",nonce:r.nonce,module:i,context_id:o,page:t},u=new FormData;for(let _ in d)u.append(_,d[_]);fetch(r.ajaxUrl,{method:"POST",body:u,credentials:"same-origin"}).then(_=>_.json()).then(_=>{if(!_.success)throw new Error(_.data?.message||"Failed to load data.");n(_.data.items,l),e(_.data.pagination,p,i,o,a)}).catch(_=>{console.error("Error fetching token usage details:",_),l.innerHTML=`<p style="color:red;text-align:center;">${s.errorLoading||"Error loading details."} (${_.message})</p>`})}

================================================================================
FUNCION: n
Resumen: Función que maneja $human.
CODIGO:
function n(i,o){if(!i||i.length===0){o.innerHTML='<p style="text-align:center;">No detailed usage records found for this period.</p>';return}let t='<table class="aipkit_usage_details_table"><thead><tr><th>Date & Time</th><th>Tokens Used</th></tr></thead><tbody>';i.forEach(a=>{let s=new Date(a.timestamp*1e3).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"});t+=`<tr><td>${s}</td><td>${a.tokens.toLocaleString()}</td></tr>`}),t+="</tbody></table>",o.innerHTML=t}

================================================================================
FUNCION: e
Resumen: Función que maneja $human.
CODIGO:
function e(i,o,t,a,r){let{currentPage:s,totalPages:l}=i,p=window.aipkit_token_usage_config?.text||{};if(o.innerHTML="",l<=1)return;let d=document.createElement("button");d.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",d.textContent=p.previous||"Previous",d.disabled=s<=1,d.addEventListener("click",()=>c(t,a,s-1,r)),o.appendChild(d);let u=document.createElement("span");u.className="aipkit_pagination-current",u.textContent=`${p.pageLabel||"Page"} ${s} ${p.ofLabel||"of"} ${l}`,o.appendChild(u);let _=document.createElement("button");_.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",_.textContent=p.next||"Next",_.disabled=s>=l,_.addEventListener("click",()=>c(t,a,s+1,r)),o.appendChild(_)}

================================================================================
FUNCION: c
Resumen: Función que maneja $human.
CODIGO:
function c(e){e.preventDefault();let i=e.target,o=i.querySelector(".aipkit_semantic_search_input"),t=i.querySelector(".aipkit_semantic_search_button"),a=i.closest(".aipkit_semantic_search_wrapper"),r=a.querySelector(".aipkit_semantic_search_results");if(!o||!t||!a||!r){console.error("Semantic Search: Missing required form elements.");return}let s=o.value.trim();if(!s)return;let l=window.aipkit_semantic_search_config||{},p=l.text||{};t.disabled=!0;let d=t.querySelector(".aipkit_spinner");d&&(d.style.display="inline-block"),r.innerHTML='<div class="aipkit-search-loading"><span class="aipkit_spinner"></span></div>';let u={query:s};window.aipkit_frontendApiRequest("aipkit_perform_semantic_search",u,l).then(_=>{r.innerHTML=_.html||`<p>${l.settings.no_results_text||"No results found."}</p>`}).catch(_=>{console.error("Semantic Search Error:",_),r.innerHTML=`<p class="aipkit-search-error">${p.error||"An error occurred while searching."}</p>`}).finally(()=>{t.disabled=!1,d&&(d.style.display="none")})}

================================================================================
FUNCION: n
Resumen: Función que maneja $human.
CODIGO:
function n(){document.querySelectorAll(".aipkit_semantic_search_form").forEach(i=>{i.dataset.listenerAttached!=="true"&&(i.addEventListener("submit",c),i.dataset.listenerAttached="true")})}

================================================================================
FUNCION: c
Resumen: Función que maneja $human.
CODIGO:
function c(n,e,i){if(!n)return console.error("AIPKit ShowConsentBox: mainChatEl not found."),null;let o=n.querySelector(".aipkit_consent_overlay");if(!o){o=document.createElement("div"),o.className="aipkit_consent_overlay",o.innerHTML=`
                <h5 class="aipkit_consent_title">${e.text.consentTitle||"Consent Required"}</h5>
                <p class="aipkit_consent_message">${e.text.consentMessage||"Please agree to continue."}</p>
                <button type="button" class="aipkit_btn aipkit_btn-primary aipkit_consent_agree_btn">
                    ${e.text.consentButton||"I Agree"}
                </button>
            `;let t=n.querySelector(".aipkit_chat_input");t?t.appendChild(o):n.appendChild(o);let a=o.querySelector(".aipkit_consent_agree_btn");a&&typeof i=="function"&&a.addEventListener("click",i)}return o.classList.remove("aipkit_hidden"),o}

================================================================================
FUNCION: c
Resumen: Función que maneja $human.
CODIGO:
function c(n){n&&n.classList.add("aipkit_hidden")}

================================================================================
FUNCION: c
Resumen: Función que maneja $human.
CODIGO:
function c(n,e,i,o,t,a){n.consentGiven=!0,localStorage.setItem(e,"true"),typeof t=="function"&&a&&t(a);let r=o.closest("[data-bot-id]")?.dataset.botId||"unknown";typeof i=="function"&&i();let s=o.closest(".aipkit_chat_container");s&&s.dispatchEvent(new CustomEvent("aipkit:consentGiven"))}

================================================================================
FUNCION: c
Resumen: Función que maneja $human.
CODIGO:
function c(n,e,i,o){let t=e.botId,a=`aipkit_chatbot_consent_given_${t}`;i.consentGiven=localStorage.getItem(a)==="true";let r=null;function s(){typeof window.aipkit_chatUI_handleConsentAgree=="function"?window.aipkit_chatUI_handleConsentAgree(i,a,o,n,p,r):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_handleConsentAgree helper function not found.`)}function l(){typeof window.aipkit_chatUI_showConsentBox=="function"?r=window.aipkit_chatUI_showConsentBox(n,e,s):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_showConsentBox helper function not found.`)}function p(){r&&typeof window.aipkit_chatUI_hideConsentBox=="function"?window.aipkit_chatUI_hideConsentBox(r):r&&console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_hideConsentBox helper function not found.`)}return e.requireConsentCompliance&&!i.consentGiven&&l(),{showConsentBoxIfNeeded:()=>e.requireConsentCompliance&&!i.consentGiven?(l(),!0):!1,isConsentGiven:()=>i.consentGiven}}

================================================================================
FUNCION: s
Resumen: Función que maneja $human.
CODIGO:
function s(){typeof window.aipkit_chatUI_handleConsentAgree=="function"?window.aipkit_chatUI_handleConsentAgree(i,a,o,n,p,r):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_handleConsentAgree helper function not found.`)}

================================================================================
FUNCION: l
Resumen: Función que maneja $human.
CODIGO:
function l(){typeof window.aipkit_chatUI_showConsentBox=="function"?r=window.aipkit_chatUI_showConsentBox(n,e,s):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_showConsentBox helper function not found.`)}

================================================================================
FUNCION: p
Resumen: Función que maneja $human.
CODIGO:
function p(){r&&typeof window.aipkit_chatUI_hideConsentBox=="function"?window.aipkit_chatUI_hideConsentBox(r):r&&console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_hideConsentBox helper function not found.`)}

================================================================================
FUNCION: c
Resumen: Función que maneja $human.
CODIGO:
            `;let t=n.querySelector(".aipkit_chat_input");t?t.appendChild(o):n.appendChild(o);let a=o.querySelector(".aipkit_consent_agree_btn");a&&typeof i=="function"&&a.addEventListener("click",i)}return o.classList.remove("aipkit_hidden"),o}window.aipkit_chatUI_showConsentBox=c})();(function(){"use strict";function c(n){n&&n.classList.add("aipkit_hidden")}window.aipkit_chatUI_hideConsentBox=c})();(function(){"use strict";function c(n,e,i,o,t,a){n.consentGiven=!0,localStorage.setItem(e,"true"),typeof t=="function"&&a&&t(a);let r=o.closest("[data-bot-id]")?.dataset.botId||"unknown";typeof i=="function"&&i();let s=o.closest(".aipkit_chat_container");s&&s.dispatchEvent(new CustomEvent("aipkit:consentGiven"))}window.aipkit_chatUI_handleConsentAgree=c})();(function(){"use strict";function c(n,e,i,o){let t=e.botId,a=`aipkit_chatbot_consent_given_${t}`;i.consentGiven=localStorage.getItem(a)==="true";let r=null;function s(){typeof window.aipkit_chatUI_handleConsentAgree=="function"?window.aipkit_chatUI_handleConsentAgree(i,a,o,n,p,r):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_handleConsentAgree helper function not found.`)}function l(){typeof window.aipkit_chatUI_showConsentBox=="function"?r=window.aipkit_chatUI_showConsentBox(n,e,s):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_showConsentBox helper function not found.`)}function p(){r&&typeof window.aipkit_chatUI_hideConsentBox=="function"?window.aipkit_chatUI_hideConsentBox(r):r&&console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_hideConsentBox helper function not found.`)}return e.requireConsentCompliance&&!i.consentGiven&&l(),{showConsentBoxIfNeeded:()=>e.requireConsentCompliance&&!i.consentGiven?(l(),!0):!1,isConsentGiven:()=>i.consentGiven}}window.aipkit_initConsentUI=c})();(function(){"use strict";function c(n,e){let{messagesEl:i}=n;if(!i||!e||!e.text){console.error("AIPKit Download PDF: Missing messages element or config.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download PDF: One or more helper functions (extractText, generateFilename, triggerBlobDownload) not found."),alert("Error: Could not prepare PDF download.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AIPKit Download PDF: jsPDF library is not loaded."),alert(e.text.pdfError||"Could not generate PDF. jsPDF library might be missing.");return}let{jsPDF:o}=window.jspdf,t=new o,a=i.querySelectorAll(".aipkit_chat_message"),r=e?.headerName||"Bot",s=e.text.userPrefix||"User",l=e.text.errorPrefix||"Error",p=10,d=t.internal.pageSize.height,u=10,_=6,f=d-u*2,w=!1;if(t.setFontSize(16),t.text(`Chat Transcript - ${r}`,u,p),p+=_*2,t.setFontSize(12),a.forEach(m=>{let g=m.querySelector(".aipkit_chat_bubble");if(!g)return;let k=window.aipkit_chatUI_extractTextFromBubble(g),y=

