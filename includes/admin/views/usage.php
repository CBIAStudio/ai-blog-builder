<?php
if (!defined('ABSPATH')) exit;

if (!function_exists('cbia_render_view_usage')) {
    function cbia_render_view_usage() {/** * Usage overview (token usage from _cbia_usage_rows). */// Date range.$days = isset($_GET['usage_days']) ? absint(wp_unslash((string) $_GET['usage_days'])) : 7;$allowed_days = array(7, 30, 90);if (!in_array($days, $allowed_days, true)) {    $days = 7;}$model_filter = isset($_GET['usage_model']) ? sanitize_text_field(wp_unslash((string) $_GET['usage_model'])) : '';$since_ts = time() - ($days * DAY_IN_SECONDS);$since_date = gmdate('Y-m-d', $since_ts);// Collect usage rows.$summary = array(    'calls' => 0,    'fails' => 0,    'tokens_in' => 0,    'tokens_out' => 0,    'images' => 0,    'text' => 0,    'seo' => 0,);$by_model = array();$available_models = array();$by_user = array(); // user_id => ['name','calls','tokens_in','tokens_out']$daily = array(); // date => ['in'=>, 'out'=>, 'calls'=>]$posts_with_usage = 0;$query = new WP_Query(array(    'post_type'      => 'post',    'post_status'    => array('publish', 'future', 'draft', 'pending'),    'posts_per_page' => 200,    'fields'         => 'ids',    'no_found_rows'  => true,    'date_query'     => array(        array(            'after'     => $since_date,            'inclusive' => true,            'column'    => 'post_date',        ),    ),));$ids = !empty($query->posts) ? $query->posts : array();foreach ($ids as $post_id) {    if (!function_exists('cbia_costes_get_usage_rows_for_post')) break;    $rows = cbia_costes_get_usage_rows_for_post((int) $post_id);    if (empty($rows) || !is_array($rows)) continue;    $has_usage = false;    foreach ($rows as $r) {        if (!is_array($r)) continue;        $ts = isset($r['ts']) ? strtotime((string) $r['ts']) : 0;        if ($ts && $ts < $since_ts) continue;        $has_usage = true;        $summary['calls']++;        $ok = !empty($r['ok']);        if (!$ok) $summary['fails']++;        $type = isset($r['type']) ? strtolower(trim((string) $r['type'])) : 'text';        if ($type !== 'image' && $type !== 'seo') $type = 'text';        if ($type === 'image') $summary['images']++;        if ($type === 'text') $summary['text']++;        if ($type === 'seo')  $summary['seo']++;        $summary['tokens_in']  += (int) ($r['in'] ?? 0);        $summary['tokens_out'] += (int) ($r['out'] ?? 0);        $day = $ts ? gmdate('Y-m-d', $ts) : null;        if ($day) {            if (!isset($daily[$day])) {                $daily[$day] = array('in' => 0, 'out' => 0, 'calls' => 0);            }            $daily[$day]['in'] += (int) ($r['in'] ?? 0);            $daily[$day]['out'] += (int) ($r['out'] ?? 0);            $daily[$day]['calls']++;        }        $model = (string) ($r['model'] ?? '');        if ($model === '') $model = 'unknown';        $available_models[$model] = true;        if ($model_filter !== '' && $model_filter !== $model) {            continue;        }        if (!isset($by_model[$model])) {            $by_model[$model] = array('calls' => 0, 'tokens_in' => 0, 'tokens_out' => 0);        }        $by_model[$model]['calls']++;        $by_model[$model]['tokens_in']  += (int) ($r['in'] ?? 0);        $by_model[$model]['tokens_out'] += (int) ($r['out'] ?? 0);        $author_id = (int) get_post_field('post_author', $post_id);        if (!isset($by_user[$author_id])) {            $u = get_user_by('id', $author_id);            $by_user[$author_id] = array(                'name' => $u ? $u->display_name : ('User #' . $author_id),                'calls' => 0,                'tokens_in' => 0,                'tokens_out' => 0,            );        }        $by_user[$author_id]['calls']++;        $by_user[$author_id]['tokens_in']  += (int) ($r['in'] ?? 0);        $by_user[$author_id]['tokens_out'] += (int) ($r['out'] ?? 0);    }    if ($has_usage) $posts_with_usage++;}// Sort models by calls desc.uasort($by_model, function ($a, $b) {    return (int) ($b['calls'] ?? 0) <=> (int) ($a['calls'] ?? 0);});// Sort users by calls desc.uasort($by_user, function ($a, $b) {    return (int) ($b['calls'] ?? 0) <=> (int) ($a['calls'] ?? 0);});// Sort daily ascending by date.ksort($daily);$max_daily_total = 0;foreach ($daily as $row) {    $total = (int) ($row['in'] + $row['out']);    if ($total > $max_daily_total) $max_daily_total = $total;}$export_url = wp_nonce_url(    admin_url('admin-post.php?action=cbia_usage_export&usage_days=' . (int) $days . '&usage_model=' . rawurlencode((string) $model_filter)),    'cbia_usage_export');// Provider & model (UI only for now).$provider_settings = function_exists('cbia_providers_get_settings') ? cbia_providers_get_settings() : array();$providers_all = function_exists('cbia_providers_get_all') ? cbia_providers_get_all() : array();$provider_key = function_exists('cbia_providers_get_current_provider') ? cbia_providers_get_current_provider($provider_settings) : 'openai';$provider = $providers_all[$provider_key] ?? ($providers_all['openai'] ?? array('label' => 'OpenAI', 'models' => array('gpt-4.1-mini')));$provider_label = (string)($provider['label'] ?? $provider_key);$provider_logo = plugins_url('assets/images/providers/' . $provider_key . '.svg', CBIA_PLUGIN_FILE);$provider_cfg = function_exists('cbia_providers_get_provider') ? cbia_providers_get_provider($provider_settings, $provider_key) : array();$current_model = (string) ($provider_cfg['model'] ?? ($provider['models'][0] ?? 'gpt-4.1-mini'));$sync_meta_all = function_exists('cbia_providers_get_model_sync_meta') ? cbia_providers_get_model_sync_meta() : array();$sync_meta = $sync_meta_all[$provider_key] ?? array();?>
<div>    <h2>Usage</h2>    <p class="description">Resumen de uso real (tokens) registrado por llamada en <code>_cbia_usage_rows</code>.</p>    <div class="cbia-usage-top">        <div class="cbia-usage-card">            <h3 style="margin:0 0 10px 0;">Provider &amp; Model</h3>            <div class="cbia-provider-row">                <div style="min-width:120px;">                    <div class="description" style="margin-bottom:6px;">Proveedor</div>                    <div style="display:flex;align-items:center;gap:8px;">                        <img src="<?php echo esc_url($provider_logo); ?>" alt="<?php echo esc_attr($provider_label); ?>" style="width:20px;height:20px;" />                        <strong><?php echo esc_html($provider_label); ?></strong>                    </div>                </div>                <div style="flex:1;">                    <div class="description" style="margin-bottom:6px;">Modelo</div>                    <select class="abb-select" style="width:220px;">                        <option><?php echo esc_html($current_model); ?></option>                    </select>                    <button id="cbia-sync-models-btn" class="button" style="margin-left:8px;" data-provider="<?php echo esc_attr($provider_key); ?>">Sync Models</button><span id="cbia-sync-models-status" style="margin-left:10px;font-size:12px;color:#666;">Ultima sync: <?php echo esc_html(!empty($sync_meta["ts"]) ? $sync_meta["ts"] : "n/a"); ?></span>                </div>                <div>                    <button class="button button-secondary" disabled title="No disponible: falta backend avanzado">Advanced</button>                </div>            </div>            <div style="margin-top:10px;">                <span class="description">Providers disponibles:</span>                <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">                    <?php                    $provider_icons = !empty($providers_all) ? array_keys($providers_all) : array('openai');                    foreach ($provider_icons as $p) {                        $icon = plugins_url('assets/images/providers/' . $p . '.svg', CBIA_PLUGIN_FILE);                        echo '<span class="cbia-provider-pill"><img src="' . esc_url($icon) . '" alt="' . esc_attr($p) . '" style="width:14px;height:14px;" /> ' . esc_html($p) . '</span>';                    }                    ?>                </div>            </div>            <p class="description" style="margin-top:8px;">Selector multi-proveedor se habilita en una fase posterior.</p>        </div>        <div class="cbia-usage-card">            <h3 style="margin:0 0 10px 0;">Usage Overview</h3>            <div class="description">Estadisticas de tokens en los ultimos <?php echo esc_html((int) $days); ?> dias.</div>            <div style="height:140px;border:1px dashed #d7dce1;border-radius:8px;margin-top:12px;display:flex;align-items:center;justify-content:center;color:#b14;">                <?php echo empty($daily) ? 'No token usage data found for the selected period.' : 'Ver grafico abajo'; ?>            </div>        </div>    </div>    <form method="get" action="">        <input type="hidden" name="page" value="cbia" />        <input type="hidden" name="tab" value="usage" />        <label for="usage_days"><strong>Periodo:</strong></label>        <select id="usage_days" name="usage_days" class="abb-select">            <?php foreach ($allowed_days as $d): ?>                <option value="<?php echo esc_attr($d); ?>" <?php selected($days, $d); ?>>Ultimos <?php echo esc_html($d); ?> dias</option>            <?php endforeach; ?>        </select>        <label for="usage_model" style="margin-left:10px;"><strong>Modelo:</strong></label>        <select id="usage_model" name="usage_model" class="abb-select">            <option value="" <?php selected($model_filter, ''); ?>>Todos</option>            <?php foreach (array_keys($available_models) as $m): ?>                <option value="<?php echo esc_attr($m); ?>" <?php selected($model_filter, $m); ?>><?php echo esc_html($m); ?></option>            <?php endforeach; ?>        </select>        <button class="button">Actualizar</button>    </form>    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">        <div class="description">Periodo seleccionado: <strong><?php echo esc_html($days); ?> dias</strong></div>        <a class="button" href="<?php echo esc_url($export_url); ?>">Exportar CSV</a>    </div>    <div class="cbia-usage-grid">        <div class="cbia-usage-card">            <h4>Posts con uso</h4>            <div class="cbia-usage-value"><?php echo esc_html((int) $posts_with_usage); ?></div>        </div>        <div class="cbia-usage-card">            <h4>Llamadas totales</h4>            <div class="cbia-usage-value"><?php echo esc_html((int) $summary['calls']); ?></div>        </div>        <div class="cbia-usage-card">            <h4>Tokens entrada</h4>            <div class="cbia-usage-value"><?php echo esc_html((int) $summary['tokens_in']); ?></div>        </div>        <div class="cbia-usage-card">            <h4>Tokens salida</h4>            <div class="cbia-usage-value"><?php echo esc_html((int) $summary['tokens_out']); ?></div>        </div>        <div class="cbia-usage-card">            <h4>Imagenes</h4>            <div class="cbia-usage-value"><?php echo esc_html((int) $summary['images']); ?></div>        </div>        <div class="cbia-usage-card">            <h4>Errores</h4>            <div class="cbia-usage-value"><?php echo esc_html((int) $summary['fails']); ?></div>        </div>    </div>    <h3>Uso diario (tokens)</h3>    <?php if (empty($daily)): ?>        <p>No hay datos diarios en el periodo seleccionado.</p>    <?php else: ?>
<div class="cbia-usage-card" style="padding:12px;">            <canvas id="cbia-usage-chart" height="180"></canvas>            <div style="font-size:12px;color:#666;margin-top:6px;">                <span style="display:inline-block;width:10px;height:10px;background:#2271b1;border-radius:2px;margin-right:6px;"></span>Entrada                <span style="display:inline-block;width:10px;height:10px;background:#00a32a;border-radius:2px;margin:0 6px 0 14px;"></span>Salida            </div>        </div>        <script>        (function(){            const data = <?php echo wp_json_encode($daily); ?>;            const canvas = document.getElementById('cbia-usage-chart');            if (!canvas) return;            const ctx = canvas.getContext('2d');            const keys = Object.keys(data);            if (!keys.length) return;            const padding = 30;            const w = canvas.width = canvas.parentElement.clientWidth - 10;            const h = canvas.height = 180;            let max = 0;            keys.forEach(k => {                const total = (data[k].in || 0) + (data[k].out || 0);                if (total > max) max = total;            });            const barW = Math.max(6, Math.floor((w - padding * 2) / keys.length) - 4);            ctx.clearRect(0,0,w,h);            ctx.fillStyle = '#f0f0f1';            ctx.fillRect(0,0,w,h);            ctx.fillStyle = '#fff';            ctx.fillRect(padding, 10, w - padding*2, h - 40);            keys.forEach((k, i) => {                const baseX = padding + i * (barW + 4);                const inVal = data[k].in || 0;                const outVal = data[k].out || 0;                const total = inVal + outVal;                const scale = max > 0 ? (h - 60) / max : 1;                const inH = Math.max(1, Math.round(inVal * scale));                const outH = Math.max(1, Math.round(outVal * scale));                const yBase = h - 30;                ctx.fillStyle = '#2271b1';                ctx.fillRect(baseX, yBase - inH, barW, inH);                ctx.fillStyle = '#00a32a';                ctx.fillRect(baseX, yBase - inH - outH, barW, outH);            });        })();        </script>    <?php endif; ?>    <h3>Uso por modelo</h3>    <?php if (empty($by_model)): ?>        <p>No hay datos de uso en el periodo seleccionado.</p>    <?php else: ?>        <table class="widefat striped cbia-usage-table" style="max-width:980px;">            <thead>                <tr>                    <th>Modelo</th>                    <th>Llamadas</th>                    <th>Tokens entrada</th>                    <th>Tokens salida</th>                </tr>            </thead>            <tbody>                <?php foreach ($by_model as $model => $row): ?>                    <tr>                        <td><code><?php echo esc_html($model); ?></code></td>                        <td><?php echo esc_html((int) $row['calls']); ?></td>                        <td><?php echo esc_html((int) $row['tokens_in']); ?></td>                        <td><?php echo esc_html((int) $row['tokens_out']); ?></td>                    </tr>                <?php endforeach; ?>            </tbody>        </table>    <?php endif; ?>    <h3>Uso por usuario (autor)</h3>    <?php if (empty($by_user)): ?>        <p>No hay datos por usuario en el periodo seleccionado.</p>    <?php else: ?>        <table class="widefat striped cbia-usage-table" style="max-width:980px;">            <thead>                <tr>                    <th>Usuario</th>                    <th>Llamadas</th>                    <th>Tokens entrada</th>                    <th>Tokens salida</th>                </tr>            </thead>            <tbody>                <?php foreach ($by_user as $uid => $row): ?>                    <tr>                        <td><?php echo esc_html($row['name']); ?></td>                        <td><?php echo esc_html((int) $row['calls']); ?></td>                        <td><?php echo esc_html((int) $row['tokens_in']); ?></td>                        <td><?php echo esc_html((int) $row['tokens_out']); ?></td>                    </tr>                <?php endforeach; ?>            </tbody>        </table>    <?php endif; ?></div>
<?php
    }
}

cbia_render_view_usage();


